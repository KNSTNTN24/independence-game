<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#d97706">
  <meta name="description" content="Independence - –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –∏–≥—Ä–∞ –æ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∏—Å—Ç–µ–º–∞—Ö">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Independence">
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/svg+xml" href="/icon-192.svg">
  <title>Independence - Civic Education Game</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Raleway:wght@300;400;600;700&display=swap');
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{margin:0;padding:0;font-family:'Raleway',sans-serif;background:#0f172a;overscroll-behavior:none}
    .safe-top{padding-top:env(safe-area-inset-top)}.safe-bottom{padding-bottom:env(safe-area-inset-bottom)}
    .font-display{font-family:'Cinzel',serif}
    .gold-gradient{background:linear-gradient(180deg,#fbbf24 0%,#d97706 50%,#92400e 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    input[type="range"]{-webkit-appearance:none;height:8px;border-radius:4px}
    input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:24px;height:24px;border-radius:50%;background:linear-gradient(180deg,#fbbf24,#d97706);cursor:pointer}
    input[type="text"],input[type="email"],input[type="password"]{-webkit-appearance:none;appearance:none;-webkit-user-select:text;user-select:text;pointer-events:auto}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
    @keyframes spin{to{transform:rotate(360deg)}}
    .animate-fadeIn{animation:fadeIn .3s ease-out}.animate-slideUp{animation:slideUp .4s ease-out}
    .animate-pulse{animation:pulse 2s infinite}.animate-spin{animation:spin 1s linear infinite}
    button{min-height:44px;cursor:pointer;transition:all .15s}button:active{transform:scale(.97)}
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:100;display:flex;align-items:center;justify-content:center;padding:1rem}
    .toast{position:fixed;top:1rem;left:50%;transform:translateX(-50%);z-index:200;max-width:90%}
    .star-bg{position:fixed;inset:0;overflow:hidden;pointer-events:none;z-index:0}
    .star{position:absolute;width:2px;height:2px;background:white;border-radius:50%;opacity:.5}
  </style>
</head>
<body class="safe-top safe-bottom">
  <div id="root"></div>
  <script type="text/babel">
    const{useState,useEffect,useCallback,createContext,useContext,useMemo}=React;

    // ===== CONFIG =====
    const SUPABASE_URL='https://dnkeinsedcrlhwbiycfo.supabase.co';
    const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRua2VpbnNlZGNybGh3Yml5Y2ZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NDg0MjgsImV4cCI6MjA4NDMyNDQyOH0.9IkWv6dwOemaVwvWrwq7ZzuebrgWI83JWrdaZbzdhhw';
    const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
    const STRIPE_KEY='pk_live_51SrFQOH02sKb65Xcey2pn7bvJhJQ1EqpjYyAoiVKK3OmGZjlKCMRmuX4t6zUitqQ2RHI7MIceHAkHYadAi4r31D900L7ki97pX';
    const CONTENT_CACHE_KEY='independence_content_v2';
    const CONTENT_CACHE_TTL=1000*60*30; // 30 min

    // ===== CONTENT LOADER =====
    const loadContentFromDB=async()=>{
      try{
        const[langs,texts,systems,planets,events,sectors,diffs]=await Promise.all([
          supabase.from('languages').select('*').eq('is_active',true).order('sort_order'),
          supabase.from('ui_texts').select('*'),
          supabase.from('political_systems').select('*').eq('is_active',true).order('sort_order'),
          supabase.from('planets').select('*').eq('is_active',true).order('sort_order'),
          supabase.from('events').select('*').eq('is_active',true).order('sort_order'),
          supabase.from('budget_sectors').select('*').eq('is_active',true).order('sort_order'),
          supabase.from('difficulties').select('*').eq('is_active',true).order('sort_order'),
        ]);
        
        if(langs.error||texts.error||systems.error||planets.error||events.error)throw new Error('DB query failed');
        
        const data={
          languages:langs.data||[],
          ui_texts:texts.data||[],
          systems:systems.data||[],
          planets:planets.data||[],
          events:events.data||[],
          sectors:sectors.data||[],
          difficulties:diffs.data||[]
        };
        
        localStorage.setItem(CONTENT_CACHE_KEY,JSON.stringify({data,timestamp:Date.now()}));
        console.log('‚úÖ Content loaded from DB');
        return data;
      }catch(e){
        console.error('‚ùå DB load failed:',e);
        return null;
      }
    };

    const loadContentFromCache=()=>{
      try{
        const cached=localStorage.getItem(CONTENT_CACHE_KEY);
        if(cached){
          const{data,timestamp}=JSON.parse(cached);
          if(Date.now()-timestamp<CONTENT_CACHE_TTL){
            console.log('‚úÖ Content loaded from cache');
            return data;
          }
        }
      }catch(e){}
      return null;
    };

    // Transform DB data to game format
    const transformContent=(data)=>{
      if(!data)return null;
      
      try{
        // UI Texts -> T object
        const T={ui:{},intro:{},systems:{},planets:{},sectors:{},defeat:{},victoryMsg:{}};
        (data.ui_texts||[]).forEach(t=>{
          const[category,...rest]=t.key.split('.');
          const key=rest.join('.');
          if(T[category]!==undefined){
            if(key)T[category][key]=t.value;
            else Object.assign(T[category],t.value);
          }
        });
        
        // Systems - add to T.systems for localization
        const SYSTEMS={};
        (data.systems||[]).forEach(s=>{
          SYSTEMS[s.id]={
            id:s.id,icon:s.icon,premium:s.is_premium||false,
            traits:s.traits||{},
            name:s.name,leader:s.leader,desc:s.description,pros:s.pros,cons:s.cons
          };
          // Also add to T for t() function
          T.systems[s.id]={name:s.name,leader:s.leader,desc:s.description,pros:s.pros,cons:s.cons};
        });
        
        // Planets - add to T.planets for localization
        const PLANETS={};
        (data.planets||[]).forEach(p=>{
          PLANETS[p.id]={
            id:p.id,icon:p.icon,difficulty:p.difficulty||2,
            stats:p.stats||{happiness:50,wealth:50,stability:50},
            mods:p.mods||{},
            name:p.name,desc:p.description,traits:p.traits,quote:p.quote
          };
          // Also add to T for t() function
          T.planets[p.id]={name:p.name,desc:p.description,traits:p.traits,quote:p.quote};
        });
        
        // Events
        const EVENTS={general:[],parliamentary:[],presidential:[],monarchy:[],dictatorship:[],technocracy:[],direct:[]};
        (data.events||[]).forEach(e=>{
          const event={
            id:e.id,icon:e.icon,title:e.title,desc:e.description,
            choices:(e.choices||[]).map(c=>({text:c.text,effects:c.effects||{},cost:c.cost||0,hydro:c.hydro||0}))
          };
          if(EVENTS[e.system])EVENTS[e.system].push(event);
          else EVENTS.general.push(event);
        });
        
        // Sectors - add to T.sectors
        const SECTORS=(data.sectors||[]).map(s=>{
          T.sectors[s.id]={name:s.name};
          return{id:s.id,icon:s.icon,name:s.name};
        });
        
        // Difficulties
        const DIFFICULTIES={};
        (data.difficulties||[]).forEach(d=>{
          DIFFICULTIES[d.id]={icon:d.icon,name:d.name,bonus:d.bonus||0,hydroBonus:d.hydro_bonus||0,severity:d.severity||1.0};
        });
        
        // Languages
        const LANGUAGES=(data.languages||[]).map(l=>({code:l.code,flag:l.flag,name:l.native_name||l.name}));
        
        console.log('‚úÖ Content transformed:',{T,SYSTEMS,PLANETS,EVENTS:Object.keys(EVENTS).map(k=>k+':'+EVENTS[k].length),SECTORS,DIFFICULTIES,LANGUAGES});
        return{T,SYSTEMS,PLANETS,EVENTS,SECTORS,DIFFICULTIES,LANGUAGES};
      }catch(e){
        console.error('‚ùå Transform error:',e);
        return null;
      }
    };

    // ===== FALLBACK CONTENT (when DB unavailable) =====
    const FALLBACK_CONTENT={
      T:{
        ui:{title:{ru:'INDEPENDENCE',en:'INDEPENDENCE',de:'INDEPENDENCE'},subtitle:{ru:'–û–ë–†–ê–ó–û–í–ê–¢–ï–õ–¨–ù–ê–Ø –ò–ì–†–ê –û –ü–û–õ–ò–¢–ò–ö–ï',en:'CIVIC EDUCATION GAME',de:'POLITISCHES BILDUNGSSPIEL'},login:{ru:'–í–æ–π—Ç–∏',en:'Login',de:'Anmelden'},register:{ru:'–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è',en:'Register',de:'Registrieren'},premium:{ru:'Premium',en:'Premium',de:'Premium'},premiumPrice:{ru:'¬£2.99/–º–µ—Å',en:'¬£2.99/mo',de:'¬£2.99/Mo'},startGame:{ru:'–ù–∞—á–∞—Ç—å –∏–≥—Ä—É',en:'Start Game',de:'Spiel starten'},year:{ru:'–ì–æ–¥',en:'Year',de:'Jahr'},submit:{ru:'–£—Ç–≤–µ—Ä–¥–∏—Ç—å –±—é–¥–∂–µ—Ç',en:'Submit Budget',de:'Budget best√§tigen'},happiness:{ru:'–°—á–∞—Å—Ç—å–µ',en:'Happiness',de:'Zufriedenheit'},wealth:{ru:'–ë–æ–≥–∞—Ç—Å—Ç–≤–æ',en:'Wealth',de:'Wohlstand'},stability:{ru:'–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å',en:'Stability',de:'Stabilit√§t'},budget:{ru:'–ë—é–¥–∂–µ—Ç',en:'Budget',de:'Budget'},victory:{ru:'–ü–û–ë–ï–î–ê!',en:'VICTORY!',de:'SIEG!'},defeat:{ru:'–ü–û–†–ê–ñ–ï–ù–ò–ï',en:'DEFEAT',de:'NIEDERLAGE'},playAgain:{ru:'–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞',en:'Play Again',de:'Nochmal spielen'},back:{ru:'–ù–∞–∑–∞–¥',en:'Back',de:'Zur√ºck'},next:{ru:'–î–∞–ª–µ–µ',en:'Next',de:'Weiter'},close:{ru:'–ó–∞–∫—Ä—ã—Ç—å',en:'Close',de:'Schlie√üen'},easy:{ru:'–õ–µ–≥–∫–æ',en:'Easy',de:'Leicht'},normal:{ru:'–ù–æ—Ä–º–∞–ª—å–Ω–æ',en:'Normal',de:'Normal'},hard:{ru:'–°–ª–æ–∂–Ω–æ',en:'Hard',de:'Schwer'},years:{ru:'–ª–µ—Ç',en:'years',de:'Jahre'},choosePlanet:{ru:'–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞–Ω–µ—Ç—É',en:'Choose Planet',de:'Planet w√§hlen'},score:{ru:'–û—á–∫–∏',en:'Score',de:'Punkte'},signOut:{ru:'–í—ã–π—Ç–∏',en:'Sign Out',de:'Abmelden'},email:{ru:'Email',en:'Email',de:'E-Mail'},password:{ru:'–ü–∞—Ä–æ–ª—å',en:'Password',de:'Passwort'},username:{ru:'–ò–º—è',en:'Username',de:'Name'},loading:{ru:'–ó–∞–≥—Ä—É–∑–∫–∞...',en:'Loading...',de:'L√§dt...'},selectLanguage:{ru:'–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫',en:'Select Language',de:'Sprache w√§hlen'},advancedSettings:{ru:'–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏',en:'Advanced Settings',de:'Erweiterte Einstellungen'},target:{ru:'–¶–µ–ª—å',en:'Target',de:'Ziel'},gameLength:{ru:'–î–ª–∏–Ω–∞ –∏–≥—Ä—ã',en:'Game length',de:'Spiell√§nge'},eventsPerTurn:{ru:'–°–æ–±—ã—Ç–∏–π –∑–∞ —Ö–æ–¥',en:'Events per turn',de:'Ereignisse pro Zug'},difficulty:{ru:'–°–ª–æ–∂–Ω–æ—Å—Ç—å',en:'Difficulty',de:'Schwierigkeit'},politicalSystem:{ru:'–ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞',en:'Political System',de:'Politisches System'},profile:{ru:'–ü—Ä–æ—Ñ–∏–ª—å',en:'Profile',de:'Profil'},skip:{ru:'–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å',en:'Skip',de:'√úberspringen'},remaining:{ru:'–û—Å—Ç–∞—Ç–æ–∫',en:'Remaining',de:'Verbleibend'}},
        intro:{title:{ru:'–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º, —É–≤–∞–∂–∞–µ–º—ã–π –û—Å–Ω–æ–≤–∞—Ç–µ–ª—å!',en:'Congratulations, esteemed Founder!',de:'Herzlichen Gl√ºckwunsch!'},p1:{ru:'–í–∞—à –∫–æ—Ä–∞–±–ª—å –ø—Ä–∏–∑–µ–º–ª–∏–ª—Å—è –Ω–∞ –ø–ª–∞–Ω–µ—Ç–µ.',en:'Your ship has landed on a planet.',de:'Ihr Schiff ist gelandet.'},p2:{ru:'–ü–æ—Å—Ç—Ä–æ–π—Ç–µ –∏–¥–µ–∞–ª—å–Ω–æ–µ –æ–±—â–µ—Å—Ç–≤–æ.',en:'Build a perfect society.',de:'Bauen Sie eine perfekte Gesellschaft.'},p3:{ru:'–ò–ª–∏ –Ω–µ –æ—á–µ–Ω—å –∏–¥–µ–∞–ª—å–Ω–æ–µ.',en:'Or not so perfect.',de:'Oder nicht so perfekt.'},mission:{ru:'–í–∞—à–∞ –∑–∞–¥–∞—á–∞: —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ü–≤–µ—Ç–∞—é—â—É—é —Ü–∏–≤–∏–ª–∏–∑–∞—Ü–∏—é.',en:'Your mission: create a thriving civilization.',de:'Ihre Mission: eine bl√ºhende Zivilisation.'}},
        systems:{parliamentary:{name:{ru:'–ü–∞—Ä–ª–∞–º–µ–Ω—Ç—Å–∫–∞—è –¥–µ–º–æ–∫—Ä–∞—Ç–∏—è',en:'Parliamentary Democracy',de:'Parlamentarische Demokratie'},leader:{ru:'–ü—Ä–µ–º—å–µ—Ä-–º–∏–Ω–∏—Å—Ç—Ä',en:'Prime Minister',de:'Premierminister'},desc:{ru:'–î–µ–º–æ–∫—Ä–∞—Ç–∏—è —Å –ø–∞—Ä–ª–∞–º–µ–Ω—Ç–æ–º.',en:'Democracy with parliament.',de:'Demokratie mit Parlament.'},pros:{ru:'–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å',en:'Stability',de:'Stabilit√§t'},cons:{ru:'–ú–µ–¥–ª–µ–Ω–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è',en:'Slow decisions',de:'Langsame Entscheidungen'}},presidential:{name:{ru:'–ü—Ä–µ–∑–∏–¥–µ–Ω—Ç—Å–∫–∞—è —Ä–µ—Å–ø—É–±–ª–∏–∫–∞',en:'Presidential Republic',de:'Pr√§sidialrepublik'},leader:{ru:'–ü—Ä–µ–∑–∏–¥–µ–Ω—Ç',en:'President',de:'Pr√§sident'},desc:{ru:'–û–¥–∏–Ω –ª–∏–¥–µ—Ä, –º–Ω–æ–≥–æ –≤–ª–∞—Å—Ç–∏.',en:'One leader, much power.',de:'Ein F√ºhrer, viel Macht.'},pros:{ru:'–ë—ã—Å—Ç—Ä—ã–µ —Ä–µ—à–µ–Ω–∏—è',en:'Fast decisions',de:'Schnelle Entscheidungen'},cons:{ru:'–í—Å—ë –Ω–∞ –≤–∞—Å',en:'All on you',de:'Alles auf Ihnen'}},monarchy:{name:{ru:'–ú–æ–Ω–∞—Ä—Ö–∏—è',en:'Monarchy',de:'Monarchie'},leader:{ru:'–ú–æ–Ω–∞—Ä—Ö',en:'Monarch',de:'Monarch'},desc:{ru:'–¢—Ä–∞–¥–∏—Ü–∏–∏ –∏ –∫–æ—Ä–æ–Ω–∞.',en:'Traditions and crown.',de:'Traditionen und Krone.'},pros:{ru:'+10 —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å',en:'+10 stability',de:'+10 Stabilit√§t'},cons:{ru:'–†–∏—Å–∫ –≤–æ—Å—Å—Ç–∞–Ω–∏—è',en:'Rebellion risk',de:'Aufstandsrisiko'}},dictatorship:{name:{ru:'–î–∏–∫—Ç–∞—Ç—É—Ä–∞',en:'Dictatorship',de:'Diktatur'},leader:{ru:'–í–µ—Ä—Ö–æ–≤–Ω—ã–π –ª–∏–¥–µ—Ä',en:'Supreme Leader',de:'Oberster F√ºhrer'},desc:{ru:'–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø—Ä–µ–≤—ã—à–µ –≤—Å–µ–≥–æ.',en:'Efficiency above all.',de:'Effizienz √ºber alles.'},pros:{ru:'–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å',en:'Maximum efficiency',de:'Maximale Effizienz'},cons:{ru:'–†–∏—Å–∫ –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç–∞',en:'Coup risk',de:'Putschrisiko'}},technocracy:{name:{ru:'–¢–µ—Ö–Ω–æ–∫—Ä–∞—Ç–∏—è',en:'Technocracy',de:'Technokratie'},leader:{ru:'–ì–ª–∞–≤–Ω—ã–π —Ç–µ—Ö–Ω–æ–ª–æ–≥',en:'Chief Technologist',de:'Cheftechnologe'},desc:{ru:'–≠–∫—Å–ø–µ—Ä—Ç—ã —É –≤–ª–∞—Å—Ç–∏.',en:'Experts in power.',de:'Experten an der Macht.'},pros:{ru:'+15 –±–æ–≥–∞—Ç—Å—Ç–≤–æ',en:'+15 wealth',de:'+15 Wohlstand'},cons:{ru:'–õ—é–¥–∏ –∫–∞–∫ –¥–∞–Ω–Ω—ã–µ',en:'People as data',de:'Menschen als Daten'}},direct:{name:{ru:'–ü—Ä—è–º–∞—è –¥–µ–º–æ–∫—Ä–∞—Ç–∏—è',en:'Direct Democracy',de:'Direkte Demokratie'},leader:{ru:'–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä',en:'Coordinator',de:'Koordinator'},desc:{ru:'–ö–∞–∂–¥—ã–π –≥–æ–ª–æ—Å –≤–∞–∂–µ–Ω.',en:'Every voice matters.',de:'Jede Stimme z√§hlt.'},pros:{ru:'–õ–µ–≥–∏—Ç–∏–º–Ω–æ—Å—Ç—å',en:'Legitimacy',de:'Legitimit√§t'},cons:{ru:'–û—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ',en:'Very slow',de:'Sehr langsam'}}},
        planets:{terranova:{name:{ru:'–¢–µ—Ä—Ä–∞ –ù–æ–≤–∞',en:'Terra Nova',de:'Terra Nova'},desc:{ru:'–ü–ª–∞–Ω–µ—Ç–∞-–±–ª–∏–∑–Ω–µ—Ü –ó–µ–º–ª–∏.',en:'Earth twin planet.',de:'Erd√§hnlicher Planet.'},traits:{ru:'–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è',en:'Balanced',de:'Ausgewogen'},quote:{ru:'¬´–ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å¬ª',en:'"Predictability"',de:'‚ÄûVorhersehbarkeit"'}},aridia:{name:{ru:'–ê—Ä–∏–¥–∏—è',en:'Aridia',de:'Aridia'},desc:{ru:'–ü—É—Å—Ç—ã–Ω–Ω—ã–π –º–∏—Ä.',en:'Desert world.',de:'W√ºstenwelt.'},traits:{ru:'–ü—É—Å—Ç—ã–Ω—è',en:'Desert',de:'W√ºste'},quote:{ru:'¬´–ñ–∞—Ä–∫–æ¬ª',en:'"Hot"',de:'‚ÄûHei√ü"'}},edemia:{name:{ru:'–≠–¥–µ–º–∏—è',en:'Edemia',de:'Edemia'},desc:{ru:'–†–∞–π.',en:'Paradise.',de:'Paradies.'},traits:{ru:'–ë–æ–≥–∞—Ç–∞—è',en:'Rich',de:'Reich'},quote:{ru:'¬´–†–∞–π¬ª',en:'"Paradise"',de:'‚ÄûParadies"'}},chaosprime:{name:{ru:'–•–∞–æ—Å –ü—Ä–∞–π–º',en:'Chaos Prime',de:'Chaos Prime'},desc:{ru:'–•–∞–æ—Å.',en:'Chaos.',de:'Chaos.'},traits:{ru:'–•–∞–æ—Å',en:'Chaos',de:'Chaos'},quote:{ru:'¬´–•–∞–æ—Å¬ª',en:'"Chaos"',de:'‚ÄûChaos"'}},polaris:{name:{ru:'–ü–æ–ª—è—Ä–∏—Å',en:'Polaris',de:'Polaris'},desc:{ru:'–•–æ–ª–æ–¥–Ω—ã–π –º–∏—Ä.',en:'Cold world.',de:'Kalte Welt.'},traits:{ru:'–•–æ–ª–æ–¥',en:'Cold',de:'Kalt'},quote:{ru:'¬´–•–æ–ª–æ–¥–Ω–æ¬ª',en:'"Cold"',de:'‚ÄûKalt"'}}},
        sectors:{defence:{name:{ru:'–û–±–æ—Ä–æ–Ω–∞',en:'Defence',de:'Verteidigung'}},education:{name:{ru:'–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ',en:'Education',de:'Bildung'}},health:{name:{ru:'–ó–¥—Ä–∞–≤–æ–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ',en:'Healthcare',de:'Gesundheit'}},infra:{name:{ru:'–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞',en:'Infrastructure',de:'Infrastruktur'}},welfare:{name:{ru:'–°–æ—Ü–∑–∞—â–∏—Ç–∞',en:'Welfare',de:'Soziales'}}},
        defeat:{happiness:{ru:'–ù–∞—Ä–æ–¥ –≤–æ—Å—Å—Ç–∞–ª!',en:'People revolted!',de:'Volk rebelliert!'},stability:{ru:'–•–∞–æ—Å!',en:'Chaos!',de:'Chaos!'},rebellion:{ru:'–ú—è—Ç–µ–∂!',en:'Rebellion!',de:'Aufstand!'},coup:{ru:'–ü–µ—Ä–µ–≤–æ—Ä–æ—Ç!',en:'Coup!',de:'Putsch!'},targets:{ru:'–¶–µ–ª–∏ –Ω–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã!',en:'Targets not met!',de:'Ziele nicht erreicht!'}},
        victoryMsg:{utopia:{ru:'–£—Ç–æ–ø–∏—è!',en:'Utopia!',de:'Utopie!'},prosperity:{ru:'–ü—Ä–æ—Ü–≤–µ—Ç–∞–Ω–∏–µ!',en:'Prosperity!',de:'Wohlstand!'},survival:{ru:'–í—ã –≤—ã–∂–∏–ª–∏!',en:'You survived!',de:'Sie haben √ºberlebt!'}}
      },
      SYSTEMS:{parliamentary:{id:'parliamentary',icon:'üèõÔ∏è',premium:false,traits:{needsApproval:true,threshold:40,stabilityBonus:0,happinessDecay:0,wealthBonus:0}},presidential:{id:'presidential',icon:'ü¶Ö',premium:false,traits:{needsApproval:false,stabilityBonus:0,happinessDecay:0,wealthBonus:5}},monarchy:{id:'monarchy',icon:'üëë',premium:true,traits:{needsApproval:false,stabilityBonus:10,happinessDecay:0,wealthBonus:0,rebellionRisk:25}},dictatorship:{id:'dictatorship',icon:'‚öîÔ∏è',premium:true,traits:{needsApproval:false,stabilityBonus:5,happinessDecay:5,wealthBonus:0,coupRisk:30}},technocracy:{id:'technocracy',icon:'üî¨',premium:true,traits:{needsApproval:false,stabilityBonus:5,happinessDecay:2,wealthBonus:15,startPenalty:10}},direct:{id:'direct',icon:'üó≥Ô∏è',premium:true,traits:{needsApproval:false,stabilityBonus:-5,happinessDecay:-3,wealthBonus:0,referendumChance:0.25}}},
      PLANETS:{terranova:{id:'terranova',icon:'üåç',difficulty:2,stats:{happiness:60,wealth:50,stability:70},mods:{eventMult:1.0,extraEvents:0}},aridia:{id:'aridia',icon:'üèúÔ∏è',difficulty:4,stats:{happiness:45,wealth:35,stability:60},mods:{eventMult:1.2,happinessDecay:2}},edemia:{id:'edemia',icon:'üå¥',difficulty:2,stats:{happiness:75,wealth:70,stability:55},mods:{eventMult:1.0,stabilityDecay:2}},chaosprime:{id:'chaosprime',icon:'üåã',difficulty:3,stats:{happiness:50,wealth:55,stability:40},mods:{eventMult:1.5,extraEvents:1,stabilityDecay:3}},polaris:{id:'polaris',icon:'‚ùÑÔ∏è',difficulty:4,stats:{happiness:40,wealth:45,stability:80},mods:{eventMult:0.8,happinessDecay:3}}},
      EVENTS:{general:[{id:'pandemic',icon:'ü¶†',title:{ru:'–≠–ø–∏–¥–µ–º–∏—è',en:'Pandemic',de:'Pandemie'},desc:{ru:'–í–∏—Ä—É—Å —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è.',en:'Virus spreading.',de:'Virus breitet sich aus.'},choices:[{text:{ru:'–ö–∞—Ä–∞–Ω—Ç–∏–Ω',en:'Quarantine',de:'Quarant√§ne'},effects:{happiness:-20,stability:10},cost:30},{text:{ru:'–ù–∏—á–µ–≥–æ',en:'Nothing',de:'Nichts'},effects:{stability:-20},cost:0}]}],parliamentary:[],presidential:[],monarchy:[],dictatorship:[],technocracy:[],direct:[]},
      SECTORS:[{id:'defence',icon:'üõ°Ô∏è'},{id:'education',icon:'üìö'},{id:'health',icon:'üè•'},{id:'infra',icon:'üèóÔ∏è'},{id:'welfare',icon:'ü§ù'}],
      DIFFICULTIES:{easy:{icon:'üòä',bonus:10,hydroBonus:30,severity:0.7},normal:{icon:'üòê',bonus:0,hydroBonus:0,severity:1.0},hard:{icon:'üò∞',bonus:-10,hydroBonus:-20,severity:1.3}},
      LANGUAGES:[{code:'ru',flag:'üá∑üá∫',name:'–†—É—Å—Å–∫–∏–π'},{code:'en',flag:'üá¨üáß',name:'English'},{code:'de',flag:'üá©üá™',name:'Deutsch'}]
    };

    // ===== CONTENT CONTEXT =====
    const ContentContext=createContext(null);
    const useGameContent=()=>useContext(ContentContext);

    function ContentProvider({children}){
      const[content,setContent]=useState(FALLBACK_CONTENT); // Start with fallback!
      const[loading,setLoading]=useState(true);

      useEffect(()=>{
        const load=async()=>{
          // Try cache first for fast load
          try{
            const cached=loadContentFromCache();
            if(cached){
              const transformed=transformContent(cached);
              if(transformed&&Object.keys(transformed.SYSTEMS||{}).length>0){
                console.log('üì¶ Using cached content');
                setContent(transformed);
              }
            }
          }catch(e){console.warn('Cache error:',e);}
          
          // Load fresh from DB
          try{
            const fresh=await loadContentFromDB();
            if(fresh){
              const transformed=transformContent(fresh);
              if(transformed&&Object.keys(transformed.SYSTEMS||{}).length>0){
                console.log('üåê Using DB content');
                setContent(transformed);
              }
            }
          }catch(e){console.warn('DB error:',e);}
          
          setLoading(false);
        };
        load();
      },[]);

      // Always have content (either loaded or fallback)
      return(<ContentContext.Provider value={content}>{children}</ContentContext.Provider>);
    }


    // ===== DB HELPERS =====
    const db={
      async saveGameResult(userId,data){
        // Save game result
        const result=await supabase.from('game_results').insert({
          user_id:userId,
          planet_name:data.planet,
          political_system:data.system,
          difficulty:data.difficulty,
          max_turns:data.maxTurns,
          final_turn:data.turn,
          final_happiness:Math.round(data.stats.happiness),
          final_wealth:Math.round(data.stats.wealth),
          final_stability:Math.round(data.stats.stability),
          final_hydrobite:data.hydrobite||0,
          is_victory:data.isVictory,
          victory_type:data.victoryType||null,
          score:data.score||0,
          duration_seconds:data.duration||0
        });
        
        // Update profile stats
        const{data:profile}=await supabase.from('profiles').select('total_games,total_wins,highest_score').eq('id',userId).single();
        if(profile){
          const updates={
            total_games:(profile.total_games||0)+1,
            total_wins:(profile.total_wins||0)+(data.isVictory?1:0),
            highest_score:Math.max(profile.highest_score||0,data.score||0)
          };
          await supabase.from('profiles').update(updates).eq('id',userId);
        }
        return result;
      },
      async getLeaderboard(limit=30){return await supabase.from('profiles').select('id,username,display_name,total_games,total_wins,highest_score').gt('total_games',0).order('highest_score',{ascending:false}).limit(limit);},
      async getUserAchievements(userId){return await supabase.from('user_achievements').select('*,achievements(*)').eq('user_id',userId);},
      async unlockAchievement(userId,achievementId){return await supabase.from('user_achievements').upsert({user_id:userId,achievement_id:achievementId},{onConflict:'user_id,achievement_id'});},
    };

    // ===== AUTH CONTEXT =====
    const AuthContext=createContext(null);
    const useAuth=()=>useContext(AuthContext);

    function AuthProvider({children}){
      const[user,setUser]=useState(null);
      const[profile,setProfile]=useState(null);
      const[loading,setLoading]=useState(true);
      const[initialized,setInitialized]=useState(false);

      const loadProfile=useCallback(async(userId)=>{
        try{const{data}=await supabase.from('profiles').select('*').eq('id',userId).single();if(data)setProfile(data);}catch(e){console.warn('Profile load error:',e);}
      },[]);

      useEffect(()=>{
        let mounted=true;
        const timeout=setTimeout(()=>{if(mounted&&!initialized){console.warn('Auth timeout, proceeding without auth');setLoading(false);setInitialized(true);}},3000);
        
        supabase.auth.getSession().then(({data:{session}})=>{
          if(!mounted)return;
          const u=session?.user??null;setUser(u);if(u)loadProfile(u.id);setLoading(false);setInitialized(true);
        }).catch(e=>{
          console.warn('Auth error:',e);
          if(mounted){setLoading(false);setInitialized(true);}
        });
        
        const{data:{subscription}}=supabase.auth.onAuthStateChange(async(event,session)=>{
          if(!mounted)return;
          const u=session?.user??null;setUser(u);if(u)await loadProfile(u.id);else setProfile(null);setLoading(false);
        });
        
        return()=>{mounted=false;clearTimeout(timeout);subscription.unsubscribe();};
      },[loadProfile]);

      const signUp=async(email,password,username)=>{const{data,error}=await supabase.auth.signUp({email,password,options:{data:{username,full_name:username}}});if(error)throw error;return data;};
      const signIn=async(email,password)=>{const{data,error}=await supabase.auth.signInWithPassword({email,password});if(error)throw error;return data;};
      const signOut=async()=>{await supabase.auth.signOut();setUser(null);setProfile(null);};
      const refreshProfile=async()=>{if(user)await loadProfile(user.id);};

      return(<AuthContext.Provider value={{user,profile,loading,initialized,signUp,signIn,signOut,refreshProfile}}>{children}</AuthContext.Provider>);
    }

    // ===== LANG CONTEXT =====
    const LangContext=createContext({lang:'ru',setLang:()=>{},t:(k)=>k});
    const useLang=()=>useContext(LangContext);

    function LangProvider({children}){
      const[lang,setLang]=useState(()=>localStorage.getItem('lang')||'');
      const content=useGameContent();
      const T=content?.T||FALLBACK_CONTENT.T;
      const t=useCallback((path)=>{
        const keys=path.split('.');let val=T;
        for(const k of keys){val=val?.[k];if(!val)return path;}
        return val[lang]||val.ru||val.en||path;
      },[lang,T]);
      const changeLang=(l)=>{setLang(l);localStorage.setItem('lang',l);};
      return(<LangContext.Provider value={{lang,setLang:changeLang,t}}>{children}</LangContext.Provider>);
    }

    // ===== UI COMPONENTS =====
    const Spinner=({size='md'})=>{const s={sm:'w-5 h-5',md:'w-8 h-8',lg:'w-12 h-12'};return(<div className="flex justify-center py-4"><div className={`${s[size]} border-4 border-amber-500 border-t-transparent rounded-full animate-spin`}/></div>);};
    const Toast=({message,type='info',onClose})=>{useEffect(()=>{const t=setTimeout(onClose,3000);return()=>clearTimeout(t);},[onClose]);const colors={success:'bg-green-900/90 border-green-500 text-green-200',error:'bg-red-900/90 border-red-500 text-red-200',warning:'bg-yellow-900/90 border-yellow-500 text-yellow-200',info:'bg-blue-900/90 border-blue-500 text-blue-200'};return(<div className={`toast ${colors[type]} border px-4 py-3 rounded-lg shadow-lg animate-slideUp`}>{message}</div>);};
    const Modal=({children,onClose,title})=>(<div className="modal-overlay animate-fadeIn" onClick={onClose}><div className="bg-slate-800 rounded-xl max-w-md w-full max-h-[85vh] overflow-hidden border border-amber-500/30 animate-slideUp" onClick={e=>e.stopPropagation()}>{title&&(<div className="flex justify-between items-center p-4 border-b border-slate-700"><h2 className="text-lg font-display font-bold text-amber-400">{title}</h2><button onClick={onClose} className="text-gray-400 hover:text-white text-2xl">&times;</button></div>)}<div className="p-4 overflow-y-auto max-h-[calc(85vh-60px)]">{children}</div></div></div>);
    const StatBar=({label,value,icon,color})=>(<div className="mb-2"><div className="flex justify-between text-xs mb-1"><span className="text-amber-100/80">{icon} {label}</span><span className={`font-bold ${value<30?'text-red-400':value>70?'text-green-400':'text-amber-300'}`}>{Math.round(value)}%</span></div><div className="h-2 bg-slate-900 rounded overflow-hidden border border-amber-900/30"><div className={`h-full ${color} transition-all duration-500`} style={{width:`${Math.min(100,Math.max(0,value))}%`}}/></div></div>);
    const StarBackground=()=>{const stars=useMemo(()=>Array.from({length:50},(_,i)=>({id:i,left:Math.random()*100,top:Math.random()*100,size:Math.random()*2+1,delay:Math.random()*3})),[]);return(<div className="star-bg">{stars.map(s=>(<div key={s.id} className="star animate-pulse" style={{left:`${s.left}%`,top:`${s.top}%`,width:s.size,height:s.size,animationDelay:`${s.delay}s`}}/>))}</div>);};
    
    // ===== ADMIN INLINE EDITOR =====
    function AdminEventEditor({event,onClose,onSave}){
      const[data,setData]=useState(JSON.parse(JSON.stringify(event)));
      const[saving,setSaving]=useState(false);
      const langs=['ru','en','de'];
      
      const updateField=(field,lang,value)=>{
        setData(d=>{
          const newData={...d};
          if(lang){
            if(!newData[field])newData[field]={};
            newData[field]={...newData[field],[lang]:value};
          }else{
            newData[field]=value;
          }
          return newData;
        });
      };
      
      const updateChoice=(idx,field,lang,value)=>{
        setData(d=>{
          const newData={...d,choices:[...d.choices]};
          const choice={...newData.choices[idx]};
          if(field==='text'){
            choice.text={...choice.text,[lang]:value};
          }else if(field.startsWith('effects.')){
            const key=field.split('.')[1];
            choice.effects={...choice.effects,[key]:parseInt(value)||0};
          }else{
            choice[field]=parseInt(value)||0;
          }
          newData.choices[idx]=choice;
          return newData;
        });
      };
      
      const handleSave=async()=>{
        setSaving(true);
        try{
          const{error}=await supabase.from('events').update({
            title:data.title,
            description:data.description,
            choices:data.choices
          }).eq('id',data.id);
          if(error)throw error;
          localStorage.removeItem(CONTENT_CACHE_KEY);
          onSave();
          onClose();
        }catch(e){
          alert('–û—à–∏–±–∫–∞: '+e.message);
        }
        setSaving(false);
      };
      
      return(<div className="modal-overlay animate-fadeIn" onClick={onClose}>
        <div className="bg-slate-800 rounded-xl max-w-lg w-full max-h-[90vh] overflow-hidden border border-amber-500/30 mx-4" onClick={e=>e.stopPropagation()}>
          <div className="flex justify-between items-center p-4 border-b border-slate-700">
            <h2 className="text-lg font-bold text-amber-400">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</h2>
            <button onClick={onClose} className="text-gray-400 hover:text-white text-2xl">&times;</button>
          </div>
          <div className="p-4 overflow-y-auto max-h-[calc(90vh-140px)] space-y-4">
            <div className="text-xs text-gray-500">ID: {data.id}</div>
            
            <div>
              <label className="text-sm text-gray-400 block mb-1">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
              {langs.map(l=>(<div key={l} className="flex gap-2 mb-1">
                <span className="text-xs bg-slate-600 px-2 py-1 rounded">{l.toUpperCase()}</span>
                <input value={data.title?.[l]||''} onChange={e=>updateField('title',l,e.target.value)}
                  className="flex-1 px-2 py-1 bg-slate-700 border border-slate-600 rounded text-sm focus:border-amber-500 focus:outline-none"/>
              </div>))}
            </div>
            
            <div>
              <label className="text-sm text-gray-400 block mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</label>
              {langs.map(l=>(<div key={l} className="flex gap-2 mb-1">
                <span className="text-xs bg-slate-600 px-2 py-1 rounded">{l.toUpperCase()}</span>
                <textarea value={data.description?.[l]||''} onChange={e=>updateField('description',l,e.target.value)} rows={2}
                  className="flex-1 px-2 py-1 bg-slate-700 border border-slate-600 rounded text-sm focus:border-amber-500 focus:outline-none"/>
              </div>))}
            </div>
            
            <div>
              <label className="text-sm text-gray-400 block mb-2">–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤</label>
              {data.choices?.map((choice,i)=>(<div key={i} className="bg-slate-700/50 rounded-lg p-3 mb-2 border border-slate-600">
                <div className="text-xs text-amber-300 mb-2">–í–∞—Ä–∏–∞–Ω—Ç {i+1}</div>
                {langs.map(l=>(<div key={l} className="flex gap-2 mb-1">
                  <span className="text-xs bg-slate-600 px-1 rounded">{l}</span>
                  <input value={choice.text?.[l]||''} onChange={e=>updateChoice(i,'text',l,e.target.value)}
                    className="flex-1 px-2 py-1 bg-slate-600 border border-slate-500 rounded text-xs focus:border-amber-500 focus:outline-none"/>
                </div>))}
                <div className="grid grid-cols-5 gap-1 mt-2 text-xs">
                  <div><span className="text-gray-400">üòä</span><input type="number" value={choice.effects?.happiness||0} onChange={e=>updateChoice(i,'effects.happiness',null,e.target.value)} className="w-full px-1 py-0.5 bg-slate-600 rounded"/></div>
                  <div><span className="text-gray-400">üí∞</span><input type="number" value={choice.effects?.wealth||0} onChange={e=>updateChoice(i,'effects.wealth',null,e.target.value)} className="w-full px-1 py-0.5 bg-slate-600 rounded"/></div>
                  <div><span className="text-gray-400">‚öñÔ∏è</span><input type="number" value={choice.effects?.stability||0} onChange={e=>updateChoice(i,'effects.stability',null,e.target.value)} className="w-full px-1 py-0.5 bg-slate-600 rounded"/></div>
                  <div><span className="text-gray-400">üíé</span><input type="number" value={choice.cost||0} onChange={e=>updateChoice(i,'cost',null,e.target.value)} className="w-full px-1 py-0.5 bg-slate-600 rounded"/></div>
                  <div><span className="text-gray-400">ü™ô</span><input type="number" value={choice.hydro||0} onChange={e=>updateChoice(i,'hydro',null,e.target.value)} className="w-full px-1 py-0.5 bg-slate-600 rounded"/></div>
                </div>
              </div>))}
            </div>
          </div>
          <div className="p-4 border-t border-slate-700 flex gap-2">
            <button onClick={onClose} className="flex-1 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg">–û—Ç–º–µ–Ω–∞</button>
            <button onClick={handleSave} disabled={saving} className="flex-1 py-2 bg-amber-600 hover:bg-amber-500 rounded-lg font-bold disabled:opacity-50">
              {saving?'–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...':'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å'}
            </button>
          </div>
        </div>
      </div>);
    }

    // ===== AUTH MODAL =====
    const AuthModal=({onClose,initialMode='login'})=>{
      const{signUp,signIn}=useAuth();const{t}=useLang();
      const[mode,setMode]=useState(initialMode);const[email,setEmail]=useState('');const[password,setPassword]=useState('');const[username,setUsername]=useState('');const[loading,setLoading]=useState(false);const[error,setError]=useState('');const[success,setSuccess]=useState('');
      const handleSubmit=async(e)=>{e.preventDefault();setLoading(true);setError('');setSuccess('');try{if(mode==='register'){await signUp(email,password,username);setSuccess('Check email!');}else{await signIn(email,password);onClose();}}catch(err){setError(err.message);}setLoading(false);};
      return(<Modal onClose={onClose} title={mode==='login'?t('ui.login'):t('ui.register')}><form onSubmit={handleSubmit} autoComplete="off" className="space-y-4">{mode==='register'&&(<input type="text" id="auth-username" name="username" placeholder={t('ui.username')} value={username} onChange={e=>setUsername(e.target.value)} autoComplete="off" className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-amber-500" required/>)}<input type="email" id="auth-email" name="email" placeholder={t('ui.email')} value={email} onChange={e=>setEmail(e.target.value)} autoComplete="off" className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-amber-500" required/><input type="password" id="auth-password" name="password" placeholder={t('ui.password')} value={password} onChange={e=>setPassword(e.target.value)} autoComplete="new-password" className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-amber-500" required minLength={6}/>{error&&<p className="text-red-400 text-sm">{error}</p>}{success&&<p className="text-green-400 text-sm">{success}</p>}<button type="submit" disabled={loading} className="w-full py-3 bg-gradient-to-r from-amber-500 to-yellow-500 text-slate-900 rounded-lg font-bold disabled:opacity-50">{loading?'...':mode==='login'?t('ui.login'):t('ui.register')}</button><p className="text-center text-sm text-gray-400">{mode==='login'?<span>No account? <button type="button" onClick={()=>setMode('register')} className="text-amber-400">Register</button></span>:<span>Have account? <button type="button" onClick={()=>setMode('login')} className="text-amber-400">Login</button></span>}</p></form></Modal>);
    };

    // ===== PROFILE MODAL =====
    const ProfileModal=({onClose})=>{
      const{profile,signOut}=useAuth();const{t}=useLang();
      return(<Modal onClose={onClose} title={t('ui.profile')||'Profile'}><div className="text-center mb-4"><div className="w-16 h-16 bg-amber-600 rounded-full flex items-center justify-center text-2xl font-bold mx-auto mb-2">{profile?.display_name?.[0]?.toUpperCase()||'üë§'}</div><h3 className="font-bold text-lg text-amber-300">{profile?.display_name||'Player'}</h3>{profile?.is_premium&&<span className="text-amber-400 text-sm">‚≠ê Premium</span>}</div><div className="space-y-2 text-sm mb-4"><div className="flex justify-between"><span className="text-gray-400">Games:</span><span className="text-amber-300">{profile?.total_games||0}</span></div><div className="flex justify-between"><span className="text-gray-400">Wins:</span><span className="text-amber-300">{profile?.total_wins||0}</span></div><div className="flex justify-between"><span className="text-gray-400">Best:</span><span className="text-amber-300">{profile?.highest_score||0}</span></div></div><div className="flex gap-2"><button onClick={onClose} className="flex-1 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg">{t('ui.close')}</button><button onClick={()=>{signOut();onClose();}} className="flex-1 py-2 bg-red-900/50 hover:bg-red-800/50 text-red-300 rounded-lg">{t('ui.signOut')}</button></div></Modal>);
    };

    // ===== LEADERBOARD MODAL =====
    const LeaderboardModal=({onClose})=>{
      const[leaders,setLeaders]=useState([]);const[loading,setLoading]=useState(true);
      useEffect(()=>{db.getLeaderboard(20).then(({data})=>{setLeaders(data||[]);setLoading(false);});},[]);
      return(<Modal onClose={onClose} title="üèÜ Leaderboard">{loading?<Spinner/>:(<div className="space-y-2">{leaders.length===0?<p className="text-center text-gray-400 py-8">No results</p>:leaders.map((p,i)=>(<div key={p.id} className={`flex items-center gap-3 p-3 rounded-lg ${i<3?'bg-gradient-to-r from-amber-900/40 to-transparent':'bg-slate-700/30'}`}><span className="text-xl font-bold w-8 text-center">{i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':`${i+1}`}</span><div className="flex-1"><p className="font-bold text-amber-100 truncate">{p.display_name||p.username||'Player'}</p><p className="text-xs text-gray-400">{p.total_wins}/{p.total_games}</p></div><p className="text-lg font-bold text-amber-400">{p.highest_score}</p></div>))}</div>)}</Modal>);
    };

    // ===== PREMIUM MODAL =====
    const PremiumModal=({onClose})=>{
      const{user}=useAuth();const{t}=useLang();const[loading,setLoading]=useState(false);const[promo,setPromo]=useState('');const[error,setError]=useState('');
      const handlePurchase=async()=>{if(!user){setError('Login first');return;}setLoading(true);setError('');try{const res=await fetch('/.netlify/functions/create-checkout',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:user.id,userEmail:user.email,promo:promo.trim()||undefined})});const data=await res.json();if(data.error)setError(data.error);else if(data.url)window.location.href=data.url;}catch(e){setError('Error');}setLoading(false);};
      const features=['üèõÔ∏è 6 political systems','üèÜ All achievements','üìä Extended stats','üö´ No ads','üíæ Cloud saves'];
      return(<Modal onClose={onClose} title="‚≠ê Premium"><div className="text-center mb-4"><div className="text-4xl font-bold text-amber-400 mb-1">{t('ui.premiumPrice')}</div></div><div className="bg-slate-700/30 rounded-lg p-4 mb-4 space-y-2">{features.map((f,i)=>(<div key={i} className="text-gray-300">{f}</div>))}</div><input type="text" placeholder="Promo code" value={promo} onChange={e=>setPromo(e.target.value)} className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white mb-4"/>{error&&<p className="text-red-400 text-sm mb-2">{error}</p>}<button onClick={handlePurchase} disabled={loading} className="w-full py-3 bg-gradient-to-r from-amber-500 to-yellow-500 text-slate-900 rounded-lg font-bold disabled:opacity-50">{loading?'...':'Subscribe'}</button></Modal>);
    };

    // ===== MAIN GAME =====
    function Game(){
      const{user,profile,loading:authLoading,initialized,refreshProfile}=useAuth();
      const{lang,setLang,t}=useLang();
      const content=useGameContent();
      const{T,SYSTEMS,PLANETS,EVENTS,SECTORS,DIFFICULTIES,LANGUAGES}=content||FALLBACK_CONTENT;

      const[phase,setPhase]=useState('lang');
      const[turn,setTurn]=useState(1);
      const[maxTurns,setMaxTurns]=useState(15);
      const[difficulty,setDifficulty]=useState('normal');
      const[stats,setStats]=useState({happiness:60,wealth:50,stability:70});
      const[hydrobite,setHydrobite]=useState(100);
      const[budget,setBudget]=useState({defence:20,education:20,health:20,infra:20,welfare:20});
      const[system,setSystem]=useState('parliamentary');
      const[planetId,setPlanetId]=useState('terranova');
      const[event,setEvent]=useState(null);
      const[eventQueue,setEventQueue]=useState([]);
      const[usedEvents,setUsedEvents]=useState([]);
      const[finalScore,setFinalScore]=useState(0);
      const[victoryType,setVictoryType]=useState(null);
      const[eventsPerTurn,setEventsPerTurn]=useState(1);
      const[targetHappiness,setTargetHappiness]=useState(70);
      const[targetWealth,setTargetWealth]=useState(70);
      const[targetStability,setTargetStability]=useState(70);
      const[showAdvanced,setShowAdvanced]=useState(false);

      const[showAuth,setShowAuth]=useState(false);
      const[showProfile,setShowProfile]=useState(false);
      const[showLeaderboard,setShowLeaderboard]=useState(false);
      const[showPremium,setShowPremium]=useState(false);
      const[toast,setToast]=useState(null);
      const[introStep,setIntroStep]=useState(0);
      const[editingEvent,setEditingEvent]=useState(null);

      const isAdmin=profile?.is_admin||false;

      const sys=SYSTEMS[system];
      const planet=PLANETS[planetId];
      const diff=DIFFICULTIES[difficulty];
      const totalBudget=Object.values(budget).reduce((a,b)=>a+b,0);
      const remaining=hydrobite-totalBudget;
      const isPremium=profile?.is_premium||false;

      useEffect(()=>{
        const params=new URLSearchParams(window.location.search);
        if(params.get('success')==='true'){window.history.replaceState({},'','/');setToast({message:'‚úÖ Payment successful!',type:'success'});setTimeout(()=>window.location.reload(),2000);}
        else if(params.get('canceled')==='true'){window.history.replaceState({},'','/');setToast({message:'Payment canceled',type:'warning'});}
      },[]);

      useEffect(()=>{if(lang)setPhase('title');},[lang]);

      const showToast=useCallback((message,type='info')=>setToast({message,type}),[]);

      const calculateScore=useCallback((s,t,isVictory)=>{
        let score=Math.floor((s.happiness+s.wealth+s.stability)/3);
        score+=t*2;if(isVictory)score+=20;
        if(difficulty==='hard')score+=15;if(difficulty==='easy')score-=10;
        return Math.max(0,score);
      },[difficulty]);

      const endGame=useCallback(async(isVictory,vType=null)=>{
        const score=calculateScore(stats,turn,isVictory);
        setFinalScore(score);setVictoryType(vType);
        setPhase(isVictory?'victory':'gameover'); // Set phase first!
        if(user){
          const planetName=T?.planets?.[planetId]?.name?.[lang]||planetId;
          const gameData={planet:planetName,system,difficulty,maxTurns,turn,stats,hydrobite:hydrobite||0,isVictory,victoryType:vType,score,duration:0};
          try{
            const result=await db.saveGameResult(user.id,gameData);
            if(result.error)console.error('DB save error:',result.error);
            if(refreshProfile)await refreshProfile();
          }catch(e){console.error('Save error:',e);}
        }
      },[user,planetId,system,difficulty,maxTurns,turn,stats,hydrobite,lang,calculateScore,refreshProfile,T]);

      const startGame=useCallback(()=>{
        if(!isPremium&&SYSTEMS[system].premium){showToast('üîí Premium required!','warning');return;}
        const d=DIFFICULTIES[difficulty];const p=PLANETS[planetId];const s=SYSTEMS[system];
        setStats({happiness:Math.max(10,Math.min(90,p.stats.happiness+d.bonus-(s.traits.startPenalty||0))),wealth:Math.max(10,Math.min(90,p.stats.wealth+d.bonus)),stability:Math.max(10,Math.min(90,p.stats.stability+d.bonus+s.traits.stabilityBonus))});
        setHydrobite(100+d.hydroBonus);setTurn(1);setBudget({defence:20,education:20,health:20,infra:20,welfare:20});setUsedEvents([]);setEventQueue([]);setPhase('playing');
      },[system,difficulty,planetId,isPremium,showToast]);

      const getRandomEvents=useCallback((count)=>{
        const general=[...EVENTS.general];const specific=EVENTS[system]||[];const all=[...general,...specific];
        let available=all.filter(e=>!usedEvents.includes(e.id));if(available.length<count){setUsedEvents([]);available=all;}
        const selected=[];for(let i=0;i<count&&available.length>0;i++){const idx=Math.floor(Math.random()*available.length);selected.push(available[idx]);available.splice(idx,1);}
        return selected;
      },[system,usedEvents]);

      const checkGameEnd=useCallback((newStats,newTurn)=>{
        // Immediate defeat conditions
        if(newStats.stability<=0){endGame(false,'stability');return true;}
        if(newStats.happiness<=0){endGame(false,'happiness');return true;}
        // Special system risks
        if(sys.traits.rebellionRisk&&newStats.happiness<sys.traits.rebellionRisk&&Math.random()<0.3){showToast(t('defeat.rebellion'),'error');setTimeout(()=>endGame(false,'rebellion'),1000);return true;}
        if(sys.traits.coupRisk&&newStats.stability<sys.traits.coupRisk&&Math.random()<0.3){showToast(t('defeat.coup'),'error');setTimeout(()=>endGame(false,'coup'),1000);return true;}
        // Early victory conditions
        if(newStats.happiness>=95&&newStats.wealth>=70&&newStats.stability>=70){endGame(true,'utopia');return true;}
        if(newStats.wealth>=95&&newStats.happiness>=70&&newStats.stability>=70){endGame(true,'prosperity');return true;}
        // End of game - check custom targets
        if(newTurn>maxTurns){
          const failed=[];
          if(newStats.happiness<targetHappiness)failed.push(`üòä${Math.round(newStats.happiness)}%<${targetHappiness}%`);
          if(newStats.wealth<targetWealth)failed.push(`üí∞${Math.round(newStats.wealth)}%<${targetWealth}%`);
          if(newStats.stability<targetStability)failed.push(`‚öñÔ∏è${Math.round(newStats.stability)}%<${targetStability}%`);
          if(failed.length===0){
            endGame(true,'survival');
          }else{
            showToast(`‚ùå ${failed.join(', ')}`,'error');
            setTimeout(()=>endGame(false,'targets'),500);
          }
          return true;
        }
        return false;
      },[sys,maxTurns,targetHappiness,targetWealth,targetStability,endGame,showToast,t]);

      const processTurn=useCallback(()=>{
        if(remaining<0){showToast('‚ùå Budget exceeded!','error');return;}
        if(sys.traits.needsApproval&&stats.happiness<sys.traits.threshold){if(Math.random()>0.4){showToast('üèõÔ∏è Parliament rejected!','warning');return;}}
        if(sys.traits.referendumChance&&Math.random()<sys.traits.referendumChance){showToast('üó≥Ô∏è Referendum!','info');}

        const d=DIFFICULTIES[difficulty];
        let changes={happiness:(budget.welfare*0.35)+(budget.health*0.25)+(budget.education*0.15)-12-sys.traits.happinessDecay-(planet.mods.happinessDecay||0),wealth:(budget.infra*0.4)+(budget.education*0.25)-10+sys.traits.wealthBonus,stability:(budget.defence*0.35)+(budget.infra*0.1)-5-(planet.mods.stabilityDecay||0)};
        Object.keys(changes).forEach(k=>{if(changes[k]<0)changes[k]*=d.severity;});
        const newStats={happiness:Math.max(0,Math.min(100,stats.happiness+changes.happiness)),wealth:Math.max(0,Math.min(100,stats.wealth+changes.wealth)),stability:Math.max(0,Math.min(100,stats.stability+changes.stability))};
        setStats(newStats);setHydrobite(Math.floor(80+newStats.wealth*0.3+d.hydroBonus*0.5));

        const eventCount=eventsPerTurn+(planet.mods.extraEvents||0);
        const events=getRandomEvents(eventCount);
        setUsedEvents(prev=>[...prev,...events.map(e=>e.id)]);
        setEventQueue(events);
        if(events.length>0){setEvent(events[0]);setEventQueue(events.slice(1));setPhase('event');}
        else{
          const newTurn=turn+1;
          if(!checkGameEnd(newStats,newTurn)){setTurn(newTurn);setPhase('playing');}
        }
      },[remaining,sys,stats,difficulty,budget,planet,eventsPerTurn,turn,getRandomEvents,checkGameEnd,showToast]);

      const handleChoice=useCallback((choice)=>{
        const d=DIFFICULTIES[difficulty];let newStats={...stats};
        Object.entries(choice.effects).forEach(([k,v])=>{if(newStats[k]!==undefined){const effectValue=v<0?v*d.severity:v;newStats[k]=Math.max(0,Math.min(100,newStats[k]+effectValue));}});
        let newHydro=hydrobite-choice.cost+(choice.hydro||0);setHydrobite(Math.max(0,newHydro));setStats(newStats);

        if(eventQueue.length>0){setEvent(eventQueue[0]);setEventQueue(q=>q.slice(1));}
        else{
          const newTurn=turn+1;
          if(!checkGameEnd(newStats,newTurn)){setTurn(newTurn);setEvent(null);setPhase('playing');}
        }
      },[difficulty,stats,hydrobite,turn,eventQueue,checkGameEnd]);

      const handleBudget=useCallback((sector,val)=>{setBudget(prev=>({...prev,[sector]:Math.max(0,Math.min(50,parseInt(val)||0))}));},[]);

      // ===== RENDERS =====
      if(!initialized||authLoading){return(<div className="min-h-screen bg-slate-950 flex items-center justify-center"><Spinner size="lg"/></div>);}

      // LANG SELECT
      if(phase==='lang'){
        return(<div className="min-h-screen bg-slate-950 text-white flex items-center justify-center p-4"><StarBackground/><div className="text-center relative z-10 animate-fadeIn"><h1 className="text-4xl font-display font-bold gold-gradient mb-8">INDEPENDENCE</h1><p className="text-gray-400 mb-6">Select Language</p><div className="space-y-3">{LANGUAGES.map(l=>(<button key={l.code} onClick={()=>{setLang(l.code);setPhase('intro');}} className="w-full max-w-xs mx-auto flex items-center justify-center gap-3 py-4 bg-slate-800/50 border border-amber-500/30 rounded-xl hover:bg-slate-700/50 text-lg"><span className="text-2xl">{l.flag}</span><span>{l.name}</span></button>))}</div><button onClick={()=>{localStorage.clear();sessionStorage.clear();location.reload();}} className="mt-8 text-gray-600 hover:text-gray-400 text-xs">üîÑ Reset</button></div></div>);
      }

      // INTRO
      if(phase==='intro'){
        const steps=[{title:t('intro.title'),text:t('intro.p1')},{text:t('intro.p2')},{text:t('intro.p3')},{text:t('intro.mission'),isLast:true}];
        const step=steps[introStep];
        return(<div className="min-h-screen bg-slate-950 text-white p-6 flex items-center justify-center"><StarBackground/><div className="max-w-lg mx-auto text-center relative z-10 animate-fadeIn"><div className="bg-slate-800/50 border border-amber-500/30 rounded-2xl p-8">{step.title&&<h2 className="text-2xl font-display text-amber-400 mb-6">{step.title}</h2>}<p className="text-lg text-gray-300 leading-relaxed mb-8">{step.text}</p><div className="flex gap-4">{introStep>0&&<button onClick={()=>setIntroStep(s=>s-1)} className="flex-1 py-3 bg-slate-700 hover:bg-slate-600 rounded-lg">{t('ui.back')}</button>}<button onClick={()=>{if(step.isLast)setPhase('title');else setIntroStep(s=>s+1);}} className="flex-1 py-3 bg-gradient-to-r from-amber-500 to-yellow-500 text-slate-900 rounded-lg font-bold">{step.isLast?t('ui.startGame'):t('ui.next')}</button></div><div className="flex justify-center gap-2 mt-6">{steps.map((_,i)=>(<div key={i} className={`w-2 h-2 rounded-full ${i===introStep?'bg-amber-500':'bg-slate-600'}`}/>))}</div></div><button onClick={()=>setPhase('title')} className="mt-4 text-gray-500 hover:text-gray-400 text-sm">{t('ui.skip')}</button></div></div>);
      }

      // TITLE
      if(phase==='title'){
        return(<div className="min-h-screen bg-slate-950 text-white p-4 relative"><StarBackground/><div className="max-w-md mx-auto pt-4 relative z-10">
          <div className="flex justify-between items-center mb-4"><div className="flex gap-2"><button onClick={()=>setShowLeaderboard(true)} className="p-2 bg-slate-800/50 rounded-lg hover:bg-slate-700">üèÜ</button>{isAdmin&&<a href="admin.html" className="p-2 bg-slate-800/50 rounded-lg hover:bg-slate-700" title="Admin Panel">‚öôÔ∏è</a>}{!isPremium&&<button onClick={()=>setShowPremium(true)} className="px-3 py-2 bg-gradient-to-r from-amber-500 to-yellow-500 text-slate-900 rounded-lg text-sm font-bold">‚≠ê Premium</button>}</div>{user?<button onClick={()=>setShowProfile(true)} className="flex items-center gap-2 px-3 py-2 bg-slate-800/50 rounded-full hover:bg-slate-700"><div className="w-6 h-6 bg-amber-600 rounded-full flex items-center justify-center text-xs font-bold">{profile?.display_name?.[0]?.toUpperCase()||'üë§'}</div><span className="text-sm text-amber-300">{profile?.display_name||'Profile'}</span>{profile?.is_premium&&<span className="text-amber-400">‚≠ê</span>}</button>:<button onClick={()=>setShowAuth(true)} className="px-4 py-2 bg-amber-600 hover:bg-amber-500 rounded-full text-sm font-bold">{t('ui.login')}</button>}</div>

          <div className="text-center mb-6"><h1 className="text-4xl sm:text-5xl font-display font-bold gold-gradient mb-2">{t('ui.title')}</h1><p className="text-amber-200/60 text-sm tracking-widest">{t('ui.subtitle')}</p><button onClick={()=>{localStorage.removeItem('lang');setLang('');setPhase('lang');}} className="mt-3 text-gray-500 hover:text-gray-400 text-sm">üåê {lang==='ru'?'–°–º–µ–Ω–∏—Ç—å —è–∑—ã–∫':lang==='en'?'Change language':'Sprache √§ndern'}</button></div>

          <div className="mb-4"><label className="text-sm text-gray-400 block mb-2">üåç {t('ui.choosePlanet')}</label><div className="grid grid-cols-5 gap-2">{Object.entries(PLANETS).map(([id,p])=>(<button key={id} onClick={()=>setPlanetId(id)} className={`p-2 rounded-lg border text-center transition ${planetId===id?'border-amber-500 bg-amber-500/20':'border-slate-600 hover:border-slate-500'}`}><span className="text-2xl block">{p.icon}</span><span className="text-xs text-gray-400">{'‚òÖ'.repeat(p.difficulty)}</span></button>))}</div><div className="bg-slate-800/30 rounded-lg p-3 mt-2"><p className="text-amber-300 font-bold text-sm">{T.planets[planetId].name[lang]} <span className="text-gray-500 font-normal">‚Ä¢ {T.planets[planetId].traits[lang]}</span></p><p className="text-gray-400 text-xs mt-1">{T.planets[planetId].desc[lang]}</p>{T.planets[planetId].quote&&<p className="text-amber-200/50 text-xs mt-2 italic">{T.planets[planetId].quote[lang]}</p>}</div></div>

          <div className="mb-4"><label className="text-sm text-gray-400 block mb-1">üìä {t('ui.difficulty')}</label><div className="grid grid-cols-3 gap-2">{Object.entries(DIFFICULTIES).map(([key,d])=>(<button key={key} onClick={()=>setDifficulty(key)} className={`py-3 rounded-lg border text-sm transition ${difficulty===key?'border-amber-500 bg-amber-500/20 text-amber-300':'border-slate-600 text-gray-400 hover:border-slate-500'}`}>{d.icon} {t(`ui.${key}`)}</button>))}</div></div>

          <div className="mb-4"><label className="text-sm text-gray-400 block mb-1">‚è±Ô∏è {t('ui.gameLength')}: {maxTurns} {t('ui.years')}</label><input type="range" min="10" max="30" step="5" value={maxTurns} onChange={e=>setMaxTurns(parseInt(e.target.value))} className="w-full" style={{background:`linear-gradient(90deg,#d97706 ${(maxTurns-10)/20*100}%,#1e293b ${(maxTurns-10)/20*100}%)`}}/></div>

          <div className="mb-4"><label className="text-sm text-gray-400 block mb-1">üèõÔ∏è {t('ui.politicalSystem')}</label><div className="grid grid-cols-2 gap-2">{Object.entries(SYSTEMS).map(([id,s])=>(<button key={id} onClick={()=>setSystem(id)} className={`p-3 rounded-lg border text-left transition ${system===id?'border-amber-500 bg-amber-500/10':'border-slate-600 hover:border-slate-500'} ${s.premium&&!isPremium?'opacity-60':''}`}><div className="flex items-center gap-2"><span className="text-xl">{s.icon}</span><span className="text-sm font-bold text-amber-200">{T.systems[id].name[lang]}</span>{s.premium&&!isPremium&&<span className="text-xs bg-amber-500/20 text-amber-400 px-1 rounded">‚≠ê</span>}</div></button>))}</div><div className="bg-slate-800/30 rounded-lg p-3 mt-2"><p className="text-gray-400 text-xs">{T.systems[system].desc[lang]}</p><div className="flex gap-4 mt-2 text-xs"><span className="text-green-400">‚úì {T.systems[system].pros[lang]}</span><span className="text-red-400">‚úó {T.systems[system].cons[lang]}</span></div></div></div>

          <button onClick={()=>setShowAdvanced(!showAdvanced)} className="w-full text-sm text-gray-400 hover:text-gray-300 mb-4">{showAdvanced?'‚ñ≤':'‚ñº'} {t('ui.advancedSettings')}</button>

          {showAdvanced&&(<div className="bg-slate-800/50 rounded-lg p-4 mb-4 space-y-4">
            <div><label className="text-sm text-gray-400">{t('ui.eventsPerTurn')}: {eventsPerTurn}</label><input type="range" min="1" max="4" value={eventsPerTurn} onChange={e=>setEventsPerTurn(parseInt(e.target.value))} className="w-full"/></div>
            <div><label className="text-sm text-gray-400">{t('ui.target')} {t('ui.happiness')}: {targetHappiness}%</label><input type="range" min="50" max="90" step="5" value={targetHappiness} onChange={e=>setTargetHappiness(parseInt(e.target.value))} className="w-full"/></div>
            <div><label className="text-sm text-gray-400">{t('ui.target')} {t('ui.wealth')}: {targetWealth}%</label><input type="range" min="50" max="90" step="5" value={targetWealth} onChange={e=>setTargetWealth(parseInt(e.target.value))} className="w-full"/></div>
            <div><label className="text-sm text-gray-400">{t('ui.target')} {t('ui.stability')}: {targetStability}%</label><input type="range" min="50" max="90" step="5" value={targetStability} onChange={e=>setTargetStability(parseInt(e.target.value))} className="w-full"/></div>
          </div>)}

          <button onClick={startGame} className="w-full py-4 bg-gradient-to-r from-amber-500 via-yellow-500 to-amber-500 text-slate-900 rounded-xl font-display font-bold text-lg hover:from-amber-400 hover:to-yellow-400">{t('ui.startGame')}</button>
        </div>
        {showAuth&&<AuthModal onClose={()=>setShowAuth(false)}/>}
        {showProfile&&<ProfileModal onClose={()=>setShowProfile(false)}/>}
        {showLeaderboard&&<LeaderboardModal onClose={()=>setShowLeaderboard(false)}/>}
        {showPremium&&<PremiumModal onClose={()=>setShowPremium(false)}/>}
        {toast&&<Toast message={toast.message} type={toast.type} onClose={()=>setToast(null)}/>}
        </div>);
      }

      // PLAYING
      if(phase==='playing'){
        const getStatColor=(value,target)=>value>=target?'text-green-400':value>=target-10?'text-amber-300':'text-red-400';
        return(<div className="min-h-screen bg-slate-950 text-white p-4"><StarBackground/><div className="max-w-md mx-auto relative z-10">
          <div className="flex justify-between items-center mb-4"><div className="flex items-center gap-2"><span className="text-2xl">{sys.icon}</span><span className="text-amber-300 font-bold">{T.systems[system].leader[lang]}</span></div><div className="text-right"><span className="text-amber-400 font-display">{t('ui.year')} {turn}/{maxTurns}</span><p className="text-xs text-gray-500">{T.planets[planetId].name[lang]}</p></div></div>

          <div className="bg-slate-800/50 rounded-xl p-4 border border-amber-500/20 mb-4">
            <div className="mb-2"><div className="flex justify-between text-xs mb-1"><span className="text-amber-100/80">üòä {t('ui.happiness')}</span><span className={`font-bold ${getStatColor(stats.happiness,targetHappiness)}`}>{Math.round(stats.happiness)}% <span className="text-gray-500">/ {targetHappiness}%</span></span></div><div className="h-2 bg-slate-900 rounded overflow-hidden border border-amber-900/30 relative"><div className="h-full bg-gradient-to-r from-green-600 to-green-400 transition-all duration-500" style={{width:`${Math.min(100,Math.max(0,stats.happiness))}%`}}/><div className="absolute top-0 bottom-0 w-0.5 bg-white/50" style={{left:`${targetHappiness}%`}}/></div></div>
            <div className="mb-2"><div className="flex justify-between text-xs mb-1"><span className="text-amber-100/80">üí∞ {t('ui.wealth')}</span><span className={`font-bold ${getStatColor(stats.wealth,targetWealth)}`}>{Math.round(stats.wealth)}% <span className="text-gray-500">/ {targetWealth}%</span></span></div><div className="h-2 bg-slate-900 rounded overflow-hidden border border-amber-900/30 relative"><div className="h-full bg-gradient-to-r from-yellow-600 to-yellow-400 transition-all duration-500" style={{width:`${Math.min(100,Math.max(0,stats.wealth))}%`}}/><div className="absolute top-0 bottom-0 w-0.5 bg-white/50" style={{left:`${targetWealth}%`}}/></div></div>
            <div className="mb-2"><div className="flex justify-between text-xs mb-1"><span className="text-amber-100/80">‚öñÔ∏è {t('ui.stability')}</span><span className={`font-bold ${getStatColor(stats.stability,targetStability)}`}>{Math.round(stats.stability)}% <span className="text-gray-500">/ {targetStability}%</span></span></div><div className="h-2 bg-slate-900 rounded overflow-hidden border border-amber-900/30 relative"><div className="h-full bg-gradient-to-r from-blue-600 to-blue-400 transition-all duration-500" style={{width:`${Math.min(100,Math.max(0,stats.stability))}%`}}/><div className="absolute top-0 bottom-0 w-0.5 bg-white/50" style={{left:`${targetStability}%`}}/></div></div>
            <div className="flex justify-between items-center mt-3 pt-3 border-t border-slate-700"><span className="text-amber-200/80">üíé {t('ui.budget')}</span><span className={`font-bold ${remaining<0?'text-red-400':'text-amber-300'}`}>{hydrobite} ({remaining>=0?'+':''}{remaining})</span></div>
          </div>

          <div className="bg-slate-800/50 rounded-xl p-4 border border-amber-500/20 mb-4">{SECTORS.map(sec=>(<div key={sec.id} className="mb-3"><div className="flex justify-between text-sm mb-1"><span className="text-amber-100/80">{sec.icon} {T.sectors[sec.id].name[lang]}</span><span className="text-amber-300 font-bold">{budget[sec.id]}</span></div><input type="range" min="0" max="50" value={budget[sec.id]} onChange={e=>handleBudget(sec.id,e.target.value)} className="w-full" style={{background:`linear-gradient(90deg,#d97706 ${budget[sec.id]*2}%,#1e293b ${budget[sec.id]*2}%)`}}/></div>))}</div>

          <button onClick={processTurn} disabled={remaining<0} className="w-full py-4 bg-gradient-to-r from-amber-500 to-yellow-500 text-slate-900 rounded-xl font-bold text-lg disabled:opacity-50">{t('ui.submit')}</button>
        </div>{toast&&<Toast message={toast.message} type={toast.type} onClose={()=>setToast(null)}/>}</div>);
      }

      // EVENT
      if(phase==='event'&&event){
        return(<div className="min-h-screen bg-slate-950 text-white p-4 flex items-center justify-center"><StarBackground/><div className="max-w-md w-full relative z-10 animate-slideUp"><div className="bg-slate-800 rounded-2xl border border-amber-500/30 overflow-hidden">
          <div className="bg-gradient-to-r from-amber-900/50 to-slate-800 p-6 text-center relative">
            {isAdmin&&<button onClick={()=>setEditingEvent(event)} className="absolute top-2 right-2 p-2 bg-slate-700/80 hover:bg-slate-600 rounded-lg text-sm" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>}
            <span className="text-5xl block mb-2">{event.icon}</span>
            <h2 className="text-xl font-display font-bold text-amber-400">{event.title[lang]}</h2>
          </div>
          <div className="p-6"><p className="text-gray-300 text-center mb-6">{event.desc[lang]}</p><div className="space-y-3">{event.choices.map((choice,i)=>(<button key={i} onClick={()=>handleChoice(choice)} className="w-full p-4 bg-slate-700/50 hover:bg-slate-600/50 border border-slate-600 hover:border-amber-500/50 rounded-xl text-left transition"><div className="flex justify-between items-start mb-1"><span className="font-bold text-amber-200">{choice.text[lang]}</span><span className="text-amber-400 text-sm">-{choice.cost}üíé</span></div><div className="flex gap-2 mt-2 text-xs">{Object.entries(choice.effects).map(([k,v])=>(<span key={k} className={v>=0?'text-green-400':'text-red-400'}>{k==='happiness'?'üòä':k==='wealth'?'üí∞':'‚öñÔ∏è'}{v>=0?'+':''}{v}</span>))}</div></button>))}</div></div>
        </div></div>
        {editingEvent&&<AdminEventEditor event={editingEvent} onClose={()=>setEditingEvent(null)} onSave={()=>showToast('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ! –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.','success')}/>}
        </div>);
      }

      // VICTORY
      if(phase==='victory'){
        return(<div className="min-h-screen bg-slate-950 text-white p-4 flex items-center justify-center"><StarBackground/><div className="max-w-md w-full text-center relative z-10 animate-slideUp"><div className="bg-gradient-to-b from-amber-900/50 to-slate-800 rounded-2xl border border-amber-500/50 p-8"><span className="text-6xl block mb-4">üèÜ</span><h1 className="text-3xl font-display font-bold gold-gradient mb-4">{t('ui.victory')}</h1><p className="text-amber-200 mb-6">{T.victoryMsg[victoryType||'survival']?.[lang]}</p><div className="bg-slate-800/50 rounded-xl p-4 mb-6"><div className="text-4xl font-bold text-amber-400 mb-2">{finalScore}</div><p className="text-gray-400">{t('ui.score')}</p></div><div className="grid grid-cols-3 gap-4 mb-6"><div className="text-center"><span className="text-2xl">üòä</span><p className="text-lg font-bold text-green-400">{Math.round(stats.happiness)}%</p></div><div className="text-center"><span className="text-2xl">üí∞</span><p className="text-lg font-bold text-yellow-400">{Math.round(stats.wealth)}%</p></div><div className="text-center"><span className="text-2xl">‚öñÔ∏è</span><p className="text-lg font-bold text-blue-400">{Math.round(stats.stability)}%</p></div></div><button onClick={()=>{setPhase('title');setIntroStep(0);}} className="w-full py-4 bg-gradient-to-r from-amber-500 to-yellow-500 text-slate-900 rounded-xl font-bold">{t('ui.playAgain')}</button></div></div></div>);
      }

      // GAMEOVER
      if(phase==='gameover'){
        return(<div className="min-h-screen bg-slate-950 text-white p-4 flex items-center justify-center"><StarBackground/><div className="max-w-md w-full text-center relative z-10 animate-slideUp"><div className="bg-gradient-to-b from-red-900/50 to-slate-800 rounded-2xl border border-red-500/50 p-8"><span className="text-6xl block mb-4">üíÄ</span><h1 className="text-3xl font-display font-bold text-red-400 mb-4">{t('ui.defeat')}</h1><p className="text-red-200 mb-6">{T.defeat[victoryType||'stability']?.[lang]}</p><div className="bg-slate-800/50 rounded-xl p-4 mb-6"><p className="text-gray-400">{t('ui.year')} {turn} / {maxTurns}</p><p className="text-2xl font-bold text-red-400">{finalScore} {t('ui.score')}</p></div><button onClick={()=>{setPhase('title');setIntroStep(0);}} className="w-full py-4 bg-gradient-to-r from-red-600 to-red-500 text-white rounded-xl font-bold">{t('ui.playAgain')}</button></div></div></div>);
      }
      return null;
    }

    function App(){return(<ContentProvider><AuthProvider><LangProvider><Game/></LangProvider></AuthProvider></ContentProvider>);}
    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
  <script>
    // Cleanup on load
    if('serviceWorker' in navigator){navigator.serviceWorker.getRegistrations().then(r=>r.forEach(r=>r.unregister()));caches.keys().then(k=>k.forEach(k=>caches.delete(k)));}
    // Reset function for debugging
    window.resetGame=()=>{localStorage.clear();sessionStorage.clear();location.reload();};
    // Auto-reset if stuck (check via URL param)
    if(location.search.includes('reset')){localStorage.clear();sessionStorage.clear();history.replaceState({},'',location.pathname);location.reload();}
  </script>
</body>
</html>
