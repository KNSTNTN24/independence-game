<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#d97706">
  <meta name="description" content="Independence - –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –∏–≥—Ä–∞ –æ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∏—Å—Ç–µ–º–∞—Ö">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Independence">
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/svg+xml" href="/icon-192.svg">
  <title>Independence - Civic Education Game</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Raleway:wght@300;400;600;700&display=swap');
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{margin:0;padding:0;font-family:'Raleway',sans-serif;background:#0f172a;overscroll-behavior:none}
    .safe-top{padding-top:env(safe-area-inset-top)}.safe-bottom{padding-bottom:env(safe-area-inset-bottom)}
    .font-display{font-family:'Cinzel',serif}
    .gold-gradient{background:linear-gradient(180deg,#fbbf24 0%,#d97706 50%,#92400e 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    input[type="range"]{-webkit-appearance:none;height:8px;border-radius:4px}
    input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:24px;height:24px;border-radius:50%;background:linear-gradient(180deg,#fbbf24,#d97706);cursor:pointer}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
    @keyframes spin{to{transform:rotate(360deg)}}
    .animate-fadeIn{animation:fadeIn .3s ease-out}.animate-slideUp{animation:slideUp .4s ease-out}
    .animate-pulse{animation:pulse 2s infinite}.animate-spin{animation:spin 1s linear infinite}
    button{min-height:44px;cursor:pointer;transition:all .15s}button:active{transform:scale(.97)}
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:100;display:flex;align-items:center;justify-content:center;padding:1rem}
    .toast{position:fixed;top:1rem;left:50%;transform:translateX(-50%);z-index:200;max-width:90%}
    .star-bg{position:fixed;inset:0;overflow:hidden;pointer-events:none;z-index:0}
    .star{position:absolute;width:2px;height:2px;background:white;border-radius:50%;opacity:.5}
  </style>
</head>
<body class="safe-top safe-bottom">
  <div id="root"></div>
  <script type="text/babel">
    const{useState,useEffect,useCallback,createContext,useContext,useMemo}=React;

    // ===== CONFIG =====
    const SUPABASE_URL='https://dnkeinsedcrlhwbiycfo.supabase.co';
    const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRua2VpbnNlZGNybGh3Yml5Y2ZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NDg0MjgsImV4cCI6MjA4NDMyNDQyOH0.9IkWv6dwOemaVwvWrwq7ZzuebrgWI83JWrdaZbzdhhw';
    const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
    const STRIPE_KEY='pk_live_51SrFQOH02sKb65Xcey2pn7bvJhJQ1EqpjYyAoiVKK3OmGZjlKCMRmuX4t6zUitqQ2RHI7MIceHAkHYadAi4r31D900L7ki97pX';

    // ===== LOCALIZATION =====
    const T={
      ui:{
        title:{ru:'INDEPENDENCE',en:'INDEPENDENCE',de:'INDEPENDENCE'},
        subtitle:{ru:'–û–ë–†–ê–ó–û–í–ê–¢–ï–õ–¨–ù–ê–Ø –ò–ì–†–ê –û –ü–û–õ–ò–¢–ò–ö–ï',en:'CIVIC EDUCATION GAME',de:'POLITISCHES BILDUNGSSPIEL'},
        login:{ru:'–í–æ–π—Ç–∏',en:'Login',de:'Anmelden'},
        register:{ru:'–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è',en:'Register',de:'Registrieren'},
        premium:{ru:'Premium',en:'Premium',de:'Premium'},
        premiumPrice:{ru:'¬£2.99/–º–µ—Å',en:'¬£2.99/mo',de:'¬£2.99/Mo'},
        startGame:{ru:'–ù–∞—á–∞—Ç—å –∏–≥—Ä—É',en:'Start Game',de:'Spiel starten'},
        year:{ru:'–ì–æ–¥',en:'Year',de:'Jahr'},
        submit:{ru:'–£—Ç–≤–µ—Ä–¥–∏—Ç—å –±—é–¥–∂–µ—Ç',en:'Submit Budget',de:'Budget best√§tigen'},
        happiness:{ru:'–°—á–∞—Å—Ç—å–µ',en:'Happiness',de:'Zufriedenheit'},
        wealth:{ru:'–ë–æ–≥–∞—Ç—Å—Ç–≤–æ',en:'Wealth',de:'Wohlstand'},
        stability:{ru:'–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å',en:'Stability',de:'Stabilit√§t'},
        budget:{ru:'–ë—é–¥–∂–µ—Ç',en:'Budget',de:'Budget'},
        remaining:{ru:'–û—Å—Ç–∞—Ç–æ–∫',en:'Remaining',de:'Verbleibend'},
        victory:{ru:'–ü–û–ë–ï–î–ê!',en:'VICTORY!',de:'SIEG!'},
        defeat:{ru:'–ü–û–†–ê–ñ–ï–ù–ò–ï',en:'DEFEAT',de:'NIEDERLAGE'},
        playAgain:{ru:'–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞',en:'Play Again',de:'Nochmal spielen'},
        back:{ru:'–ù–∞–∑–∞–¥',en:'Back',de:'Zur√ºck'},
        next:{ru:'–î–∞–ª–µ–µ',en:'Next',de:'Weiter'},
        skip:{ru:'–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å',en:'Skip',de:'√úberspringen'},
        close:{ru:'–ó–∞–∫—Ä—ã—Ç—å',en:'Close',de:'Schlie√üen'},
        easy:{ru:'–õ–µ–≥–∫–æ',en:'Easy',de:'Leicht'},
        normal:{ru:'–ù–æ—Ä–º–∞–ª—å–Ω–æ',en:'Normal',de:'Normal'},
        hard:{ru:'–°–ª–æ–∂–Ω–æ',en:'Hard',de:'Schwer'},
        years:{ru:'–ª–µ—Ç',en:'years',de:'Jahre'},
        choosePlanet:{ru:'–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞–Ω–µ—Ç—É',en:'Choose Planet',de:'Planet w√§hlen'},
        score:{ru:'–û—á–∫–∏',en:'Score',de:'Punkte'},
        signOut:{ru:'–í—ã–π—Ç–∏',en:'Sign Out',de:'Abmelden'},
        email:{ru:'Email',en:'Email',de:'E-Mail'},
        password:{ru:'–ü–∞—Ä–æ–ª—å',en:'Password',de:'Passwort'},
        username:{ru:'–ò–º—è',en:'Username',de:'Name'},
        loading:{ru:'–ó–∞–≥—Ä—É–∑–∫–∞...',en:'Loading...',de:'L√§dt...'},
        selectLanguage:{ru:'–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫',en:'Select Language',de:'Sprache w√§hlen'},
        advancedSettings:{ru:'–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏',en:'Advanced Settings',de:'Erweiterte Einstellungen'},
        target:{ru:'–¶–µ–ª—å',en:'Target',de:'Ziel'},
        gameLength:{ru:'–î–ª–∏–Ω–∞ –∏–≥—Ä—ã',en:'Game length',de:'Spiell√§nge'},
        eventsPerTurn:{ru:'–°–æ–±—ã—Ç–∏–π –∑–∞ —Ö–æ–¥',en:'Events per turn',de:'Ereignisse pro Zug'},
        difficulty:{ru:'–°–ª–æ–∂–Ω–æ—Å—Ç—å',en:'Difficulty',de:'Schwierigkeit'},
        politicalSystem:{ru:'–ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞',en:'Political System',de:'Politisches System'},
      },
      intro:{
        title:{ru:'–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –û—Å–Ω–æ–≤–∞—Ç–µ–ª—å!',en:'Welcome, Founder!',de:'Willkommen, Gr√ºnder!'},
        p1:{ru:'–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –ü–æ–∫–∞ –æ—Å—Ç–∞–ª—å–Ω–æ–µ —á–µ–ª–æ–≤–µ—á–µ—Å—Ç–≤–æ –ø–æ–≥—Ä—è–∑–ª–æ –≤ –±—é—Ä–æ–∫—Ä–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Å–ø–æ—Ä–∞—Ö –æ —Ç–æ–º, –∫–æ–º—É –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ø–æ—Å–ª–µ–¥–Ω—è—è –±–∞–Ω–∫–∞ –∫–æ–Ω—Å–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–∏—Å–ª–æ—Ä–æ–¥–∞, –≤—ã –ø—Ä–æ—è–≤–∏–ª–∏ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É.',en:'Congratulations! While the rest of humanity was busy arguing over who owns the last can of preserved oxygen, you took initiative.',de:'Herzlichen Gl√ºckwunsch! W√§hrend der Rest der Menschheit sich dar√ºber stritt, wem die letzte Dose Sauerstoff geh√∂rt, haben Sie Initiative ergriffen.'},
        p2:{ru:'–í–∞—à –∫–æ—Ä–∞–±–ª—å —Å —Ç—ã—Å—è—á–µ–π –∫–æ–ª–æ–Ω–∏—Å—Ç–æ–≤ –ø—Ä–∏–∑–µ–º–ª–∏–ª—Å—è –Ω–∞ –ø–ª–∞–Ω–µ—Ç–µ, –∫–æ—Ç–æ—Ä—É—é –Ω–∏–∫—Ç–æ –Ω–µ —É—Å–ø–µ–ª –∑–∞—Å—Ç–æ–ª–±–∏—Ç—å. –¢–µ–ø–µ—Ä—å —É –≤–∞—Å –µ—Å—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å ‚Äî –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –∏–¥–µ–∞–ª—å–Ω–æ–µ –æ–±—â–µ—Å—Ç–≤–æ —Å –Ω—É–ª—è.',en:'Your ship with a thousand colonists has landed on a planet nobody bothered to claim. Now you have a unique opportunity ‚Äî to build a perfect society from scratch.',de:'Ihr Schiff mit tausend Kolonisten ist auf einem Planeten gelandet, den niemand beansprucht hat. Jetzt haben Sie eine einzigartige Gelegenheit ‚Äî eine perfekte Gesellschaft aufzubauen.'},
        p3:{ru:'–ò–ª–∏, –∫–∞–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—è, –æ—á–µ—Ä–µ–¥–Ω–æ–µ –Ω–µ–∏–¥–µ–∞–ª—å–Ω–æ–µ. –ù–æ –∫—Ç–æ –º—ã —Ç–∞–∫–∏–µ, —á—Ç–æ–±—ã —Å—É–¥–∏—Ç—å?',en:'Or, as history suggests, yet another imperfect one. But who are we to judge?',de:'Oder, wie die Geschichte zeigt, eine weitere unvollkommene. Aber wer sind wir, um zu urteilen?'},
        mission:{ru:'–í–∞—à–∞ –∑–∞–¥–∞—á–∞: —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ü–≤–µ—Ç–∞—é—â—É—é —Ü–∏–≤–∏–ª–∏–∑–∞—Ü–∏—é, –∏–∑–±–µ–∂–∞–≤ —Ä–µ–≤–æ–ª—é—Ü–∏–π, –≥–æ–ª–æ–¥–Ω—ã—Ö –±—É–Ω—Ç–æ–≤ –∏ –Ω–µ–ª–æ–≤–∫–∏—Ö —Å–∏—Ç—É–∞—Ü–∏–π —Å —Å–æ—Å–µ–¥–Ω–∏–º–∏ –∫–æ–ª–æ–Ω–∏—è–º–∏.',en:'Your mission: create a thriving civilization while avoiding revolutions, food riots, and awkward situations with neighboring colonies.',de:'Ihre Mission: eine bl√ºhende Zivilisation aufbauen und dabei Revolutionen und Hungeraufst√§nde vermeiden.'},
      },
      systems:{
        parliamentary:{name:{ru:'–ü–∞—Ä–ª–∞–º–µ–Ω—Ç—Å–∫–∞—è –¥–µ–º–æ–∫—Ä–∞—Ç–∏—è',en:'Parliamentary Democracy',de:'Parlamentarische Demokratie'},leader:{ru:'–ü—Ä–µ–º—å–µ—Ä-–º–∏–Ω–∏—Å—Ç—Ä',en:'Prime Minister',de:'Premierminister'},desc:{ru:'–í—ã —Ä–µ—à–∏–ª–∏ –ø–æ–∑–≤–æ–ª–∏—Ç—å –ª—é–¥—è–º —Å–ø–æ—Ä–∏—Ç—å –¥–æ —Ö—Ä–∏–ø–æ—Ç—ã, –∞ –ø–æ—Ç–æ–º –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å. –í –¥–∏—Å–∫—É—Å—Å–∏–∏ —Ä–æ–∂–¥–∞–µ—Ç—Å—è –≥–æ–ª–æ–≤–Ω–∞—è –±–æ–ª—å, –Ω–æ —ç—Ç–æ –¥–µ—Ç–∞–ª–∏.',en:'You\'ve decided to let people argue until hoarse, then vote. Discussions produce headaches, but details.',de:'Sie lassen die Menschen diskutieren und dann abstimmen.'}},
        presidential:{name:{ru:'–ü—Ä–µ–∑–∏–¥–µ–Ω—Ç—Å–∫–∞—è —Ä–µ—Å–ø—É–±–ª–∏–∫–∞',en:'Presidential Republic',de:'Pr√§sidialrepublik'},leader:{ru:'–ü—Ä–µ–∑–∏–¥–µ–Ω—Ç',en:'President',de:'Pr√§sident'},desc:{ru:'–û–¥–∏–Ω —á–µ–ª–æ–≤–µ–∫, –º–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏. –ü—Ä—è–º–æ–π –º–∞–Ω–¥–∞—Ç –Ω–∞—Ä–æ–¥–∞ –∏ –ø–æ–ª–Ω–∞—è —Å–≤–æ–±–æ–¥–∞ –¥–µ–π—Å—Ç–≤–∏–π.',en:'One person, lots of responsibility. Direct mandate and complete freedom of action.',de:'Eine Person, viel Verantwortung. Direktes Mandat und volle Handlungsfreiheit.'}},
        monarchy:{name:{ru:'–ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏–æ–Ω–Ω–∞—è –º–æ–Ω–∞—Ä—Ö–∏—è',en:'Constitutional Monarchy',de:'Konstitutionelle Monarchie'},leader:{ru:'–ú–æ–Ω–∞—Ä—Ö',en:'Monarch',de:'Monarch'},desc:{ru:'–ó–∞—á–µ–º –≤—ã–±–∏—Ä–∞—Ç—å –ª–∏–¥–µ—Ä–∞, –µ—Å–ª–∏ –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ —Ä–æ–¥–∏—Ç—å—Å—è –∏–º? –¢—Ä–∞–¥–∏—Ü–∏–∏ –∏ –∫—Ä–∞—Å–∏–≤—ã–µ —Ü–µ—Ä–µ–º–æ–Ω–∏–∏.',en:'Why elect when you can be born a leader? Traditions and beautiful ceremonies.',de:'Warum w√§hlen, wenn man als F√ºhrer geboren werden kann?'}},
        dictatorship:{name:{ru:'–î–∏–∫—Ç–∞—Ç—É—Ä–∞',en:'Dictatorship',de:'Diktatur'},leader:{ru:'–í–µ—Ä—Ö–æ–≤–Ω—ã–π –ª–∏–¥–µ—Ä',en:'Supreme Leader',de:'Oberster F√ºhrer'},desc:{ru:'–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø—Ä–µ–≤—ã—à–µ –≤—Å–µ–≥–æ! –î–µ–º–æ–∫—Ä–∞—Ç–∏—è ‚Äî –¥–æ–ª–≥–æ –∏ —Å–∫—É—á–Ω–æ, –∞ –≤—ã ‚Äî —á–µ–ª–æ–≤–µ–∫ –¥–µ–ª–∞.',en:'Efficiency above all! Democracy is slow and boring, and you\'re a person of action.',de:'Effizienz √ºber alles! Demokratie ist langsam und langweilig.'}},
        technocracy:{name:{ru:'–¢–µ—Ö–Ω–æ–∫—Ä–∞—Ç–∏—è',en:'Technocracy',de:'Technokratie'},leader:{ru:'–ì–ª–∞–≤–Ω—ã–π —Ç–µ—Ö–Ω–æ–ª–æ–≥',en:'Chief Technologist',de:'Cheftechnologe'},desc:{ru:'–ü–æ–ª–∏—Ç–∏–∫–∏ ‚Äî –≤—á–µ—Ä–∞—à–Ω–∏–π –¥–µ–Ω—å. –ë—É–¥—É—â–µ–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —ç–∫—Å–ø–µ—Ä—Ç–∞–º!',en:'Politicians are yesterday. The future belongs to experts!',de:'Politiker sind von gestern. Die Zukunft geh√∂rt Experten!'}},
        direct:{name:{ru:'–ü—Ä—è–º–∞—è –¥–µ–º–æ–∫—Ä–∞—Ç–∏—è',en:'Direct Democracy',de:'Direkte Demokratie'},leader:{ru:'–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä',en:'Coordinator',de:'Koordinator'},desc:{ru:'–ö–∞–∂–¥—ã–π –≥–æ–ª–æ—Å –≤–∞–∂–µ–Ω! –ü–æ –∫–∞–∂–¥–æ–º—É –≤–æ–ø—Ä–æ—Å—É. –ó–≤—É—á–∏—Ç –∏–¥–µ–∞–ª—å–Ω–æ, –ø–æ–∫–∞ –Ω–µ –ø–æ–ø—Ä–æ–±—É–µ—Ç–µ.',en:'Every voice matters! On every issue. Sounds ideal until you try it.',de:'Jede Stimme z√§hlt! Bei jedem Thema.'}},
      },
      planets:{
        terranova:{name:{ru:'–¢–µ—Ä—Ä–∞ –ù–æ–≤–∞',en:'Terra Nova',de:'Terra Nova'},desc:{ru:'–°–∫—É—á–Ω–∞—è? –í–æ–∑–º–æ–∂–Ω–æ. –ü—Ä–∏–≥–æ–¥–Ω–∞—è –¥–ª—è –∂–∏–∑–Ω–∏? –û–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ.',en:'Boring? Perhaps. Habitable? Definitely.',de:'Langweilig? Vielleicht. Bewohnbar? Definitiv.'},traits:{ru:'–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è',en:'Balanced',de:'Ausgewogen'}},
        aridia:{name:{ru:'–ê—Ä–∏–¥–∏—è',en:'Aridia',de:'Aridia'},desc:{ru:'–í–æ–¥–∞ –¥–æ—Ä–æ–∂–µ –∑–æ–ª–æ—Ç–∞. –ó–∞—Ç–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –Ω–µ —Ä–≤—É—Ç—Å—è —Å—é–¥–∞.',en:'Water worth more than gold. But competitors aren\'t rushing here.',de:'Wasser teurer als Gold.'},traits:{ru:'–ü—É—Å—Ç—ã–Ω—è ‚Ä¢ –ú–∏–Ω–µ—Ä–∞–ª—ã',en:'Desert ‚Ä¢ Minerals',de:'W√ºste ‚Ä¢ Mineralien'}},
        edemia:{name:{ru:'–≠–¥–µ–º–∏—è',en:'Edemia',de:'Edemia'},desc:{ru:'–†–∞–π! –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ ‚Äî –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–æ–∂–µ —Ö–æ—Ç—è—Ç –∫—É—Å–æ—á–µ–∫.',en:'Paradise! Only problem ‚Äî everyone else wants a piece too.',de:'Paradies! Einziges Problem ‚Äî alle anderen wollen auch ein St√ºck.'},traits:{ru:'–ë–æ–≥–∞—Ç–∞—è ‚Ä¢ –°–æ—Å–µ–¥–∏',en:'Rich ‚Ä¢ Neighbors',de:'Reich ‚Ä¢ Nachbarn'}},
        chaosprime:{name:{ru:'–•–∞–æ—Å –ü—Ä–∞–π–º',en:'Chaos Prime',de:'Chaos Prime'},desc:{ru:'–ó–µ–º–ª–µ—Ç—Ä—è—Å–µ–Ω–∏—è –ø–æ –≤—Ç–æ—Ä–Ω–∏–∫–∞–º, –∏–∑–≤–µ—Ä–∂–µ–Ω–∏—è –ø–æ –ø—è—Ç–Ω–∏—Ü–∞–º.',en:'Earthquakes on Tuesdays, eruptions on Fridays.',de:'Erdbeben dienstags, Ausbr√ºche freitags.'},traits:{ru:'–•–∞–æ—Å ‚Ä¢ –°–æ–±—ã—Ç–∏—è',en:'Chaos ‚Ä¢ Events',de:'Chaos ‚Ä¢ Ereignisse'}},
        polaris:{name:{ru:'–ü–æ–ª—è—Ä–∏—Å',en:'Polaris',de:'Polaris'},desc:{ru:'–í–µ—á–Ω–∞—è –º–µ—Ä–∑–ª–æ—Ç–∞ –∑–∞–∫–∞–ª—è–µ—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä. –ò–ª–∏ —É–±–∏–≤–∞–µ—Ç.',en:'Permafrost builds character. Or kills you.',de:'Permafrost st√§rkt den Charakter. Oder t√∂tet.'},traits:{ru:'–•–æ–ª–æ–¥ ‚Ä¢ –ï–¥–∏–Ω—Å—Ç–≤–æ',en:'Cold ‚Ä¢ Unity',de:'Kalt ‚Ä¢ Einheit'}},
      },
      sectors:{
        defence:{name:{ru:'–û–±–æ—Ä–æ–Ω–∞',en:'Defence',de:'Verteidigung'}},
        education:{name:{ru:'–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ',en:'Education',de:'Bildung'}},
        health:{name:{ru:'–ó–¥—Ä–∞–≤–æ–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ',en:'Healthcare',de:'Gesundheit'}},
        infra:{name:{ru:'–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞',en:'Infrastructure',de:'Infrastruktur'}},
        welfare:{name:{ru:'–°–æ—Ü–∑–∞—â–∏—Ç–∞',en:'Welfare',de:'Soziales'}},
      },
      defeat:{
        happiness:{ru:'–ù–∞—Ä–æ–¥ –≤–æ—Å—Å—Ç–∞–ª! –í–∞—à–µ –ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–∫–æ–Ω—á–µ–Ω–æ.',en:'The people have risen! Your rule is over.',de:'Das Volk hat sich erhoben!'},
        stability:{ru:'–•–∞–æ—Å –ø–æ–≥–ª–æ—Ç–∏–ª –≤–∞—à—É —Ü–∏–≤–∏–ª–∏–∑–∞—Ü–∏—é.',en:'Chaos has consumed your civilization.',de:'Chaos hat Ihre Zivilisation verschlungen.'},
        rebellion:{ru:'–ú—è—Ç–µ–∂ —Å–≤–µ—Ä–≥ –º–æ–Ω–∞—Ä—Ö–∏—é!',en:'A rebellion overthrew the monarchy!',de:'Ein Aufstand hat die Monarchie gest√ºrzt!'},
        coup:{ru:'–í–æ–µ–Ω–Ω—ã–π –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç!',en:'Military coup!',de:'Milit√§rputsch!'},
      },
      victoryMsg:{
        utopia:{ru:'–£—Ç–æ–ø–∏—è –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!',en:'Utopia achieved!',de:'Utopie erreicht!'},
        prosperity:{ru:'–≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–µ —á—É–¥–æ!',en:'Economic miracle!',de:'Wirtschaftswunder!'},
        survival:{ru:'–í—ã –ø—Ä–æ–≤–µ–ª–∏ —Ü–∏–≤–∏–ª–∏–∑–∞—Ü–∏—é —á–µ—Ä–µ–∑ –≤—Å–µ –∏—Å–ø—ã—Ç–∞–Ω–∏—è!',en:'You guided your civilization through all challenges!',de:'Sie haben alle Herausforderungen gemeistert!'},
      },
    };

    // ===== GAME DATA =====
    const DIFFICULTIES={easy:{icon:'üòä',bonus:10,hydroBonus:30,severity:0.7},normal:{icon:'üòê',bonus:0,hydroBonus:0,severity:1.0},hard:{icon:'üò∞',bonus:-10,hydroBonus:-20,severity:1.3}};
    const SYSTEMS={parliamentary:{id:'parliamentary',icon:'üèõÔ∏è',premium:false,traits:{needsApproval:true,threshold:40,stabilityBonus:0,happinessDecay:0,wealthBonus:0}},presidential:{id:'presidential',icon:'ü¶Ö',premium:false,traits:{needsApproval:false,stabilityBonus:0,happinessDecay:0,wealthBonus:5}},monarchy:{id:'monarchy',icon:'üëë',premium:true,traits:{needsApproval:false,stabilityBonus:10,happinessDecay:0,wealthBonus:0,rebellionRisk:25}},dictatorship:{id:'dictatorship',icon:'‚öîÔ∏è',premium:true,traits:{needsApproval:false,stabilityBonus:5,happinessDecay:5,wealthBonus:0,coupRisk:30}},technocracy:{id:'technocracy',icon:'üî¨',premium:true,traits:{needsApproval:false,stabilityBonus:5,happinessDecay:2,wealthBonus:15,startPenalty:10}},direct:{id:'direct',icon:'üó≥Ô∏è',premium:true,traits:{needsApproval:false,stabilityBonus:-5,happinessDecay:-3,wealthBonus:0,referendumChance:0.25}}};
    const PLANETS={terranova:{id:'terranova',icon:'üåç',difficulty:2,stats:{happiness:60,wealth:50,stability:70},mods:{eventMult:1.0,extraEvents:0}},aridia:{id:'aridia',icon:'üèúÔ∏è',difficulty:4,stats:{happiness:45,wealth:35,stability:60},mods:{eventMult:1.2,extraEvents:0,happinessDecay:2}},edemia:{id:'edemia',icon:'üå¥',difficulty:2,stats:{happiness:75,wealth:70,stability:55},mods:{eventMult:1.0,extraEvents:0,stabilityDecay:2}},chaosprime:{id:'chaosprime',icon:'üåã',difficulty:3,stats:{happiness:50,wealth:55,stability:40},mods:{eventMult:1.5,extraEvents:1,stabilityDecay:3}},polaris:{id:'polaris',icon:'‚ùÑÔ∏è',difficulty:4,stats:{happiness:40,wealth:45,stability:80},mods:{eventMult:0.8,extraEvents:0,happinessDecay:3}}};
    const SECTORS=[{id:'defence',icon:'üõ°Ô∏è'},{id:'education',icon:'üìö'},{id:'health',icon:'üè•'},{id:'infra',icon:'üèóÔ∏è'},{id:'welfare',icon:'ü§ù'}];

    // ===== EVENTS =====
    const EVENTS={
      general:[
        {id:'pandemic',icon:'ü¶†',title:{ru:'–≠–ø–∏–¥–µ–º–∏—è',en:'Pandemic',de:'Pandemie'},desc:{ru:'–û–ø–∞—Å–Ω—ã–π –≤–∏—Ä—É—Å —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è. –≠–∫—Å–ø–µ—Ä—Ç—ã —Å–ø–æ—Ä—è—Ç –æ –ø—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏–∏.',en:'A dangerous virus is spreading. Experts argue about its origin.',de:'Ein gef√§hrlicher Virus breitet sich aus.'},choices:[{text:{ru:'–ñ—ë—Å—Ç–∫–∏–π –∫–∞—Ä–∞–Ω—Ç–∏–Ω',en:'Strict quarantine',de:'Strenge Quarant√§ne'},effects:{happiness:-20,wealth:-15,stability:10},cost:30},{text:{ru:'–£–º–µ—Ä–µ–Ω–Ω—ã–µ –º–µ—Ä—ã',en:'Moderate measures',de:'Moderate Ma√ünahmen'},effects:{happiness:-10,wealth:-8,stability:5},cost:15},{text:{ru:'–ù–µ –≤–º–µ—à–∏–≤–∞—Ç—å—Å—è',en:'Do nothing',de:'Nichts tun'},effects:{happiness:5,stability:-20},cost:0}]},
        {id:'strike',icon:'‚úä',title:{ru:'–ó–∞–±–∞—Å—Ç–æ–≤–∫–∞',en:'Strike',de:'Streik'},desc:{ru:'–†–∞–±–æ—á–∏–µ —Ç—Ä–µ–±—É—é—Ç —É–ª—É—á—à–µ–Ω–∏—è —É—Å–ª–æ–≤–∏–π.',en:'Workers demand better conditions.',de:'Arbeiter fordern bessere Bedingungen.'},choices:[{text:{ru:'–ü—Ä–∏–Ω—è—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è',en:'Accept demands',de:'Forderungen akzeptieren'},effects:{happiness:25,wealth:-20},cost:25},{text:{ru:'–ß–∞—Å—Ç–∏—á–Ω—ã–µ —É—Å—Ç—É–ø–∫–∏',en:'Partial concessions',de:'Teilzugest√§ndnisse'},effects:{happiness:10,wealth:-8,stability:5},cost:12},{text:{ru:'–ü–æ–¥–∞–≤–∏—Ç—å',en:'Suppress',de:'Unterdr√ºcken'},effects:{happiness:-25,stability:-15,wealth:8},cost:15}]},
        {id:'discovery',icon:'üíé',title:{ru:'–ú–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–µ!',en:'Discovery!',de:'Entdeckung!'},desc:{ru:'–ì–µ–æ–ª–æ–≥–∏ –æ–±–Ω–∞—Ä—É–∂–∏–ª–∏ –æ–≥—Ä–æ–º–Ω—ã–µ –∑–∞–ª–µ–∂–∏ —Ä–µ—Å—É—Ä—Å–∞.',en:'Geologists discovered huge deposits.',de:'Geologen haben riesige Vorkommen entdeckt.'},choices:[{text:{ru:'–ù–∞—Ü–∏–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å',en:'Nationalize',de:'Verstaatlichen'},effects:{happiness:12,wealth:18,stability:5},cost:25,hydro:50},{text:{ru:'–ö–æ—Ä–ø–æ—Ä–∞—Ü–∏—è–º',en:'Corporations',de:'Konzerne'},effects:{wealth:30,happiness:-12},cost:5,hydro:30},{text:{ru:'–°–æ–∑–¥–∞—Ç—å —Ñ–æ–Ω–¥',en:'Create fund',de:'Fonds gr√ºnden'},effects:{stability:20,wealth:10,happiness:8},cost:15,hydro:25}]},
        {id:'drought',icon:'üèúÔ∏è',title:{ru:'–ó–∞—Å—É—Ö–∞',en:'Drought',de:'D√ºrre'},desc:{ru:'–î–æ–∂–¥—è –Ω–µ –±—ã–ª–æ –º–µ—Å—è—Ü. –§–µ—Ä–º–µ—Ä—ã —Å–º–æ—Ç—Ä—è—Ç –Ω–∞ –Ω–µ–±–æ.',en:'No rain for a month. Farmers stare at sky.',de:'Seit einem Monat kein Regen.'},choices:[{text:{ru:'–ù–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ–¥—ã',en:'Water rationing',de:'Wasserrationierung'},effects:{happiness:-15,stability:10},cost:10},{text:{ru:'–°—Ä–æ—á–Ω–∞—è –∏—Ä—Ä–∏–≥–∞—Ü–∏—è',en:'Emergency irrigation',de:'Notbew√§sserung'},effects:{wealth:-20,happiness:5,stability:5},cost:35},{text:{ru:'–ò–º–ø–æ—Ä—Ç –≤–æ–¥—ã',en:'Import water',de:'Wasser importieren'},effects:{wealth:-15,stability:-5},cost:25}]},
        {id:'techno_disaster',icon:'‚ò¢Ô∏è',title:{ru:'–¢–µ—Ö–Ω–æ–≥–µ–Ω–Ω–∞—è –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∞',en:'Industrial Disaster',de:'Industriekatastrophe'},desc:{ru:'–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ –Ω–∞ –∑–∞–≤–æ–¥–µ.',en:'Something went wrong at the factory.',de:'Etwas ist schiefgelaufen.'},choices:[{text:{ru:'–≠–≤–∞–∫—É–∞—Ü–∏—è',en:'Evacuation',de:'Evakuierung'},effects:{happiness:-10,wealth:-15,stability:15},cost:30},{text:{ru:'–°–∫—Ä—ã—Ç—å',en:'Hide',de:'Verbergen'},effects:{happiness:5,stability:-20},cost:10},{text:{ru:'–ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏',en:'Compensation',de:'Entsch√§digung'},effects:{happiness:10,wealth:-25},cost:40}]},
        {id:'infra_collapse',icon:'üåâ',title:{ru:'–ú–æ—Å—Ç —Ä—É—Ö–Ω—É–ª',en:'Bridge Collapsed',de:'Br√ºcke eingest√ºrzt'},desc:{ru:'–ú–æ—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π "–µ—â—ë —Å—Ç–æ –ª–µ—Ç –ø—Ä–æ—Å—Ç–æ–∏—Ç", –ø—Ä–æ—Å—Ç–æ—è–ª –¥–æ –≤—Ç–æ—Ä–Ω–∏–∫–∞.',en:'The bridge "meant to last 100 years" lasted until Tuesday.',de:'Die Br√ºcke hielt bis Dienstag.'},choices:[{text:{ru:'–°—Ä–æ—á–Ω—ã–π —Ä–µ–º–æ–Ω—Ç',en:'Emergency repair',de:'Notreparatur'},effects:{wealth:-20,stability:10},cost:35},{text:{ru:'–û–±—ä–µ–∑–¥',en:'Detour',de:'Umleitung'},effects:{happiness:-15,wealth:-5},cost:10},{text:{ru:'–ù–æ–≤—ã–π –º–æ—Å—Ç',en:'New bridge',de:'Neue Br√ºcke'},effects:{wealth:-30,happiness:15,stability:15},cost:50}]},
        {id:'journalism',icon:'üì∞',title:{ru:'–ñ—É—Ä–Ω–∞–ª–∏—Å—Ç—ã —Ä–∞—Å–∫–æ–ø–∞–ª–∏...',en:'Journalists uncovered...',de:'Journalisten aufgedeckt...'},desc:{ru:'–ù–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –∂—É—Ä–Ω–∞–ª–∏—Å—Ç—ã —Ä–∞—Å–∫–æ–ø–∞–ª–∏ —á—Ç–æ-—Ç–æ.',en:'Independent journalists uncovered something.',de:'Unabh√§ngige Journalisten haben etwas aufgedeckt.'},choices:[{text:{ru:'–ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–µ—Å—Å—É',en:'Support press',de:'Presse unterst√ºtzen'},effects:{happiness:15,stability:-10},cost:5},{text:{ru:'–ó–∞—Å–µ–∫—Ä–µ—Ç–∏—Ç—å',en:'Classify',de:'Klassifizieren'},effects:{stability:10,happiness:-15},cost:20},{text:{ru:'–î–∏—Å–∫—Ä–µ–¥–∏—Ç–∏—Ä–æ–≤–∞—Ç—å',en:'Discredit',de:'Diskreditieren'},effects:{happiness:-20,stability:5},cost:15}]},
        {id:'rumors',icon:'üó£Ô∏è',title:{ru:'–°–ª—É—Ö–∏',en:'Rumors',de:'Ger√ºchte'},desc:{ru:'–ö—Ç–æ-—Ç–æ –ø—É—Å—Ç–∏–ª —Å–ª—É—Ö. –ü–æ–ª–æ–≤–∏–Ω–∞ –∫–æ–ª–æ–Ω–∏–∏ –≤–µ—Ä–∏—Ç.',en:'Someone started a rumor. Half the colony believes it.',de:'Jemand hat ein Ger√ºcht gestreut.'},choices:[{text:{ru:'–û–ø—Ä–æ–≤–µ—Ä–∂–µ–Ω–∏–µ',en:'Denial',de:'Dementierung'},effects:{stability:5,happiness:-5},cost:5},{text:{ru:'–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å',en:'Transparency',de:'Transparenz'},effects:{happiness:20,stability:-10,wealth:-5},cost:15},{text:{ru:'–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å',en:'Ignore',de:'Ignorieren'},effects:{stability:-15},cost:0}]},
        {id:'diplomatic_scandal',icon:'ü§¶',title:{ru:'–î–∏–ø—Å–∫–∞–Ω–¥–∞–ª',en:'Diplomatic Scandal',de:'Diplomatischer Skandal'},desc:{ru:'–í–∞—à –ø–æ—Å–æ–ª —Å–∫–∞–∑–∞–ª —á—Ç–æ-—Ç–æ –Ω–µ —Ç–æ.',en:'Your ambassador said something wrong.',de:'Ihr Botschafter hat etwas Falsches gesagt.'},choices:[{text:{ru:'–ò–∑–≤–∏–Ω–∏—Ç—å—Å—è',en:'Apologize',de:'Entschuldigen'},effects:{happiness:-5,stability:10},cost:10},{text:{ru:'–°—Ç–æ—è—Ç—å –Ω–∞ —Å–≤–æ—ë–º',en:'Stand firm',de:'Standhaft bleiben'},effects:{happiness:10,stability:-15},cost:0},{text:{ru:'–û—Ç–æ–∑–≤–∞—Ç—å –ø–æ—Å–ª–∞',en:'Recall ambassador',de:'Botschafter zur√ºckrufen'},effects:{stability:5},cost:5}]},
        {id:'tech_breakthrough',icon:'üî¨',title:{ru:'–ù–∞—É—á–Ω—ã–π –ø—Ä–æ—Ä—ã–≤',en:'Scientific Breakthrough',de:'Durchbruch'},desc:{ru:'–£—á—ë–Ω—ã–µ —Å–æ–≤–µ—Ä—à–∏–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∏–µ.',en:'Scientists made a discovery.',de:'Wissenschaftler haben eine Entdeckung gemacht.'},choices:[{text:{ru:'–§–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ',en:'Funding',de:'Finanzierung'},effects:{wealth:20,happiness:12,stability:5},cost:30},{text:{ru:'–ü–æ–¥–µ–ª–∏—Ç—å—Å—è',en:'Share',de:'Teilen'},effects:{happiness:15,stability:8},cost:10},{text:{ru:'–ó–∞—Å–µ–∫—Ä–µ—Ç–∏—Ç—å',en:'Classify',de:'Geheim halten'},effects:{wealth:12,stability:-8},cost:8}]},
        {id:'festival',icon:'üéâ',title:{ru:'–ü—Ä–∞–∑–¥–Ω–∏–∫',en:'Festival',de:'Festival'},desc:{ru:'–ì–æ–¥–æ–≤—â–∏–Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏—è! –ì—Ä–∞–∂–¥–∞–Ω–µ –∂–¥—É—Ç –ø—Ä–∞–∑–¥–Ω–∏–∫–∞.',en:'Anniversary! Citizens expect celebration.',de:'Jahrestag! B√ºrger erwarten Feier.'},choices:[{text:{ru:'–ì—Ä–∞–Ω–¥–∏–æ–∑–Ω—ã–π',en:'Grand',de:'Gro√ü'},effects:{happiness:25,wealth:-15},cost:25},{text:{ru:'–°–∫—Ä–æ–º–Ω—ã–π',en:'Modest',de:'Bescheiden'},effects:{happiness:10,wealth:-5},cost:10},{text:{ru:'–†–∞–±–æ—á–∏–π –¥–µ–Ω—å',en:'Working day',de:'Arbeitstag'},effects:{happiness:-15,wealth:5},cost:0}]},
      ],
      parliamentary:[
        {id:'coalition',icon:'üíî',title:{ru:'–†–∞–∑–≤–∞–ª –∫–æ–∞–ª–∏—Ü–∏–∏',en:'Coalition Collapse',de:'Koalitionszerfall'},desc:{ru:'–ü–∞—Ä—Ç–∏–∏ –Ω–µ –º–æ–≥—É—Ç –¥–æ–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è.',en:'Parties can\'t agree.',de:'Parteien k√∂nnen sich nicht einigen.'},choices:[{text:{ru:'–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã',en:'Negotiate',de:'Verhandeln'},effects:{stability:-10,happiness:-5},cost:15},{text:{ru:'–ù–æ–≤–∞—è –∫–æ–∞–ª–∏—Ü–∏—è',en:'New coalition',de:'Neue Koalition'},effects:{stability:5,happiness:10},cost:20},{text:{ru:'–í—ã–±–æ—Ä—ã',en:'Elections',de:'Wahlen'},effects:{stability:-20,happiness:15},cost:30}]},
        {id:'lobbyists',icon:'üíº',title:{ru:'–õ–æ–±–±–∏—Å—Ç—ã',en:'Lobbyists',de:'Lobbyisten'},desc:{ru:'–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∑–∞–∫–æ–Ω—ã –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ –≤—ã–≥–æ–¥–Ω—ã –∫–æ–º–ø–∞–Ω–∏—è–º.',en:'Some laws suspiciously benefit companies.',de:'Einige Gesetze sind verd√§chtig vorteilhaft.'},choices:[{text:{ru:'–†–µ—Ñ–æ—Ä–º–∞',en:'Reform',de:'Reform'},effects:{happiness:20,wealth:-10,stability:5},cost:20},{text:{ru:'–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å',en:'Show trial',de:'Schauprozess'},effects:{happiness:10,stability:-5},cost:10},{text:{ru:'–ó–∞–º—è—Ç—å',en:'Cover up',de:'Vertuschen'},effects:{stability:-15,happiness:-10},cost:25}]},
        {id:'deadlock',icon:'üîí',title:{ru:'–¢—É–ø–∏–∫',en:'Deadlock',de:'Sackgasse'},desc:{ru:'–î–µ–ø—É—Ç–∞—Ç—ã –Ω–µ –º–æ–≥—É—Ç –¥–æ–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è —É–∂–µ –Ω–µ–¥–µ–ª—é.',en:'MPs can\'t agree for a week.',de:'Abgeordnete k√∂nnen sich nicht einigen.'},choices:[{text:{ru:'–í–º–µ—à–∞—Ç—å—Å—è',en:'Intervene',de:'Eingreifen'},effects:{stability:10,happiness:-10},cost:5},{text:{ru:'–ñ–¥–∞—Ç—å',en:'Wait',de:'Warten'},effects:{stability:-15,happiness:5},cost:0},{text:{ru:'–†–µ—Ñ–µ—Ä–µ–Ω–¥—É–º',en:'Referendum',de:'Referendum'},effects:{happiness:15,wealth:-10},cost:20}]}
      ],
      presidential:[
        {id:'impeachment',icon:'‚öñÔ∏è',title:{ru:'–ò–º–ø–∏—á–º–µ–Ω—Ç',en:'Impeachment',de:'Amtsenthebung'},desc:{ru:'–û–ø–ø–æ–∑–∏—Ü–∏—è —Å–æ–±—Ä–∞–ª–∞ –≥–æ–ª–æ—Å–∞ –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è.',en:'Opposition gathered votes.',de:'Opposition hat Stimmen gesammelt.'},choices:[{text:{ru:'–î–æ–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è',en:'Negotiate',de:'Verhandeln'},effects:{stability:10,happiness:-5,wealth:-10},cost:20},{text:{ru:'–ú–æ–±–∏–ª–∏–∑–æ–≤–∞—Ç—å',en:'Mobilize',de:'Mobilisieren'},effects:{happiness:15,stability:-10},cost:15},{text:{ru:'–ó–∞—â–∏—Ç–∞',en:'Defense',de:'Verteidigung'},effects:{stability:5,wealth:-15},cost:25}]},
        {id:'admin_scandal',icon:'üóûÔ∏è',title:{ru:'–°–∫–∞–Ω–¥–∞–ª',en:'Scandal',de:'Skandal'},desc:{ru:'–í–∞—à –ø–æ–º–æ—â–Ω–∏–∫ —Å–∫–∞–∑–∞–ª —á—Ç–æ-—Ç–æ –Ω–µ —Ç–æ.',en:'Your aide said something wrong.',de:'Ihr Berater hat etwas Falsches gesagt.'},choices:[{text:{ru:'–£–≤–æ–ª–∏—Ç—å',en:'Fire',de:'Entlassen'},effects:{stability:10,happiness:5},cost:5},{text:{ru:'–ó–∞—â–∏—Ç–∏—Ç—å',en:'Defend',de:'Verteidigen'},effects:{happiness:-10,stability:-5},cost:0},{text:{ru:'–û—Ç–≤–ª–µ—á—å',en:'Distract',de:'Ablenken'},effects:{happiness:-5,wealth:-10},cost:15}]},
        {id:'constitutional',icon:'üìú',title:{ru:'–ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏–æ–Ω–Ω—ã–π –∫—Ä–∏–∑–∏—Å',en:'Constitutional Crisis',de:'Verfassungskrise'},desc:{ru:'–°—É–¥ –∏ –ü–∞—Ä–ª–∞–º–µ–Ω—Ç –Ω–µ —Å–æ–≥–ª–∞—Å–Ω—ã —Å –≤–∞–º–∏.',en:'Court and Parliament disagree.',de:'Gericht und Parlament anderer Meinung.'},choices:[{text:{ru:'–£—Å—Ç—É–ø–∏—Ç—å',en:'Yield',de:'Nachgeben'},effects:{stability:15,happiness:-10},cost:0},{text:{ru:'–†–µ—Ñ–æ—Ä–º–∞',en:'Reform',de:'Reform'},effects:{stability:-15,happiness:10,wealth:-20},cost:30},{text:{ru:'–ö –Ω–∞—Ä–æ–¥—É',en:'To people',de:'Zum Volk'},effects:{happiness:20,stability:-10},cost:15}]}
      ],
      monarchy:[
        {id:'heir_scandal',icon:'üëë',title:{ru:'–°–∫–∞–Ω–¥–∞–ª –Ω–∞—Å–ª–µ–¥–Ω–∏–∫–∞',en:'Heir Scandal',de:'Erben-Skandal'},desc:{ru:'–ù–∞—Å–ª–µ–¥–Ω–∏–∫ –ø–æ—Å–µ—Ç–∏–ª —Å–æ–º–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ–¥–µ–Ω–∏–µ.',en:'Heir visited questionable place.',de:'Erbe besuchte fragw√ºrdigen Ort.'},choices:[{text:{ru:'–ò–∑–≤–∏–Ω–µ–Ω–∏–µ',en:'Apology',de:'Entschuldigung'},effects:{happiness:5,stability:10},cost:5},{text:{ru:'–ó–∞—â–∏—Ç–∏—Ç—å',en:'Defend',de:'Verteidigen'},effects:{happiness:-10,stability:-5},cost:0},{text:{ru:'–í "–æ—Ç–ø—É—Å–∫"',en:'"Vacation"',de:'"Urlaub"'},effects:{stability:15,happiness:-5},cost:20}]},
        {id:'succession',icon:'‚öîÔ∏è',title:{ru:'–ù–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ',en:'Succession',de:'Erbfolge'},desc:{ru:'–¢—Ä–∏ –ø—Ä–µ—Ç–µ–Ω–¥–µ–Ω—Ç–∞ –Ω–∞ —Ç—Ä–æ–Ω.',en:'Three claimants to the throne.',de:'Drei Thronpr√§tendenten.'},choices:[{text:{ru:'–°–æ–≤–µ—Ç',en:'Council',de:'Rat'},effects:{stability:15,happiness:-5},cost:10},{text:{ru:'–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ',en:'Vote',de:'Abstimmung'},effects:{happiness:20,stability:-15},cost:25},{text:{ru:'–ù–∞–∑–Ω–∞—á–∏—Ç—å',en:'Appoint',de:'Ernennen'},effects:{stability:-10,happiness:-10},cost:0}]},
        {id:'republicans',icon:'üóΩ',title:{ru:'–†–µ—Å–ø—É–±–ª–∏–∫–∞–Ω—Ü—ã',en:'Republicans',de:'Republikaner'},desc:{ru:'–ß–∞—Å—Ç—å –≥—Ä–∞–∂–¥–∞–Ω –ø—Ä–æ—Ç–∏–≤ –º–æ–Ω–∞—Ä—Ö–∏–∏.',en:'Some citizens against monarchy.',de:'Einige B√ºrger gegen Monarchie.'},choices:[{text:{ru:'–î–∏–∞–ª–æ–≥',en:'Dialogue',de:'Dialog'},effects:{happiness:10,stability:5},cost:10},{text:{ru:'–¢—Ä–∞–¥–∏—Ü–∏–∏',en:'Traditions',de:'Traditionen'},effects:{happiness:-5,stability:15},cost:15},{text:{ru:'–ó–∞–ø—Ä–µ—Ç–∏—Ç—å',en:'Ban',de:'Verbieten'},effects:{stability:-20,happiness:-15},cost:20}]}
      ],
      dictatorship:[
        {id:'generals',icon:'üéñÔ∏è',title:{ru:'–ó–∞–≥–æ–≤–æ—Ä –≥–µ–Ω–µ—Ä–∞–ª–æ–≤',en:'Generals\' Conspiracy',de:'Generalsverschw√∂rung'},desc:{ru:'–ì–µ–Ω–µ—Ä–∞–ª—ã —á–∞—Å—Ç–æ –æ–±–µ–¥–∞—é—Ç –≤–º–µ—Å—Ç–µ.',en:'Generals lunch together often.',de:'Gener√§le essen oft zusammen.'},choices:[{text:{ru:'–ê—Ä–µ—Å—Ç',en:'Arrest',de:'Verhaftung'},effects:{stability:20,happiness:-15},cost:20},{text:{ru:'–ü–µ—Ä–µ—Ç–∞—Å–æ–≤–∞—Ç—å',en:'Shuffle',de:'Umstrukturieren'},effects:{stability:10,happiness:-5},cost:10},{text:{ru:'–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å',en:'Ignore',de:'Ignorieren'},effects:{stability:-25},cost:0}]},
        {id:'cult',icon:'üóø',title:{ru:'–ö—É–ª—å—Ç –ª–∏—á–Ω–æ—Å—Ç–∏',en:'Personality Cult',de:'Personenkult'},desc:{ru:'–°—Ç–∞—Ç—É–π –±–æ–ª—å—à–µ, —á–µ–º –∂–∏—Ç–µ–ª–µ–π.',en:'More statues than residents.',de:'Mehr Statuen als Einwohner.'},choices:[{text:{ru:'–ï—â—ë –±–æ–ª—å—à–µ!',en:'Even more!',de:'Noch mehr!'},effects:{happiness:-20,stability:10,wealth:-15},cost:25},{text:{ru:'–£–º–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å',en:'Moderation',de:'M√§√üigung'},effects:{happiness:10,stability:-5},cost:0},{text:{ru:'–ú—É–∑–µ–∏',en:'Museums',de:'Museen'},effects:{happiness:15,wealth:-5},cost:10}]},
        {id:'resistance',icon:'üì¢',title:{ru:'–°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ',en:'Resistance',de:'Widerstand'},desc:{ru:'–õ–∏—Å—Ç–æ–≤–∫–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è –±—ã—Å—Ç—Ä–µ–µ, —á–µ–º –∏—Ö —Å–æ–±–∏—Ä–∞—é—Ç.',en:'Leaflets appear faster than collected.',de:'Flugbl√§tter erscheinen schneller.'},choices:[{text:{ru:'–†–µ–ø—Ä–µ—Å—Å–∏–∏',en:'Repression',de:'Repression'},effects:{stability:15,happiness:-25},cost:25},{text:{ru:'–ò–Ω—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è',en:'Infiltration',de:'Infiltration'},effects:{stability:10,happiness:-10,wealth:-10},cost:20},{text:{ru:'–†–µ—Ñ–æ—Ä–º—ã',en:'Reforms',de:'Reformen'},effects:{happiness:20,stability:-15},cost:15}]}
      ],
      technocracy:[
        {id:'algorithm',icon:'ü§ñ',title:{ru:'–ë—É–Ω—Ç –ø—Ä–æ—Ç–∏–≤ –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤',en:'Algorithm Revolt',de:'Algorithmus-Revolte'},desc:{ru:'–ì—Ä–∞–∂–¥–∞–Ω–µ –ø—Ä–æ—Ç–∏–≤ "–º–∞—à–∏–Ω".',en:'Citizens against "machines".',de:'B√ºrger gegen "Maschinen".'},choices:[{text:{ru:'–ì—É–º–∞–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å',en:'Humanize',de:'Humanisieren'},effects:{happiness:20,wealth:-10},cost:15},{text:{ru:'–û–±—ä—è—Å–Ω–∏—Ç—å',en:'Explain',de:'Erkl√§ren'},effects:{happiness:5,stability:5},cost:10},{text:{ru:'–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å',en:'Ignore',de:'Ignorieren'},effects:{happiness:-15,stability:-10},cost:0}]},
        {id:'data_leak',icon:'üíæ',title:{ru:'–£—Ç–µ—á–∫–∞ –¥–∞–Ω–Ω—ã—Ö',en:'Data Leak',de:'Datenleck'},desc:{ru:'–ö—Ç–æ-—Ç–æ —Å–ª–∏–ª –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.',en:'Someone leaked the database.',de:'Jemand hat Datenbank geleakt.'},choices:[{text:{ru:'–ê—É–¥–∏—Ç',en:'Audit',de:'Audit'},effects:{stability:15,wealth:-20},cost:30},{text:{ru:'–ù–∞–π—Ç–∏ –≤–∏–Ω–æ–≤–Ω–æ–≥–æ',en:'Find culprit',de:'Schuldigen finden'},effects:{stability:5,happiness:-5},cost:15},{text:{ru:'–ê–º–Ω–∏—Å—Ç–∏—è',en:'Amnesty',de:'Amnestie'},effects:{happiness:15,stability:-10},cost:5}]},
        {id:'experts',icon:'üî¨',title:{ru:'–≠–∫—Å–ø–µ—Ä—Ç—ã —Å–ø–æ—Ä—è—Ç',en:'Experts Disagree',de:'Experten uneinig'},desc:{ru:'–ö–ª–∏–º–∞—Ç vs —ç–∫–æ–Ω–æ–º–∏–∫–∞. 500 —Å—Ç—Ä–∞–Ω–∏—Ü —Å –∫–∞–∂–¥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã.',en:'Climate vs economy. 500 pages each side.',de:'Klima vs Wirtschaft. 500 Seiten pro Seite.'},choices:[{text:{ru:'–ö–ª–∏–º–∞—Ç',en:'Climate',de:'Klima'},effects:{happiness:10,wealth:-15,stability:5},cost:20},{text:{ru:'–≠–∫–æ–Ω–æ–º–∏–∫–∞',en:'Economy',de:'Wirtschaft'},effects:{wealth:15,happiness:-10,stability:5},cost:10},{text:{ru:'–ö–æ–º–∏—Å—Å–∏—è',en:'Commission',de:'Kommission'},effects:{stability:-10,wealth:-10},cost:15}]}
      ],
      direct:[
        {id:'fatigue',icon:'üò¥',title:{ru:'–£—Å—Ç–∞–ª–æ—Å—Ç—å',en:'Fatigue',de:'M√ºdigkeit'},desc:{ru:'–Ø–≤–∫–∞ 12%. –¢–µ–º–∞: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Ñ–µ—Ä–µ–Ω–¥—É–º—ã.',en:'Turnout 12%. Topic: mandatory referendums.',de:'Wahlbeteiligung 12%.'},choices:[{text:{ru:'–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ',en:'Mandatory',de:'Obligatorisch'},effects:{happiness:-15,stability:15},cost:20},{text:{ru:'–£–ø—Ä–æ—Å—Ç–∏—Ç—å',en:'Simplify',de:'Vereinfachen'},effects:{happiness:10,wealth:-10},cost:15},{text:{ru:'–ú–µ–Ω—å—à–µ',en:'Fewer',de:'Weniger'},effects:{happiness:5,stability:-10},cost:0}]},
        {id:'populist',icon:'üé™',title:{ru:'–ü–æ–ø—É–ª–∏–∑–º',en:'Populism',de:'Populismus'},desc:{ru:'–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ: –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–æ—Å–º–∏—á–µ—Å–∫–∏–π –∫–æ—Ä–∞–±–ª—å –∫–∞–∂–¥–æ–º—É.',en:'Vote: free spaceship for everyone.',de:'Abstimmung: kostenloses Raumschiff f√ºr jeden.'},choices:[{text:{ru:'–û–±—ä—è—Å–Ω–∏—Ç—å',en:'Explain',de:'Erkl√§ren'},effects:{happiness:-10,stability:10},cost:10},{text:{ru:'–ö–æ–º–ø—Ä–æ–º–∏—Å—Å',en:'Compromise',de:'Kompromiss'},effects:{happiness:15,wealth:-20},cost:25},{text:{ru:'–ü—É—Å—Ç—å –≥–æ–ª–æ—Å—É—é—Ç',en:'Let vote',de:'Abstimmen lassen'},effects:{stability:-15,happiness:5},cost:5}]},
        {id:'tie',icon:'‚öñÔ∏è',title:{ru:'50/50',en:'50/50',de:'50/50'},desc:{ru:'–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ 50.0% –Ω–∞ 50.0%. –ú–æ–Ω–µ—Ç–∫—É?',en:'Vote 50.0% to 50.0%. Flip coin?',de:'50,0% zu 50,0%. M√ºnze werfen?'},choices:[{text:{ru:'–ü–æ–≤—Ç–æ—Ä–∏—Ç—å',en:'Revote',de:'Erneut'},effects:{stability:-5,wealth:-10},cost:15},{text:{ru:'–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä —Ä–µ—à–∏—Ç',en:'Coordinator decides',de:'Koordinator entscheidet'},effects:{happiness:-10,stability:10},cost:0},{text:{ru:'–ö–æ–º–ø—Ä–æ–º–∏—Å—Å',en:'Compromise',de:'Kompromiss'},effects:{happiness:5,stability:5},cost:10}]}
      ]
    };

    // ===== DB HELPERS =====
    const db={
      async saveGameResult(userId,data){return await supabase.from('game_results').insert({user_id:userId,planet_name:data.planet,political_system:data.system,difficulty:data.difficulty,max_turns:data.maxTurns,turns_played:data.turn,final_happiness:Math.round(data.stats.happiness),final_wealth:Math.round(data.stats.wealth),final_stability:Math.round(data.stats.stability),final_hydrobite:data.hydrobite,is_victory:data.isVictory,victory_type:data.victoryType,score:data.score,duration_seconds:data.duration});},
      async getLeaderboard(limit=30){return await supabase.from('profiles').select('id,username,display_name,total_games,total_wins,highest_score').gt('total_games',0).order('highest_score',{ascending:false}).limit(limit);},
      async getUserAchievements(userId){return await supabase.from('user_achievements').select('*,achievements(*)').eq('user_id',userId);},
      async unlockAchievement(userId,achievementId){return await supabase.from('user_achievements').upsert({user_id:userId,achievement_id:achievementId},{onConflict:'user_id,achievement_id'});},
    };

    // ===== AUTH CONTEXT =====
    const AuthContext=createContext(null);
    const useAuth=()=>useContext(AuthContext);

    function AuthProvider({children}){
      const[user,setUser]=useState(null);
      const[profile,setProfile]=useState(null);
      const[loading,setLoading]=useState(true);
      const[initialized,setInitialized]=useState(false);

      const loadProfile=useCallback(async(userId)=>{
        try{const{data}=await supabase.from('profiles').select('*').eq('id',userId).single();if(data)setProfile(data);}catch(e){}
      },[]);

      useEffect(()=>{
        supabase.auth.getSession().then(({data:{session}})=>{
          const u=session?.user??null;setUser(u);if(u)loadProfile(u.id);setLoading(false);setInitialized(true);
        });
        const{data:{subscription}}=supabase.auth.onAuthStateChange(async(event,session)=>{
          const u=session?.user??null;setUser(u);if(u)await loadProfile(u.id);else setProfile(null);setLoading(false);
        });
        return()=>subscription.unsubscribe();
      },[loadProfile]);

      const signUp=async(email,password,username)=>{const{data,error}=await supabase.auth.signUp({email,password,options:{data:{username,full_name:username}}});if(error)throw error;return data;};
      const signIn=async(email,password)=>{const{data,error}=await supabase.auth.signInWithPassword({email,password});if(error)throw error;return data;};
      const signOut=async()=>{await supabase.auth.signOut();setUser(null);setProfile(null);};

      return(<AuthContext.Provider value={{user,profile,loading,initialized,signUp,signIn,signOut}}>{children}</AuthContext.Provider>);
    }

    // ===== LANG CONTEXT =====
    const LangContext=createContext({lang:'ru',setLang:()=>{},t:(k)=>k});
    const useLang=()=>useContext(LangContext);

    function LangProvider({children}){
      const[lang,setLang]=useState(()=>localStorage.getItem('lang')||'');
      const t=useCallback((path)=>{
        const keys=path.split('.');let val=T;
        for(const k of keys){val=val?.[k];if(!val)return path;}
        return val[lang]||val.ru||path;
      },[lang]);
      const changeLang=(l)=>{setLang(l);localStorage.setItem('lang',l);};
      return(<LangContext.Provider value={{lang,setLang:changeLang,t}}>{children}</LangContext.Provider>);
    }

    // ===== UI COMPONENTS =====
    const Spinner=({size='md'})=>{const s={sm:'w-5 h-5',md:'w-8 h-8',lg:'w-12 h-12'};return(<div className="flex justify-center py-4"><div className={`${s[size]} border-4 border-amber-500 border-t-transparent rounded-full animate-spin`}/></div>);};
    const Toast=({message,type='info',onClose})=>{useEffect(()=>{const t=setTimeout(onClose,3000);return()=>clearTimeout(t);},[onClose]);const colors={success:'bg-green-900/90 border-green-500 text-green-200',error:'bg-red-900/90 border-red-500 text-red-200',warning:'bg-yellow-900/90 border-yellow-500 text-yellow-200',info:'bg-blue-900/90 border-blue-500 text-blue-200'};return(<div className={`toast ${colors[type]} border px-4 py-3 rounded-lg shadow-lg animate-slideUp`}>{message}</div>);};
    const Modal=({children,onClose,title})=>(<div className="modal-overlay animate-fadeIn" onClick={onClose}><div className="bg-slate-800 rounded-xl max-w-md w-full max-h-[85vh] overflow-hidden border border-amber-500/30 animate-slideUp" onClick={e=>e.stopPropagation()}>{title&&(<div className="flex justify-between items-center p-4 border-b border-slate-700"><h2 className="text-lg font-display font-bold text-amber-400">{title}</h2><button onClick={onClose} className="text-gray-400 hover:text-white text-2xl">&times;</button></div>)}<div className="p-4 overflow-y-auto max-h-[calc(85vh-60px)]">{children}</div></div></div>);
    const StatBar=({label,value,icon,color})=>(<div className="mb-2"><div className="flex justify-between text-xs mb-1"><span className="text-amber-100/80">{icon} {label}</span><span className={`font-bold ${value<30?'text-red-400':value>70?'text-green-400':'text-amber-300'}`}>{Math.round(value)}%</span></div><div className="h-2 bg-slate-900 rounded overflow-hidden border border-amber-900/30"><div className={`h-full ${color} transition-all duration-500`} style={{width:`${Math.min(100,Math.max(0,value))}%`}}/></div></div>);
    const StarBackground=()=>{const stars=useMemo(()=>Array.from({length:50},(_,i)=>({id:i,left:Math.random()*100,top:Math.random()*100,size:Math.random()*2+1,delay:Math.random()*3})),[]);return(<div className="star-bg">{stars.map(s=>(<div key={s.id} className="star animate-pulse" style={{left:`${s.left}%`,top:`${s.top}%`,width:s.size,height:s.size,animationDelay:`${s.delay}s`}}/>))}</div>);};

    // ===== AUTH MODAL =====
    const AuthModal=({onClose,initialMode='login'})=>{
      const{signUp,signIn}=useAuth();const{t}=useLang();
      const[mode,setMode]=useState(initialMode);const[email,setEmail]=useState('');const[password,setPassword]=useState('');const[username,setUsername]=useState('');const[loading,setLoading]=useState(false);const[error,setError]=useState('');const[success,setSuccess]=useState('');
      const handleSubmit=async(e)=>{e.preventDefault();setLoading(true);setError('');setSuccess('');try{if(mode==='register'){await signUp(email,password,username);setSuccess('Check email!');}else{await signIn(email,password);onClose();}}catch(err){setError(err.message);}setLoading(false);};
      return(<Modal onClose={onClose} title={mode==='login'?t('ui.login'):t('ui.register')}><form onSubmit={handleSubmit} className="space-y-4">{mode==='register'&&(<input type="text" placeholder={t('ui.username')} value={username} onChange={e=>setUsername(e.target.value)} className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white" required/>)}<input type="email" placeholder={t('ui.email')} value={email} onChange={e=>setEmail(e.target.value)} className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white" required/><input type="password" placeholder={t('ui.password')} value={password} onChange={e=>setPassword(e.target.value)} className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white" required minLength={6}/>{error&&<p className="text-red-400 text-sm">{error}</p>}{success&&<p className="text-green-400 text-sm">{success}</p>}<button type="submit" disabled={loading} className="w-full py-3 bg-gradient-to-r from-amber-500 to-yellow-500 text-slate-900 rounded-lg font-bold disabled:opacity-50">{loading?'...':mode==='login'?t('ui.login'):t('ui.register')}</button><p className="text-center text-sm text-gray-400">{mode==='login'?<span>No account? <button type="button" onClick={()=>setMode('register')} className="text-amber-400">Register</button></span>:<span>Have account? <button type="button" onClick={()=>setMode('login')} className="text-amber-400">Login</button></span>}</p></form></Modal>);
    };

    // ===== PROFILE MODAL =====
    const ProfileModal=({onClose})=>{
      const{profile,signOut}=useAuth();const{t}=useLang();
      return(<Modal onClose={onClose} title={t('ui.profile')||'Profile'}><div className="text-center mb-4"><div className="w-16 h-16 bg-amber-600 rounded-full flex items-center justify-center text-2xl font-bold mx-auto mb-2">{profile?.display_name?.[0]?.toUpperCase()||'üë§'}</div><h3 className="font-bold text-lg text-amber-300">{profile?.display_name||'Player'}</h3>{profile?.is_premium&&<span className="text-amber-400 text-sm">‚≠ê Premium</span>}</div><div className="space-y-2 text-sm mb-4"><div className="flex justify-between"><span className="text-gray-400">Games:</span><span className="text-amber-300">{profile?.total_games||0}</span></div><div className="flex justify-between"><span className="text-gray-400">Wins:</span><span className="text-amber-300">{profile?.total_wins||0}</span></div><div className="flex justify-between"><span className="text-gray-400">Best:</span><span className="text-amber-300">{profile?.highest_score||0}</span></div></div><div className="flex gap-2"><button onClick={onClose} className="flex-1 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg">{t('ui.close')}</button><button onClick={()=>{signOut();onClose();}} className="flex-1 py-2 bg-red-900/50 hover:bg-red-800/50 text-red-300 rounded-lg">{t('ui.signOut')}</button></div></Modal>);
    };

    // ===== LEADERBOARD MODAL =====
    const LeaderboardModal=({onClose})=>{
      const[leaders,setLeaders]=useState([]);const[loading,setLoading]=useState(true);
      useEffect(()=>{db.getLeaderboard(20).then(({data})=>{setLeaders(data||[]);setLoading(false);});},[]);
      return(<Modal onClose={onClose} title="üèÜ Leaderboard">{loading?<Spinner/>:(<div className="space-y-2">{leaders.length===0?<p className="text-center text-gray-400 py-8">No results</p>:leaders.map((p,i)=>(<div key={p.id} className={`flex items-center gap-3 p-3 rounded-lg ${i<3?'bg-gradient-to-r from-amber-900/40 to-transparent':'bg-slate-700/30'}`}><span className="text-xl font-bold w-8 text-center">{i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':`${i+1}`}</span><div className="flex-1"><p className="font-bold text-amber-100 truncate">{p.display_name||p.username||'Player'}</p><p className="text-xs text-gray-400">{p.total_wins}/{p.total_games}</p></div><p className="text-lg font-bold text-amber-400">{p.highest_score}</p></div>))}</div>)}</Modal>);
    };

    // ===== PREMIUM MODAL =====
    const PremiumModal=({onClose})=>{
      const{user}=useAuth();const{t}=useLang();const[loading,setLoading]=useState(false);const[promo,setPromo]=useState('');const[error,setError]=useState('');
      const handlePurchase=async()=>{if(!user){setError('Login first');return;}setLoading(true);setError('');try{const res=await fetch('/.netlify/functions/create-checkout',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:user.id,userEmail:user.email,promo:promo.trim()||undefined})});const data=await res.json();if(data.error)setError(data.error);else if(data.url)window.location.href=data.url;}catch(e){setError('Error');}setLoading(false);};
      const features=['üèõÔ∏è 6 political systems','üèÜ All achievements','üìä Extended stats','üö´ No ads','üíæ Cloud saves'];
      return(<Modal onClose={onClose} title="‚≠ê Premium"><div className="text-center mb-4"><div className="text-4xl font-bold text-amber-400 mb-1">{t('ui.premiumPrice')}</div></div><div className="bg-slate-700/30 rounded-lg p-4 mb-4 space-y-2">{features.map((f,i)=>(<div key={i} className="text-gray-300">{f}</div>))}</div><input type="text" placeholder="Promo code" value={promo} onChange={e=>setPromo(e.target.value)} className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white mb-4"/>{error&&<p className="text-red-400 text-sm mb-2">{error}</p>}<button onClick={handlePurchase} disabled={loading} className="w-full py-3 bg-gradient-to-r from-amber-500 to-yellow-500 text-slate-900 rounded-lg font-bold disabled:opacity-50">{loading?'...':'Subscribe'}</button></Modal>);
    };

    // ===== MAIN GAME =====
    function Game(){
      const{user,profile,loading:authLoading,initialized}=useAuth();
      const{lang,setLang,t}=useLang();

      const[phase,setPhase]=useState('lang');
      const[turn,setTurn]=useState(1);
      const[maxTurns,setMaxTurns]=useState(15);
      const[difficulty,setDifficulty]=useState('normal');
      const[stats,setStats]=useState({happiness:60,wealth:50,stability:70});
      const[hydrobite,setHydrobite]=useState(100);
      const[budget,setBudget]=useState({defence:20,education:20,health:20,infra:20,welfare:20});
      const[system,setSystem]=useState('parliamentary');
      const[planetId,setPlanetId]=useState('terranova');
      const[event,setEvent]=useState(null);
      const[eventQueue,setEventQueue]=useState([]);
      const[usedEvents,setUsedEvents]=useState([]);
      const[finalScore,setFinalScore]=useState(0);
      const[victoryType,setVictoryType]=useState(null);
      const[eventsPerTurn,setEventsPerTurn]=useState(1);
      const[targetHappiness,setTargetHappiness]=useState(70);
      const[targetWealth,setTargetWealth]=useState(70);
      const[targetStability,setTargetStability]=useState(70);
      const[showAdvanced,setShowAdvanced]=useState(false);

      const[showAuth,setShowAuth]=useState(false);
      const[showProfile,setShowProfile]=useState(false);
      const[showLeaderboard,setShowLeaderboard]=useState(false);
      const[showPremium,setShowPremium]=useState(false);
      const[toast,setToast]=useState(null);
      const[introStep,setIntroStep]=useState(0);

      const sys=SYSTEMS[system];
      const planet=PLANETS[planetId];
      const diff=DIFFICULTIES[difficulty];
      const totalBudget=Object.values(budget).reduce((a,b)=>a+b,0);
      const remaining=hydrobite-totalBudget;
      const isPremium=profile?.is_premium||false;

      useEffect(()=>{
        const params=new URLSearchParams(window.location.search);
        if(params.get('success')==='true'){window.history.replaceState({},'','/');setToast({message:'‚úÖ Payment successful!',type:'success'});setTimeout(()=>window.location.reload(),2000);}
        else if(params.get('canceled')==='true'){window.history.replaceState({},'','/');setToast({message:'Payment canceled',type:'warning'});}
      },[]);

      useEffect(()=>{if(lang)setPhase('title');},[lang]);

      const showToast=useCallback((message,type='info')=>setToast({message,type}),[]);

      const calculateScore=useCallback((s,t,isVictory)=>{
        let score=Math.floor((s.happiness+s.wealth+s.stability)/3);
        score+=t*2;if(isVictory)score+=20;
        if(difficulty==='hard')score+=15;if(difficulty==='easy')score-=10;
        return Math.max(0,score);
      },[difficulty]);

      const endGame=useCallback(async(isVictory,vType=null)=>{
        const score=calculateScore(stats,turn,isVictory);
        setFinalScore(score);setVictoryType(vType);
        if(user){
          const gameData={planet:T.planets[planetId].name[lang],system,difficulty,maxTurns,turn,stats,hydrobite,isVictory,victoryType:vType,score,duration:0};
          await db.saveGameResult(user.id,gameData);
        }
        setPhase(isVictory?'victory':'gameover');
      },[user,planetId,system,difficulty,maxTurns,turn,stats,hydrobite,lang,calculateScore]);

      const startGame=useCallback(()=>{
        if(!isPremium&&SYSTEMS[system].premium){showToast('üîí Premium required!','warning');return;}
        const d=DIFFICULTIES[difficulty];const p=PLANETS[planetId];const s=SYSTEMS[system];
        setStats({happiness:Math.max(10,Math.min(90,p.stats.happiness+d.bonus-(s.traits.startPenalty||0))),wealth:Math.max(10,Math.min(90,p.stats.wealth+d.bonus)),stability:Math.max(10,Math.min(90,p.stats.stability+d.bonus+s.traits.stabilityBonus))});
        setHydrobite(100+d.hydroBonus);setTurn(1);setBudget({defence:20,education:20,health:20,infra:20,welfare:20});setUsedEvents([]);setEventQueue([]);setPhase('playing');
      },[system,difficulty,planetId,isPremium,showToast]);

      const getRandomEvents=useCallback((count)=>{
        const general=[...EVENTS.general];const specific=EVENTS[system]||[];const all=[...general,...specific];
        let available=all.filter(e=>!usedEvents.includes(e.id));if(available.length<count){setUsedEvents([]);available=all;}
        const selected=[];for(let i=0;i<count&&available.length>0;i++){const idx=Math.floor(Math.random()*available.length);selected.push(available[idx]);available.splice(idx,1);}
        return selected;
      },[system,usedEvents]);

      const processTurn=useCallback(()=>{
        if(remaining<0){showToast('‚ùå Budget exceeded!','error');return;}
        if(sys.traits.needsApproval&&stats.happiness<sys.traits.threshold){if(Math.random()>0.4){showToast('üèõÔ∏è Parliament rejected!','warning');return;}}
        if(sys.traits.referendumChance&&Math.random()<sys.traits.referendumChance){showToast('üó≥Ô∏è Referendum!','info');}

        const d=DIFFICULTIES[difficulty];
        let changes={happiness:(budget.welfare*0.35)+(budget.health*0.25)+(budget.education*0.15)-12-sys.traits.happinessDecay-(planet.mods.happinessDecay||0),wealth:(budget.infra*0.4)+(budget.education*0.25)-10+sys.traits.wealthBonus,stability:(budget.defence*0.35)+(budget.infra*0.1)-5-(planet.mods.stabilityDecay||0)};
        Object.keys(changes).forEach(k=>{if(changes[k]<0)changes[k]*=d.severity;});
        const newStats={happiness:Math.max(0,Math.min(100,stats.happiness+changes.happiness)),wealth:Math.max(0,Math.min(100,stats.wealth+changes.wealth)),stability:Math.max(0,Math.min(100,stats.stability+changes.stability))};
        setStats(newStats);setHydrobite(Math.floor(80+newStats.wealth*0.3+d.hydroBonus*0.5));

        const eventCount=eventsPerTurn+(planet.mods.extraEvents||0);
        const events=getRandomEvents(eventCount);
        setUsedEvents(prev=>[...prev,...events.map(e=>e.id)]);
        setEventQueue(events);
        if(events.length>0){setEvent(events[0]);setEventQueue(events.slice(1));setPhase('event');}
        else{setTurn(t=>t+1);setPhase('playing');}
      },[remaining,sys,stats,difficulty,budget,planet,eventsPerTurn,getRandomEvents,showToast]);

      const handleChoice=useCallback((choice)=>{
        const d=DIFFICULTIES[difficulty];let newStats={...stats};
        Object.entries(choice.effects).forEach(([k,v])=>{if(newStats[k]!==undefined){const effectValue=v<0?v*d.severity:v;newStats[k]=Math.max(0,Math.min(100,newStats[k]+effectValue));}});
        let newHydro=hydrobite-choice.cost+(choice.hydro||0);setHydrobite(Math.max(0,newHydro));setStats(newStats);

        if(sys.traits.rebellionRisk&&newStats.happiness<sys.traits.rebellionRisk&&Math.random()<0.3){showToast(t('defeat.rebellion'),'error');setTimeout(()=>endGame(false,'rebellion'),1000);return;}
        if(sys.traits.coupRisk&&newStats.stability<sys.traits.coupRisk&&Math.random()<0.3){showToast(t('defeat.coup'),'error');setTimeout(()=>endGame(false,'coup'),1000);return;}
        if(newStats.stability<=0){endGame(false,'stability');return;}
        if(newStats.happiness<=0){endGame(false,'happiness');return;}
        if(turn>=maxTurns&&newStats.happiness>=targetHappiness&&newStats.wealth>=targetWealth&&newStats.stability>=targetStability){endGame(true,'survival');return;}
        if(newStats.happiness>=95){endGame(true,'utopia');return;}
        if(newStats.wealth>=95){endGame(true,'prosperity');return;}

        if(eventQueue.length>0){setEvent(eventQueue[0]);setEventQueue(q=>q.slice(1));}
        else{setTurn(t=>t+1);setEvent(null);setPhase('playing');}
      },[difficulty,stats,hydrobite,sys,turn,maxTurns,eventQueue,targetHappiness,targetWealth,targetStability,endGame,showToast,t]);

      const handleBudget=useCallback((sector,val)=>{setBudget(prev=>({...prev,[sector]:Math.max(0,Math.min(50,parseInt(val)||0))}));},[]);

      // ===== RENDERS =====
      if(!initialized||authLoading){return(<div className="min-h-screen bg-slate-950 flex items-center justify-center"><Spinner size="lg"/></div>);}

      // LANG SELECT
      if(phase==='lang'){
        return(<div className="min-h-screen bg-slate-950 text-white flex items-center justify-center p-4"><StarBackground/><div className="text-center relative z-10 animate-fadeIn"><h1 className="text-4xl font-display font-bold gold-gradient mb-8">INDEPENDENCE</h1><p className="text-gray-400 mb-6">{T.ui.selectLanguage.ru}</p><div className="space-y-3">{[{id:'ru',flag:'üá∑üá∫',name:'–†—É—Å—Å–∫–∏–π'},{id:'en',flag:'üá¨üáß',name:'English'},{id:'de',flag:'üá©üá™',name:'Deutsch'}].map(l=>(<button key={l.id} onClick={()=>{setLang(l.id);setPhase('intro');}} className="w-full max-w-xs mx-auto flex items-center justify-center gap-3 py-4 bg-slate-800/50 border border-amber-500/30 rounded-xl hover:bg-slate-700/50 text-lg"><span className="text-2xl">{l.flag}</span><span>{l.name}</span></button>))}</div></div></div>);
      }

      // INTRO
      if(phase==='intro'){
        const steps=[{title:t('intro.title'),text:t('intro.p1')},{text:t('intro.p2')},{text:t('intro.p3')},{text:t('intro.mission'),isLast:true}];
        const step=steps[introStep];
        return(<div className="min-h-screen bg-slate-950 text-white p-6 flex items-center justify-center"><StarBackground/><div className="max-w-lg mx-auto text-center relative z-10 animate-fadeIn"><div className="bg-slate-800/50 border border-amber-500/30 rounded-2xl p-8">{step.title&&<h2 className="text-2xl font-display text-amber-400 mb-6">{step.title}</h2>}<p className="text-lg text-gray-300 leading-relaxed mb-8">{step.text}</p><div className="flex gap-4">{introStep>0&&<button onClick={()=>setIntroStep(s=>s-1)} className="flex-1 py-3 bg-slate-700 hover:bg-slate-600 rounded-lg">{t('ui.back')}</button>}<button onClick={()=>{if(step.isLast)setPhase('title');else setIntroStep(s=>s+1);}} className="flex-1 py-3 bg-gradient-to-r from-amber-500 to-yellow-500 text-slate-900 rounded-lg font-bold">{step.isLast?t('ui.startGame'):t('ui.next')}</button></div><div className="flex justify-center gap-2 mt-6">{steps.map((_,i)=>(<div key={i} className={`w-2 h-2 rounded-full ${i===introStep?'bg-amber-500':'bg-slate-600'}`}/>))}</div></div><button onClick={()=>setPhase('title')} className="mt-4 text-gray-500 hover:text-gray-400 text-sm">{t('ui.skip')}</button></div></div>);
      }

      // TITLE
      if(phase==='title'){
        return(<div className="min-h-screen bg-slate-950 text-white p-4 relative"><StarBackground/><div className="max-w-md mx-auto pt-4 relative z-10">
          <div className="flex justify-between items-center mb-4"><div className="flex gap-2"><button onClick={()=>setShowLeaderboard(true)} className="p-2 bg-slate-800/50 rounded-lg hover:bg-slate-700">üèÜ</button>{!isPremium&&<button onClick={()=>setShowPremium(true)} className="px-3 py-2 bg-gradient-to-r from-amber-500 to-yellow-500 text-slate-900 rounded-lg text-sm font-bold">‚≠ê Premium</button>}</div>{user?<button onClick={()=>setShowProfile(true)} className="flex items-center gap-2 px-3 py-2 bg-slate-800/50 rounded-full hover:bg-slate-700"><div className="w-6 h-6 bg-amber-600 rounded-full flex items-center justify-center text-xs font-bold">{profile?.display_name?.[0]?.toUpperCase()||'üë§'}</div><span className="text-sm text-amber-300">{profile?.display_name||'Profile'}</span>{profile?.is_premium&&<span className="text-amber-400">‚≠ê</span>}</button>:<button onClick={()=>setShowAuth(true)} className="px-4 py-2 bg-amber-600 hover:bg-amber-500 rounded-full text-sm font-bold">{t('ui.login')}</button>}</div>

          <div className="text-center mb-6"><h1 className="text-4xl sm:text-5xl font-display font-bold gold-gradient mb-2">{t('ui.title')}</h1><p className="text-amber-200/60 text-sm tracking-widest">{t('ui.subtitle')}</p></div>

          <div className="mb-4"><label className="text-sm text-gray-400 block mb-2">üåç {t('ui.choosePlanet')}</label><div className="grid grid-cols-5 gap-2">{Object.entries(PLANETS).map(([id,p])=>(<button key={id} onClick={()=>setPlanetId(id)} className={`p-2 rounded-lg border text-center transition ${planetId===id?'border-amber-500 bg-amber-500/20':'border-slate-600 hover:border-slate-500'}`}><span className="text-2xl block">{p.icon}</span><span className="text-xs text-gray-400">{'‚òÖ'.repeat(p.difficulty)}</span></button>))}</div><p className="text-sm text-gray-400 mt-2 text-center">{T.planets[planetId].name[lang]} ‚Äî {T.planets[planetId].traits[lang]}</p></div>

          <div className="mb-4"><label className="text-sm text-gray-400 block mb-1">üìä {t('ui.difficulty')}</label><div className="grid grid-cols-3 gap-2">{Object.entries(DIFFICULTIES).map(([key,d])=>(<button key={key} onClick={()=>setDifficulty(key)} className={`py-3 rounded-lg border text-sm transition ${difficulty===key?'border-amber-500 bg-amber-500/20 text-amber-300':'border-slate-600 text-gray-400 hover:border-slate-500'}`}>{d.icon} {t(`ui.${key}`)}</button>))}</div></div>

          <div className="mb-4"><label className="text-sm text-gray-400 block mb-1">‚è±Ô∏è {t('ui.gameLength')}: {maxTurns} {t('ui.years')}</label><input type="range" min="10" max="30" step="5" value={maxTurns} onChange={e=>setMaxTurns(parseInt(e.target.value))} className="w-full" style={{background:`linear-gradient(90deg,#d97706 ${(maxTurns-10)/20*100}%,#1e293b ${(maxTurns-10)/20*100}%)`}}/></div>

          <div className="mb-4"><label className="text-sm text-gray-400 block mb-1">üèõÔ∏è {t('ui.politicalSystem')}</label><div className="grid grid-cols-2 gap-2">{Object.entries(SYSTEMS).map(([id,s])=>(<button key={id} onClick={()=>setSystem(id)} className={`p-3 rounded-lg border text-left transition ${system===id?'border-amber-500 bg-amber-500/10':'border-slate-600 hover:border-slate-500'} ${s.premium&&!isPremium?'opacity-60':''}`}><div className="flex items-center gap-2"><span className="text-xl">{s.icon}</span><span className="text-sm font-bold text-amber-200">{T.systems[id].name[lang]}</span>{s.premium&&!isPremium&&<span className="text-xs bg-amber-500/20 text-amber-400 px-1 rounded">‚≠ê</span>}</div></button>))}</div></div>

          <button onClick={()=>setShowAdvanced(!showAdvanced)} className="w-full text-sm text-gray-400 hover:text-gray-300 mb-4">{showAdvanced?'‚ñ≤':'‚ñº'} {t('ui.advancedSettings')}</button>

          {showAdvanced&&(<div className="bg-slate-800/50 rounded-lg p-4 mb-4 space-y-4">
            <div><label className="text-sm text-gray-400">{t('ui.eventsPerTurn')}: {eventsPerTurn}</label><input type="range" min="1" max="4" value={eventsPerTurn} onChange={e=>setEventsPerTurn(parseInt(e.target.value))} className="w-full"/></div>
            <div><label className="text-sm text-gray-400">{t('ui.target')} {t('ui.happiness')}: {targetHappiness}%</label><input type="range" min="50" max="90" step="5" value={targetHappiness} onChange={e=>setTargetHappiness(parseInt(e.target.value))} className="w-full"/></div>
            <div><label className="text-sm text-gray-400">{t('ui.target')} {t('ui.wealth')}: {targetWealth}%</label><input type="range" min="50" max="90" step="5" value={targetWealth} onChange={e=>setTargetWealth(parseInt(e.target.value))} className="w-full"/></div>
            <div><label className="text-sm text-gray-400">{t('ui.target')} {t('ui.stability')}: {targetStability}%</label><input type="range" min="50" max="90" step="5" value={targetStability} onChange={e=>setTargetStability(parseInt(e.target.value))} className="w-full"/></div>
          </div>)}

          <button onClick={startGame} className="w-full py-4 bg-gradient-to-r from-amber-500 via-yellow-500 to-amber-500 text-slate-900 rounded-xl font-display font-bold text-lg hover:from-amber-400 hover:to-yellow-400">{t('ui.startGame')}</button>
        </div>
        {showAuth&&<AuthModal onClose={()=>setShowAuth(false)}/>}
        {showProfile&&<ProfileModal onClose={()=>setShowProfile(false)}/>}
        {showLeaderboard&&<LeaderboardModal onClose={()=>setShowLeaderboard(false)}/>}
        {showPremium&&<PremiumModal onClose={()=>setShowPremium(false)}/>}
        {toast&&<Toast message={toast.message} type={toast.type} onClose={()=>setToast(null)}/>}
        </div>);
      }

      // PLAYING
      if(phase==='playing'){
        return(<div className="min-h-screen bg-slate-950 text-white p-4"><StarBackground/><div className="max-w-md mx-auto relative z-10">
          <div className="flex justify-between items-center mb-4"><div className="flex items-center gap-2"><span className="text-2xl">{sys.icon}</span><span className="text-amber-300 font-bold">{T.systems[system].leader[lang]}</span></div><div className="text-right"><span className="text-amber-400 font-display">{t('ui.year')} {turn}/{maxTurns}</span><p className="text-xs text-gray-500">{T.planets[planetId].name[lang]}</p></div></div>

          <div className="bg-slate-800/50 rounded-xl p-4 border border-amber-500/20 mb-4">
            <StatBar label={t('ui.happiness')} value={stats.happiness} icon="üòä" color="bg-gradient-to-r from-green-600 to-green-400"/>
            <StatBar label={t('ui.wealth')} value={stats.wealth} icon="üí∞" color="bg-gradient-to-r from-yellow-600 to-yellow-400"/>
            <StatBar label={t('ui.stability')} value={stats.stability} icon="‚öñÔ∏è" color="bg-gradient-to-r from-blue-600 to-blue-400"/>
            <div className="flex justify-between items-center mt-3 pt-3 border-t border-slate-700"><span className="text-amber-200/80">üíé {t('ui.budget')}</span><span className={`font-bold ${remaining<0?'text-red-400':'text-amber-300'}`}>{hydrobite} ({remaining>=0?'+':''}{remaining})</span></div>
          </div>

          <div className="bg-slate-800/50 rounded-xl p-4 border border-amber-500/20 mb-4">{SECTORS.map(sec=>(<div key={sec.id} className="mb-3"><div className="flex justify-between text-sm mb-1"><span className="text-amber-100/80">{sec.icon} {T.sectors[sec.id].name[lang]}</span><span className="text-amber-300 font-bold">{budget[sec.id]}</span></div><input type="range" min="0" max="50" value={budget[sec.id]} onChange={e=>handleBudget(sec.id,e.target.value)} className="w-full" style={{background:`linear-gradient(90deg,#d97706 ${budget[sec.id]*2}%,#1e293b ${budget[sec.id]*2}%)`}}/></div>))}</div>

          <button onClick={processTurn} disabled={remaining<0} className="w-full py-4 bg-gradient-to-r from-amber-500 to-yellow-500 text-slate-900 rounded-xl font-bold text-lg disabled:opacity-50">{t('ui.submit')}</button>
        </div>{toast&&<Toast message={toast.message} type={toast.type} onClose={()=>setToast(null)}/>}</div>);
      }

      // EVENT
      if(phase==='event'&&event){
        return(<div className="min-h-screen bg-slate-950 text-white p-4 flex items-center justify-center"><StarBackground/><div className="max-w-md w-full relative z-10 animate-slideUp"><div className="bg-slate-800 rounded-2xl border border-amber-500/30 overflow-hidden"><div className="bg-gradient-to-r from-amber-900/50 to-slate-800 p-6 text-center"><span className="text-5xl block mb-2">{event.icon}</span><h2 className="text-xl font-display font-bold text-amber-400">{event.title[lang]}</h2></div><div className="p-6"><p className="text-gray-300 text-center mb-6">{event.desc[lang]}</p><div className="space-y-3">{event.choices.map((choice,i)=>(<button key={i} onClick={()=>handleChoice(choice)} className="w-full p-4 bg-slate-700/50 hover:bg-slate-600/50 border border-slate-600 hover:border-amber-500/50 rounded-xl text-left transition"><div className="flex justify-between items-start mb-1"><span className="font-bold text-amber-200">{choice.text[lang]}</span><span className="text-amber-400 text-sm">-{choice.cost}üíé</span></div><div className="flex gap-2 mt-2 text-xs">{Object.entries(choice.effects).map(([k,v])=>(<span key={k} className={v>=0?'text-green-400':'text-red-400'}>{k==='happiness'?'üòä':k==='wealth'?'üí∞':'‚öñÔ∏è'}{v>=0?'+':''}{v}</span>))}</div></button>))}</div></div></div></div></div>);
      }

      // VICTORY
      if(phase==='victory'){
        return(<div className="min-h-screen bg-slate-950 text-white p-4 flex items-center justify-center"><StarBackground/><div className="max-w-md w-full text-center relative z-10 animate-slideUp"><div className="bg-gradient-to-b from-amber-900/50 to-slate-800 rounded-2xl border border-amber-500/50 p-8"><span className="text-6xl block mb-4">üèÜ</span><h1 className="text-3xl font-display font-bold gold-gradient mb-4">{t('ui.victory')}</h1><p className="text-amber-200 mb-6">{T.victoryMsg[victoryType||'survival']?.[lang]}</p><div className="bg-slate-800/50 rounded-xl p-4 mb-6"><div className="text-4xl font-bold text-amber-400 mb-2">{finalScore}</div><p className="text-gray-400">{t('ui.score')}</p></div><div className="grid grid-cols-3 gap-4 mb-6"><div className="text-center"><span className="text-2xl">üòä</span><p className="text-lg font-bold text-green-400">{Math.round(stats.happiness)}%</p></div><div className="text-center"><span className="text-2xl">üí∞</span><p className="text-lg font-bold text-yellow-400">{Math.round(stats.wealth)}%</p></div><div className="text-center"><span className="text-2xl">‚öñÔ∏è</span><p className="text-lg font-bold text-blue-400">{Math.round(stats.stability)}%</p></div></div><button onClick={()=>{setPhase('title');setIntroStep(0);}} className="w-full py-4 bg-gradient-to-r from-amber-500 to-yellow-500 text-slate-900 rounded-xl font-bold">{t('ui.playAgain')}</button></div></div></div>);
      }

      // GAMEOVER
      if(phase==='gameover'){
        return(<div className="min-h-screen bg-slate-950 text-white p-4 flex items-center justify-center"><StarBackground/><div className="max-w-md w-full text-center relative z-10 animate-slideUp"><div className="bg-gradient-to-b from-red-900/50 to-slate-800 rounded-2xl border border-red-500/50 p-8"><span className="text-6xl block mb-4">üíÄ</span><h1 className="text-3xl font-display font-bold text-red-400 mb-4">{t('ui.defeat')}</h1><p className="text-red-200 mb-6">{T.defeat[victoryType||'stability']?.[lang]}</p><div className="bg-slate-800/50 rounded-xl p-4 mb-6"><p className="text-gray-400">{t('ui.year')} {turn} / {maxTurns}</p><p className="text-2xl font-bold text-red-400">{finalScore} {t('ui.score')}</p></div><button onClick={()=>{setPhase('title');setIntroStep(0);}} className="w-full py-4 bg-gradient-to-r from-red-600 to-red-500 text-white rounded-xl font-bold">{t('ui.playAgain')}</button></div></div></div>);
      }
      return null;
    }

    function App(){return(<AuthProvider><LangProvider><Game/></LangProvider></AuthProvider>);}
    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
  <script>if('serviceWorker' in navigator){navigator.serviceWorker.getRegistrations().then(r=>r.forEach(r=>r.unregister()));caches.keys().then(k=>k.forEach(k=>caches.delete(k)));}</script>
</body>
</html>
