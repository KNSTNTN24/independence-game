<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#d97706">
  <meta name="description" content="Independence - Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ¸Ğ³Ñ€Ğ° Ğ¾ Ğ¿Ğ¾Ğ»Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… ÑĞ¸ÑÑ‚ĞµĞ¼Ğ°Ñ…">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Independence">
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/svg+xml" href="/icon-192.svg">
  <title>Independence - Civic Education Game</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Raleway:wght@300;400;600;700&display=swap');
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{margin:0;padding:0;font-family:'Raleway',sans-serif;background:#0f172a;overscroll-behavior:none}
    .safe-top{padding-top:env(safe-area-inset-top)}.safe-bottom{padding-bottom:env(safe-area-inset-bottom)}
    .font-display{font-family:'Cinzel',serif}
    .gold-gradient{background:linear-gradient(180deg,#fbbf24 0%,#d97706 50%,#92400e 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    input[type="range"]{-webkit-appearance:none;height:8px;border-radius:4px}
    input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:24px;height:24px;border-radius:50%;background:linear-gradient(180deg,#fbbf24,#d97706);cursor:pointer}
    input[type="text"],input[type="email"],input[type="password"]{-webkit-appearance:none;appearance:none;-webkit-user-select:text;user-select:text;pointer-events:auto}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
    @keyframes spin{to{transform:rotate(360deg)}}
    .animate-fadeIn{animation:fadeIn .3s ease-out}.animate-slideUp{animation:slideUp .4s ease-out}
    .animate-pulse{animation:pulse 2s infinite}.animate-spin{animation:spin 1s linear infinite}
    button{min-height:44px;cursor:pointer;transition:all .15s}button:active{transform:scale(.97)}
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:100;display:flex;align-items:center;justify-content:center;padding:1rem}
    .toast{position:fixed;top:1rem;left:50%;transform:translateX(-50%);z-index:200;max-width:90%}
    .star-bg{position:fixed;inset:0;overflow:hidden;pointer-events:none;z-index:0}
    .star{position:absolute;width:2px;height:2px;background:white;border-radius:50%;opacity:.5}
  </style>
</head>
<body class="safe-top safe-bottom">
  <div id="root"></div>
  <script type="text/babel">
    const{useState,useEffect,useCallback,createContext,useContext,useMemo}=React;

    // ===== CONFIG =====
    const SUPABASE_URL='https://dnkeinsedcrlhwbiycfo.supabase.co';
    const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRua2VpbnNlZGNybGh3Yml5Y2ZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NDg0MjgsImV4cCI6MjA4NDMyNDQyOH0.9IkWv6dwOemaVwvWrwq7ZzuebrgWI83JWrdaZbzdhhw';
    const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
    const STRIPE_KEY='pk_live_51SrFQOH02sKb65Xcey2pn7bvJhJQ1EqpjYyAoiVKK3OmGZjlKCMRmuX4t6zUitqQ2RHI7MIceHAkHYadAi4r31D900L7ki97pX';
    const CONTENT_CACHE_KEY='independence_content_v2';
    const CONTENT_CACHE_TTL=1000*60*30; // 30 min

    // ===== CONTENT LOADER =====
    const loadContentFromDB=async()=>{
      try{
        const[langs,texts,systems,planets,events,sectors,diffs]=await Promise.all([
          supabase.from('languages').select('*').eq('is_active',true).order('sort_order'),
          supabase.from('ui_texts').select('*'),
          supabase.from('political_systems').select('*').eq('is_active',true).order('sort_order'),
          supabase.from('planets').select('*').eq('is_active',true).order('sort_order'),
          supabase.from('events').select('*').eq('is_active',true).order('sort_order'),
          supabase.from('budget_sectors').select('*').eq('is_active',true).order('sort_order'),
          supabase.from('difficulties').select('*').eq('is_active',true).order('sort_order'),
        ]);
        
        if(langs.error||texts.error||systems.error||planets.error||events.error)throw new Error('DB query failed');
        
        const data={
          languages:langs.data||[],
          ui_texts:texts.data||[],
          systems:systems.data||[],
          planets:planets.data||[],
          events:events.data||[],
          sectors:sectors.data||[],
          difficulties:diffs.data||[]
        };
        
        localStorage.setItem(CONTENT_CACHE_KEY,JSON.stringify({data,timestamp:Date.now()}));
        console.log('âœ… Content loaded from DB');
        return data;
      }catch(e){
        console.error('âŒ DB load failed:',e);
        return null;
      }
    };

    const loadContentFromCache=()=>{
      try{
        const cached=localStorage.getItem(CONTENT_CACHE_KEY);
        if(cached){
          const{data,timestamp}=JSON.parse(cached);
          if(Date.now()-timestamp<CONTENT_CACHE_TTL){
            console.log('âœ… Content loaded from cache');
            return data;
          }
        }
      }catch(e){}
      return null;
    };

    // Transform DB data to game format
    const transformContent=(data)=>{
      if(!data)return null;
      
      try{
        // UI Texts -> T object
        const T={ui:{},intro:{},systems:{},planets:{},sectors:{},defeat:{},victoryMsg:{}};
        (data.ui_texts||[]).forEach(t=>{
          const[category,...rest]=t.key.split('.');
          const key=rest.join('.');
          if(T[category]!==undefined){
            if(key)T[category][key]=t.value;
            else Object.assign(T[category],t.value);
          }
        });
        
        // Systems - add to T.systems for localization
        const SYSTEMS={};
        (data.systems||[]).forEach(s=>{
          SYSTEMS[s.id]={
            id:s.id,icon:s.icon,premium:s.is_premium||false,
            traits:s.traits||{},
            name:s.name,leader:s.leader,desc:s.description,pros:s.pros,cons:s.cons
          };
          // Also add to T for t() function
          T.systems[s.id]={name:s.name,leader:s.leader,desc:s.description,pros:s.pros,cons:s.cons};
        });
        
        // Planets - add to T.planets for localization
        const PLANETS={};
        (data.planets||[]).forEach(p=>{
          PLANETS[p.id]={
            id:p.id,icon:p.icon,difficulty:p.difficulty||2,
            stats:p.stats||{happiness:50,wealth:50,stability:50},
            mods:p.mods||{},
            name:p.name,desc:p.description,traits:p.traits,quote:p.quote
          };
          // Also add to T for t() function
          T.planets[p.id]={name:p.name,desc:p.description,traits:p.traits,quote:p.quote};
        });
        
        // Events
        const EVENTS={general:[],parliamentary:[],presidential:[],monarchy:[],dictatorship:[],technocracy:[],direct:[]};
        (data.events||[]).forEach(e=>{
          const event={
            id:e.id,icon:e.icon,title:e.title,desc:e.description,
            choices:(e.choices||[]).map(c=>({text:c.text,effects:c.effects||{},cost:c.cost||0,hydro:c.hydro||0}))
          };
          if(EVENTS[e.system])EVENTS[e.system].push(event);
          else EVENTS.general.push(event);
        });
        
        // Sectors - add to T.sectors
        const SECTORS=(data.sectors||[]).map(s=>{
          T.sectors[s.id]={name:s.name};
          return{id:s.id,icon:s.icon,name:s.name};
        });
        
        // Difficulties
        const DIFFICULTIES={};
        (data.difficulties||[]).forEach(d=>{
          DIFFICULTIES[d.id]={icon:d.icon,name:d.name,bonus:d.bonus||0,hydroBonus:d.hydro_bonus||0,severity:d.severity||1.0};
        });
        
        // Languages
        const LANGUAGES=(data.languages||[]).map(l=>({code:l.code,flag:l.flag,name:l.native_name||l.name}));
        
        console.log('âœ… Content transformed:',{T,SYSTEMS,PLANETS,EVENTS:Object.keys(EVENTS).map(k=>k+':'+EVENTS[k].length),SECTORS,DIFFICULTIES,LANGUAGES});
        return{T,SYSTEMS,PLANETS,EVENTS,SECTORS,DIFFICULTIES,LANGUAGES};
      }catch(e){
        console.error('âŒ Transform error:',e);
        return null;
      }
    };

    // ===== FALLBACK CONTENT (when DB unavailable) =====
    const FALLBACK_CONTENT={
      T:{
        ui:{title:{ru:'INDEPENDENCE',en:'INDEPENDENCE',de:'INDEPENDENCE'},subtitle:{ru:'ĞĞ‘Ğ ĞĞ—ĞĞ’ĞĞ¢Ğ•Ğ›Ğ¬ĞĞĞ¯ Ğ˜Ğ“Ğ Ğ Ğ ĞŸĞĞ›Ğ˜Ğ¢Ğ˜ĞšĞ•',en:'CIVIC EDUCATION GAME',de:'POLITISCHES BILDUNGSSPIEL'},login:{ru:'Ğ’Ğ¾Ğ¹Ñ‚Ğ¸',en:'Login',de:'Anmelden'},register:{ru:'Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ',en:'Register',de:'Registrieren'},premium:{ru:'Premium',en:'Premium',de:'Premium'},premiumPrice:{ru:'Â£2.99/Ğ¼ĞµÑ',en:'Â£2.99/mo',de:'Â£2.99/Mo'},startGame:{ru:'ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ¸Ğ³Ñ€Ñƒ',en:'Start Game',de:'Spiel starten'},year:{ru:'Ğ“Ğ¾Ğ´',en:'Year',de:'Jahr'},submit:{ru:'Ğ£Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ Ğ±ÑĞ´Ğ¶ĞµÑ‚',en:'Submit Budget',de:'Budget bestÃ¤tigen'},happiness:{ru:'Ğ¡Ñ‡Ğ°ÑÑ‚ÑŒĞµ',en:'Happiness',de:'Zufriedenheit'},wealth:{ru:'Ğ‘Ğ¾Ğ³Ğ°Ñ‚ÑÑ‚Ğ²Ğ¾',en:'Wealth',de:'Wohlstand'},stability:{ru:'Ğ¡Ñ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ',en:'Stability',de:'StabilitÃ¤t'},budget:{ru:'Ğ‘ÑĞ´Ğ¶ĞµÑ‚',en:'Budget',de:'Budget'},victory:{ru:'ĞŸĞĞ‘Ğ•Ğ”Ğ!',en:'VICTORY!',de:'SIEG!'},defeat:{ru:'ĞŸĞĞ ĞĞ–Ğ•ĞĞ˜Ğ•',en:'DEFEAT',de:'NIEDERLAGE'},playAgain:{ru:'Ğ˜Ğ³Ñ€Ğ°Ñ‚ÑŒ ÑĞ½Ğ¾Ğ²Ğ°',en:'Play Again',de:'Nochmal spielen'},back:{ru:'ĞĞ°Ğ·Ğ°Ğ´',en:'Back',de:'ZurÃ¼ck'},next:{ru:'Ğ”Ğ°Ğ»ĞµĞµ',en:'Next',de:'Weiter'},close:{ru:'Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ',en:'Close',de:'SchlieÃŸen'},easy:{ru:'Ğ›ĞµĞ³ĞºĞ¾',en:'Easy',de:'Leicht'},normal:{ru:'ĞĞ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾',en:'Normal',de:'Normal'},hard:{ru:'Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ğ¾',en:'Hard',de:'Schwer'},years:{ru:'Ğ»ĞµÑ‚',en:'years',de:'Jahre'},choosePlanet:{ru:'Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¿Ğ»Ğ°Ğ½ĞµÑ‚Ñƒ',en:'Choose Planet',de:'Planet wÃ¤hlen'},score:{ru:'ĞÑ‡ĞºĞ¸',en:'Score',de:'Punkte'},signOut:{ru:'Ğ’Ñ‹Ğ¹Ñ‚Ğ¸',en:'Sign Out',de:'Abmelden'},email:{ru:'Email',en:'Email',de:'E-Mail'},password:{ru:'ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ',en:'Password',de:'Passwort'},username:{ru:'Ğ˜Ğ¼Ñ',en:'Username',de:'Name'},loading:{ru:'Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...',en:'Loading...',de:'LÃ¤dt...'},selectLanguage:{ru:'Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑĞ·Ñ‹Ğº',en:'Select Language',de:'Sprache wÃ¤hlen'},advancedSettings:{ru:'Ğ Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ½Ñ‹Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸',en:'Advanced Settings',de:'Erweiterte Einstellungen'},target:{ru:'Ğ¦ĞµĞ»ÑŒ',en:'Target',de:'Ziel'},gameLength:{ru:'Ğ”Ğ»Ğ¸Ğ½Ğ° Ğ¸Ğ³Ñ€Ñ‹',en:'Game length',de:'SpiellÃ¤nge'},eventsPerTurn:{ru:'Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ğ·Ğ° Ñ…Ğ¾Ğ´',en:'Events per turn',de:'Ereignisse pro Zug'},difficulty:{ru:'Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ',en:'Difficulty',de:'Schwierigkeit'},politicalSystem:{ru:'ĞŸĞ¾Ğ»Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ°',en:'Political System',de:'Politisches System'},profile:{ru:'ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ',en:'Profile',de:'Profil'},skip:{ru:'ĞŸÑ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ',en:'Skip',de:'Ãœberspringen'},remaining:{ru:'ĞÑÑ‚Ğ°Ñ‚Ğ¾Ğº',en:'Remaining',de:'Verbleibend'}},
        intro:{title:{ru:'ĞŸĞ¾Ğ·Ğ´Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼, ÑƒĞ²Ğ°Ğ¶Ğ°ĞµĞ¼Ñ‹Ğ¹ ĞÑĞ½Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ!',en:'Congratulations, esteemed Founder!',de:'Herzlichen GlÃ¼ckwunsch!'},p1:{ru:'Ğ’Ğ°Ñˆ ĞºĞ¾Ñ€Ğ°Ğ±Ğ»ÑŒ Ğ¿Ñ€Ğ¸Ğ·ĞµĞ¼Ğ»Ğ¸Ğ»ÑÑ Ğ½Ğ° Ğ¿Ğ»Ğ°Ğ½ĞµÑ‚Ğµ.',en:'Your ship has landed on a planet.',de:'Ihr Schiff ist gelandet.'},p2:{ru:'ĞŸĞ¾ÑÑ‚Ñ€Ğ¾Ğ¹Ñ‚Ğµ Ğ¸Ğ´ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾Ğ±Ñ‰ĞµÑÑ‚Ğ²Ğ¾.',en:'Build a perfect society.',de:'Bauen Sie eine perfekte Gesellschaft.'},p3:{ru:'Ğ˜Ğ»Ğ¸ Ğ½Ğµ Ğ¾Ñ‡ĞµĞ½ÑŒ Ğ¸Ğ´ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğµ.',en:'Or not so perfect.',de:'Oder nicht so perfekt.'},mission:{ru:'Ğ’Ğ°ÑˆĞ° Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ°: ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ñ†Ğ²ĞµÑ‚Ğ°ÑÑ‰ÑƒÑ Ñ†Ğ¸Ğ²Ğ¸Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ.',en:'Your mission: create a thriving civilization.',de:'Ihre Mission: eine blÃ¼hende Zivilisation.'}},
        systems:{parliamentary:{name:{ru:'ĞŸĞ°Ñ€Ğ»Ğ°Ğ¼ĞµĞ½Ñ‚ÑĞºĞ°Ñ Ğ´ĞµĞ¼Ğ¾ĞºÑ€Ğ°Ñ‚Ğ¸Ñ',en:'Parliamentary Democracy',de:'Parlamentarische Demokratie'},leader:{ru:'ĞŸÑ€ĞµĞ¼ÑŒĞµÑ€-Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€',en:'Prime Minister',de:'Premierminister'},desc:{ru:'Ğ”ĞµĞ¼Ğ¾ĞºÑ€Ğ°Ñ‚Ğ¸Ñ Ñ Ğ¿Ğ°Ñ€Ğ»Ğ°Ğ¼ĞµĞ½Ñ‚Ğ¾Ğ¼.',en:'Democracy with parliament.',de:'Demokratie mit Parlament.'},pros:{ru:'Ğ¡Ñ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ',en:'Stability',de:'StabilitÃ¤t'},cons:{ru:'ĞœĞµĞ´Ğ»ĞµĞ½Ğ½Ñ‹Ğµ Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ',en:'Slow decisions',de:'Langsame Entscheidungen'}},presidential:{name:{ru:'ĞŸÑ€ĞµĞ·Ğ¸Ğ´ĞµĞ½Ñ‚ÑĞºĞ°Ñ Ñ€ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°',en:'Presidential Republic',de:'PrÃ¤sidialrepublik'},leader:{ru:'ĞŸÑ€ĞµĞ·Ğ¸Ğ´ĞµĞ½Ñ‚',en:'President',de:'PrÃ¤sident'},desc:{ru:'ĞĞ´Ğ¸Ğ½ Ğ»Ğ¸Ğ´ĞµÑ€, Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ²Ğ»Ğ°ÑÑ‚Ğ¸.',en:'One leader, much power.',de:'Ein FÃ¼hrer, viel Macht.'},pros:{ru:'Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğµ Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ',en:'Fast decisions',de:'Schnelle Entscheidungen'},cons:{ru:'Ğ’ÑÑ‘ Ğ½Ğ° Ğ²Ğ°Ñ',en:'All on you',de:'Alles auf Ihnen'}},monarchy:{name:{ru:'ĞœĞ¾Ğ½Ğ°Ñ€Ñ…Ğ¸Ñ',en:'Monarchy',de:'Monarchie'},leader:{ru:'ĞœĞ¾Ğ½Ğ°Ñ€Ñ…',en:'Monarch',de:'Monarch'},desc:{ru:'Ğ¢Ñ€Ğ°Ğ´Ğ¸Ñ†Ğ¸Ğ¸ Ğ¸ ĞºĞ¾Ñ€Ğ¾Ğ½Ğ°.',en:'Traditions and crown.',de:'Traditionen und Krone.'},pros:{ru:'+10 ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ',en:'+10 stability',de:'+10 StabilitÃ¤t'},cons:{ru:'Ğ Ğ¸ÑĞº Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¸Ñ',en:'Rebellion risk',de:'Aufstandsrisiko'}},dictatorship:{name:{ru:'Ğ”Ğ¸ĞºÑ‚Ğ°Ñ‚ÑƒÑ€Ğ°',en:'Dictatorship',de:'Diktatur'},leader:{ru:'Ğ’ĞµÑ€Ñ…Ğ¾Ğ²Ğ½Ñ‹Ğ¹ Ğ»Ğ¸Ğ´ĞµÑ€',en:'Supreme Leader',de:'Oberster FÃ¼hrer'},desc:{ru:'Ğ­Ñ„Ñ„ĞµĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ñ€ĞµĞ²Ñ‹ÑˆĞµ Ğ²ÑĞµĞ³Ğ¾.',en:'Efficiency above all.',de:'Effizienz Ã¼ber alles.'},pros:{ru:'ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑ„Ñ„ĞµĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ',en:'Maximum efficiency',de:'Maximale Effizienz'},cons:{ru:'Ğ Ğ¸ÑĞº Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ñ€Ğ¾Ñ‚Ğ°',en:'Coup risk',de:'Putschrisiko'}},technocracy:{name:{ru:'Ğ¢ĞµÑ…Ğ½Ğ¾ĞºÑ€Ğ°Ñ‚Ğ¸Ñ',en:'Technocracy',de:'Technokratie'},leader:{ru:'Ğ“Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ Ñ‚ĞµÑ…Ğ½Ğ¾Ğ»Ğ¾Ğ³',en:'Chief Technologist',de:'Cheftechnologe'},desc:{ru:'Ğ­ĞºÑĞ¿ĞµÑ€Ñ‚Ñ‹ Ñƒ Ğ²Ğ»Ğ°ÑÑ‚Ğ¸.',en:'Experts in power.',de:'Experten an der Macht.'},pros:{ru:'+15 Ğ±Ğ¾Ğ³Ğ°Ñ‚ÑÑ‚Ğ²Ğ¾',en:'+15 wealth',de:'+15 Wohlstand'},cons:{ru:'Ğ›ÑĞ´Ğ¸ ĞºĞ°Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ',en:'People as data',de:'Menschen als Daten'}},direct:{name:{ru:'ĞŸÑ€ÑĞ¼Ğ°Ñ Ğ´ĞµĞ¼Ğ¾ĞºÑ€Ğ°Ñ‚Ğ¸Ñ',en:'Direct Democracy',de:'Direkte Demokratie'},leader:{ru:'ĞšĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ğ¾Ñ€',en:'Coordinator',de:'Koordinator'},desc:{ru:'ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ³Ğ¾Ğ»Ğ¾Ñ Ğ²Ğ°Ğ¶ĞµĞ½.',en:'Every voice matters.',de:'Jede Stimme zÃ¤hlt.'},pros:{ru:'Ğ›ĞµĞ³Ğ¸Ñ‚Ğ¸Ğ¼Ğ½Ğ¾ÑÑ‚ÑŒ',en:'Legitimacy',de:'LegitimitÃ¤t'},cons:{ru:'ĞÑ‡ĞµĞ½ÑŒ Ğ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾',en:'Very slow',de:'Sehr langsam'}}},
        planets:{terranova:{name:{ru:'Ğ¢ĞµÑ€Ñ€Ğ° ĞĞ¾Ğ²Ğ°',en:'Terra Nova',de:'Terra Nova'},desc:{ru:'ĞŸĞ»Ğ°Ğ½ĞµÑ‚Ğ°-Ğ±Ğ»Ğ¸Ğ·Ğ½ĞµÑ† Ğ—ĞµĞ¼Ğ»Ğ¸.',en:'Earth twin planet.',de:'ErdÃ¤hnlicher Planet.'},traits:{ru:'Ğ¡Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ',en:'Balanced',de:'Ausgewogen'},quote:{ru:'Â«ĞŸÑ€ĞµĞ´ÑĞºĞ°Ğ·ÑƒĞµĞ¼Ğ¾ÑÑ‚ÑŒÂ»',en:'"Predictability"',de:'â€Vorhersehbarkeit"'}},aridia:{name:{ru:'ĞÑ€Ğ¸Ğ´Ğ¸Ñ',en:'Aridia',de:'Aridia'},desc:{ru:'ĞŸÑƒÑÑ‚Ñ‹Ğ½Ğ½Ñ‹Ğ¹ Ğ¼Ğ¸Ñ€.',en:'Desert world.',de:'WÃ¼stenwelt.'},traits:{ru:'ĞŸÑƒÑÑ‚Ñ‹Ğ½Ñ',en:'Desert',de:'WÃ¼ste'},quote:{ru:'Â«Ğ–Ğ°Ñ€ĞºĞ¾Â»',en:'"Hot"',de:'â€HeiÃŸ"'}},edemia:{name:{ru:'Ğ­Ğ´ĞµĞ¼Ğ¸Ñ',en:'Edemia',de:'Edemia'},desc:{ru:'Ğ Ğ°Ğ¹.',en:'Paradise.',de:'Paradies.'},traits:{ru:'Ğ‘Ğ¾Ğ³Ğ°Ñ‚Ğ°Ñ',en:'Rich',de:'Reich'},quote:{ru:'Â«Ğ Ğ°Ğ¹Â»',en:'"Paradise"',de:'â€Paradies"'}},chaosprime:{name:{ru:'Ğ¥Ğ°Ğ¾Ñ ĞŸÑ€Ğ°Ğ¹Ğ¼',en:'Chaos Prime',de:'Chaos Prime'},desc:{ru:'Ğ¥Ğ°Ğ¾Ñ.',en:'Chaos.',de:'Chaos.'},traits:{ru:'Ğ¥Ğ°Ğ¾Ñ',en:'Chaos',de:'Chaos'},quote:{ru:'Â«Ğ¥Ğ°Ğ¾ÑÂ»',en:'"Chaos"',de:'â€Chaos"'}},polaris:{name:{ru:'ĞŸĞ¾Ğ»ÑÑ€Ğ¸Ñ',en:'Polaris',de:'Polaris'},desc:{ru:'Ğ¥Ğ¾Ğ»Ğ¾Ğ´Ğ½Ñ‹Ğ¹ Ğ¼Ğ¸Ñ€.',en:'Cold world.',de:'Kalte Welt.'},traits:{ru:'Ğ¥Ğ¾Ğ»Ğ¾Ğ´',en:'Cold',de:'Kalt'},quote:{ru:'Â«Ğ¥Ğ¾Ğ»Ğ¾Ğ´Ğ½Ğ¾Â»',en:'"Cold"',de:'â€Kalt"'}}},
        sectors:{defence:{name:{ru:'ĞĞ±Ğ¾Ñ€Ğ¾Ğ½Ğ°',en:'Defence',de:'Verteidigung'}},education:{name:{ru:'ĞĞ±Ñ€Ğ°Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ',en:'Education',de:'Bildung'}},health:{name:{ru:'Ğ—Ğ´Ñ€Ğ°Ğ²Ğ¾Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ',en:'Healthcare',de:'Gesundheit'}},infra:{name:{ru:'Ğ˜Ğ½Ñ„Ñ€Ğ°ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°',en:'Infrastructure',de:'Infrastruktur'}},welfare:{name:{ru:'Ğ¡Ğ¾Ñ†Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ°',en:'Welfare',de:'Soziales'}}},
        defeat:{happiness:{ru:'ĞĞ°Ñ€Ğ¾Ğ´ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ»!',en:'People revolted!',de:'Volk rebelliert!'},stability:{ru:'Ğ¥Ğ°Ğ¾Ñ!',en:'Chaos!',de:'Chaos!'},rebellion:{ru:'ĞœÑÑ‚ĞµĞ¶!',en:'Rebellion!',de:'Aufstand!'},coup:{ru:'ĞŸĞµÑ€ĞµĞ²Ğ¾Ñ€Ğ¾Ñ‚!',en:'Coup!',de:'Putsch!'},targets:{ru:'Ğ¦ĞµĞ»Ğ¸ Ğ½Ğµ Ğ´Ğ¾ÑÑ‚Ğ¸Ğ³Ğ½ÑƒÑ‚Ñ‹!',en:'Targets not met!',de:'Ziele nicht erreicht!'}},
        victoryMsg:{utopia:{ru:'Ğ£Ñ‚Ğ¾Ğ¿Ğ¸Ñ!',en:'Utopia!',de:'Utopie!'},prosperity:{ru:'ĞŸÑ€Ğ¾Ñ†Ğ²ĞµÑ‚Ğ°Ğ½Ğ¸Ğµ!',en:'Prosperity!',de:'Wohlstand!'},survival:{ru:'Ğ’Ñ‹ Ğ²Ñ‹Ğ¶Ğ¸Ğ»Ğ¸!',en:'You survived!',de:'Sie haben Ã¼berlebt!'}}
      },
      SYSTEMS:{parliamentary:{id:'parliamentary',icon:'ğŸ›ï¸',premium:false,traits:{needsApproval:true,threshold:40,stabilityBonus:0,happinessDecay:0,wealthBonus:0}},presidential:{id:'presidential',icon:'ğŸ¦…',premium:false,traits:{needsApproval:false,stabilityBonus:0,happinessDecay:0,wealthBonus:5}},monarchy:{id:'monarchy',icon:'ğŸ‘‘',premium:true,traits:{needsApproval:false,stabilityBonus:10,happinessDecay:0,wealthBonus:0,rebellionRisk:25}},dictatorship:{id:'dictatorship',icon:'âš”ï¸',premium:true,traits:{needsApproval:false,stabilityBonus:5,happinessDecay:5,wealthBonus:0,coupRisk:30}},technocracy:{id:'technocracy',icon:'ğŸ”¬',premium:true,traits:{needsApproval:false,stabilityBonus:5,happinessDecay:2,wealthBonus:15,startPenalty:10}},direct:{id:'direct',icon:'ğŸ—³ï¸',premium:true,traits:{needsApproval:false,stabilityBonus:-5,happinessDecay:-3,wealthBonus:0,referendumChance:0.25}}},
      PLANETS:{terranova:{id:'terranova',icon:'ğŸŒ',difficulty:2,stats:{happiness:60,wealth:50,stability:70},mods:{eventMult:1.0,extraEvents:0}},aridia:{id:'aridia',icon:'ğŸœï¸',difficulty:4,stats:{happiness:45,wealth:35,stability:60},mods:{eventMult:1.2,happinessDecay:2}},edemia:{id:'edemia',icon:'ğŸŒ´',difficulty:2,stats:{happiness:75,wealth:70,stability:55},mods:{eventMult:1.0,stabilityDecay:2}},chaosprime:{id:'chaosprime',icon:'ğŸŒ‹',difficulty:3,stats:{happiness:50,wealth:55,stability:40},mods:{eventMult:1.5,extraEvents:1,stabilityDecay:3}},polaris:{id:'polaris',icon:'â„ï¸',difficulty:4,stats:{happiness:40,wealth:45,stability:80},mods:{eventMult:0.8,happinessDecay:3}}},
      EVENTS:{general:[{id:'pandemic',icon:'ğŸ¦ ',title:{ru:'Ğ­Ğ¿Ğ¸Ğ´ĞµĞ¼Ğ¸Ñ',en:'Pandemic',de:'Pandemie'},desc:{ru:'Ğ’Ğ¸Ñ€ÑƒÑ Ñ€Ğ°ÑĞ¿Ñ€Ğ¾ÑÑ‚Ñ€Ğ°Ğ½ÑĞµÑ‚ÑÑ.',en:'Virus spreading.',de:'Virus breitet sich aus.'},choices:[{text:{ru:'ĞšĞ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ğ½',en:'Quarantine',de:'QuarantÃ¤ne'},effects:{happiness:-20,stability:10},cost:30},{text:{ru:'ĞĞ¸Ñ‡ĞµĞ³Ğ¾',en:'Nothing',de:'Nichts'},effects:{stability:-20},cost:0}]}],parliamentary:[],presidential:[],monarchy:[],dictatorship:[],technocracy:[],direct:[]},
      SECTORS:[{id:'defence',icon:'ğŸ›¡ï¸'},{id:'education',icon:'ğŸ“š'},{id:'health',icon:'ğŸ¥'},{id:'infra',icon:'ğŸ—ï¸'},{id:'welfare',icon:'ğŸ¤'}],
      DIFFICULTIES:{easy:{icon:'ğŸ˜Š',bonus:10,hydroBonus:30,severity:0.7},normal:{icon:'ğŸ˜',bonus:0,hydroBonus:0,severity:1.0},hard:{icon:'ğŸ˜°',bonus:-10,hydroBonus:-20,severity:1.3}},
      LANGUAGES:[{code:'ru',flag:'ğŸ‡·ğŸ‡º',name:'Ğ ÑƒÑÑĞºĞ¸Ğ¹'},{code:'en',flag:'ğŸ‡¬ğŸ‡§',name:'English'},{code:'de',flag:'ğŸ‡©ğŸ‡ª',name:'Deutsch'}]
    };

    // ===== CONTENT CONTEXT =====
    const ContentContext=createContext(null);
    const useGameContent=()=>useContext(ContentContext);

    function ContentProvider({children}){
      const[content,setContent]=useState(FALLBACK_CONTENT); // Start with fallback!
      const[loading,setLoading]=useState(true);

      useEffect(()=>{
        const load=async()=>{
          // Try cache first for fast load
          try{
            const cached=loadContentFromCache();
            if(cached){
              const transformed=transformContent(cached);
              if(transformed&&Object.keys(transformed.SYSTEMS||{}).length>0){
                console.log('ğŸ“¦ Using cached content');
                setContent(transformed);
              }
            }
          }catch(e){console.warn('Cache error:',e);}
          
          // Load fresh from DB
          try{
            const fresh=await loadContentFromDB();
            if(fresh){
              const transformed=transformContent(fresh);
              if(transformed&&Object.keys(transformed.SYSTEMS||{}).length>0){
                console.log('ğŸŒ Using DB content');
                setContent(transformed);
              }
            }
          }catch(e){console.warn('DB error:',e);}
          
          setLoading(false);
        };
        load();
      },[]);

      // Always have content (either loaded or fallback)
      return(<ContentContext.Provider value={content}>{children}</ContentContext.Provider>);
    }


    // ===== DB HELPERS =====
    const db={
      async saveGameResult(userId,data){return await supabase.from('game_results').insert({user_id:userId,planet_name:data.planet,political_system:data.system,difficulty:data.difficulty,max_turns:data.maxTurns,turns_played:data.turn,final_happiness:Math.round(data.stats.happiness),final_wealth:Math.round(data.stats.wealth),final_stability:Math.round(data.stats.stability),final_hydrobite:data.hydrobite,is_victory:data.isVictory,victory_type:data.victoryType,score:data.score,duration_seconds:data.duration});},
      async getLeaderboard(limit=30){return await supabase.from('profiles').select('id,username,display_name,total_games,total_wins,highest_score').gt('total_games',0).order('highest_score',{ascending:false}).limit(limit);},
      async getUserAchievements(userId){return await supabase.from('user_achievements').select('*,achievements(*)').eq('user_id',userId);},
      async unlockAchievement(userId,achievementId){return await supabase.from('user_achievements').upsert({user_id:userId,achievement_id:achievementId},{onConflict:'user_id,achievement_id'});},
    };

    // ===== AUTH CONTEXT =====
    const AuthContext=createContext(null);
    const useAuth=()=>useContext(AuthContext);

    function AuthProvider({children}){
      const[user,setUser]=useState(null);
      const[profile,setProfile]=useState(null);
      const[loading,setLoading]=useState(true);
      const[initialized,setInitialized]=useState(false);

      const loadProfile=useCallback(async(userId)=>{
        try{const{data}=await supabase.from('profiles').select('*').eq('id',userId).single();if(data)setProfile(data);}catch(e){console.warn('Profile load error:',e);}
      },[]);

      useEffect(()=>{
        let mounted=true;
        const timeout=setTimeout(()=>{if(mounted&&!initialized){console.warn('Auth timeout, proceeding without auth');setLoading(false);setInitialized(true);}},3000);
        
        supabase.auth.getSession().then(({data:{session}})=>{
          if(!mounted)return;
          const u=session?.user??null;setUser(u);if(u)loadProfile(u.id);setLoading(false);setInitialized(true);
        }).catch(e=>{
          console.warn('Auth error:',e);
          if(mounted){setLoading(false);setInitialized(true);}
        });
        
        const{data:{subscription}}=supabase.auth.onAuthStateChange(async(event,session)=>{
          if(!mounted)return;
          const u=session?.user??null;setUser(u);if(u)await loadProfile(u.id);else setProfile(null);setLoading(false);
        });
        
        return()=>{mounted=false;clearTimeout(timeout);subscription.unsubscribe();};
      },[loadProfile]);

      const signUp=async(email,password,username)=>{const{data,error}=await supabase.auth.signUp({email,password,options:{data:{username,full_name:username}}});if(error)throw error;return data;};
      const signIn=async(email,password)=>{const{data,error}=await supabase.auth.signInWithPassword({email,password});if(error)throw error;return data;};
      const signOut=async()=>{await supabase.auth.signOut();setUser(null);setProfile(null);};

      return(<AuthContext.Provider value={{user,profile,loading,initialized,signUp,signIn,signOut}}>{children}</AuthContext.Provider>);
    }

    // ===== LANG CONTEXT =====
    const LangContext=createContext({lang:'ru',setLang:()=>{},t:(k)=>k});
    const useLang=()=>useContext(LangContext);

    function LangProvider({children}){
      const[lang,setLang]=useState(()=>localStorage.getItem('lang')||'');
      const content=useGameContent();
      const T=content?.T||FALLBACK_CONTENT.T;
      const t=useCallback((path)=>{
        const keys=path.split('.');let val=T;
        for(const k of keys){val=val?.[k];if(!val)return path;}
        return val[lang]||val.ru||val.en||path;
      },[lang,T]);
      const changeLang=(l)=>{setLang(l);localStorage.setItem('lang',l);};
      return(<LangContext.Provider value={{lang,setLang:changeLang,t}}>{children}</LangContext.Provider>);
    }

    // ===== UI COMPONENTS =====
    const Spinner=({size='md'})=>{const s={sm:'w-5 h-5',md:'w-8 h-8',lg:'w-12 h-12'};return(<div className="flex justify-center py-4"><div className={`${s[size]} border-4 border-amber-500 border-t-transparent rounded-full animate-spin`}/></div>);};
    const Toast=({message,type='info',onClose})=>{useEffect(()=>{const t=setTimeout(onClose,3000);return()=>clearTimeout(t);},[onClose]);const colors={success:'bg-green-900/90 border-green-500 text-green-200',error:'bg-red-900/90 border-red-500 text-red-200',warning:'bg-yellow-900/90 border-yellow-500 text-yellow-200',info:'bg-blue-900/90 border-blue-500 text-blue-200'};return(<div className={`toast ${colors[type]} border px-4 py-3 rounded-lg shadow-lg animate-slideUp`}>{message}</div>);};
    const Modal=({children,onClose,title})=>(<div className="modal-overlay animate-fadeIn" onClick={onClose}><div className="bg-slate-800 rounded-xl max-w-md w-full max-h-[85vh] overflow-hidden border border-amber-500/30 animate-slideUp" onClick={e=>e.stopPropagation()}>{title&&(<div className="flex justify-between items-center p-4 border-b border-slate-700"><h2 className="text-lg font-display font-bold text-amber-400">{title}</h2><button onClick={onClose} className="text-gray-400 hover:text-white text-2xl">&times;</button></div>)}<div className="p-4 overflow-y-auto max-h-[calc(85vh-60px)]">{children}</div></div></div>);
    const StatBar=({label,value,icon,color})=>(<div className="mb-2"><div className="flex justify-between text-xs mb-1"><span className="text-amber-100/80">{icon} {label}</span><span className={`font-bold ${value<30?'text-red-400':value>70?'text-green-400':'text-amber-300'}`}>{Math.round(value)}%</span></div><div className="h-2 bg-slate-900 rounded overflow-hidden border border-amber-900/30"><div className={`h-full ${color} transition-all duration-500`} style={{width:`${Math.min(100,Math.max(0,value))}%`}}/></div></div>);
    const StarBackground=()=>{const stars=useMemo(()=>Array.from({length:50},(_,i)=>({id:i,left:Math.random()*100,top:Math.random()*100,size:Math.random()*2+1,delay:Math.random()*3})),[]);return(<div className="star-bg">{stars.map(s=>(<div key={s.id} className="star animate-pulse" style={{left:`${s.left}%`,top:`${s.top}%`,width:s.size,height:s.size,animationDelay:`${s.delay}s`}}/>))}</div>);};

    // ===== AUTH MODAL =====
    const AuthModal=({onClose,initialMode='login'})=>{
      const{signUp,signIn}=useAuth();const{t}=useLang();
      const[mode,setMode]=useState(initialMode);const[email,setEmail]=useState('');const[password,setPassword]=useState('');const[username,setUsername]=useState('');const[loading,setLoading]=useState(false);const[error,setError]=useState('');const[success,setSuccess]=useState('');
      const handleSubmit=async(e)=>{e.preventDefault();setLoading(true);setError('');setSuccess('');try{if(mode==='register'){await signUp(email,password,username);setSuccess('Check email!');}else{await signIn(email,password);onClose();}}catch(err){setError(err.message);}setLoading(false);};
      return(<Modal onClose={onClose} title={mode==='login'?t('ui.login'):t('ui.register')}><form onSubmit={handleSubmit} autoComplete="off" className="space-y-4">{mode==='register'&&(<input type="text" id="auth-username" name="username" placeholder={t('ui.username')} value={username} onChange={e=>setUsername(e.target.value)} autoComplete="off" className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-amber-500" required/>)}<input type="email" id="auth-email" name="email" placeholder={t('ui.email')} value={email} onChange={e=>setEmail(e.target.value)} autoComplete="off" className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-amber-500" required/><input type="password" id="auth-password" name="password" placeholder={t('ui.password')} value={password} onChange={e=>setPassword(e.target.value)} autoComplete="new-password" className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-amber-500" required minLength={6}/>{error&&<p className="text-red-400 text-sm">{error}</p>}{success&&<p className="text-green-400 text-sm">{success}</p>}<button type="submit" disabled={loading} className="w-full py-3 bg-gradient-to-r from-amber-500 to-yellow-500 text-slate-900 rounded-lg font-bold disabled:opacity-50">{loading?'...':mode==='login'?t('ui.login'):t('ui.register')}</button><p className="text-center text-sm text-gray-400">{mode==='login'?<span>No account? <button type="button" onClick={()=>setMode('register')} className="text-amber-400">Register</button></span>:<span>Have account? <button type="button" onClick={()=>setMode('login')} className="text-amber-400">Login</button></span>}</p></form></Modal>);
    };

    // ===== PROFILE MODAL =====
    const ProfileModal=({onClose})=>{
      const{profile,signOut}=useAuth();const{t}=useLang();
      return(<Modal onClose={onClose} title={t('ui.profile')||'Profile'}><div className="text-center mb-4"><div className="w-16 h-16 bg-amber-600 rounded-full flex items-center justify-center text-2xl font-bold mx-auto mb-2">{profile?.display_name?.[0]?.toUpperCase()||'ğŸ‘¤'}</div><h3 className="font-bold text-lg text-amber-300">{profile?.display_name||'Player'}</h3>{profile?.is_premium&&<span className="text-amber-400 text-sm">â­ Premium</span>}</div><div className="space-y-2 text-sm mb-4"><div className="flex justify-between"><span className="text-gray-400">Games:</span><span className="text-amber-300">{profile?.total_games||0}</span></div><div className="flex justify-between"><span className="text-gray-400">Wins:</span><span className="text-amber-300">{profile?.total_wins||0}</span></div><div className="flex justify-between"><span className="text-gray-400">Best:</span><span className="text-amber-300">{profile?.highest_score||0}</span></div></div><div className="flex gap-2"><button onClick={onClose} className="flex-1 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg">{t('ui.close')}</button><button onClick={()=>{signOut();onClose();}} className="flex-1 py-2 bg-red-900/50 hover:bg-red-800/50 text-red-300 rounded-lg">{t('ui.signOut')}</button></div></Modal>);
    };

    // ===== LEADERBOARD MODAL =====
    const LeaderboardModal=({onClose})=>{
      const[leaders,setLeaders]=useState([]);const[loading,setLoading]=useState(true);
      useEffect(()=>{db.getLeaderboard(20).then(({data})=>{setLeaders(data||[]);setLoading(false);});},[]);
      return(<Modal onClose={onClose} title="ğŸ† Leaderboard">{loading?<Spinner/>:(<div className="space-y-2">{leaders.length===0?<p className="text-center text-gray-400 py-8">No results</p>:leaders.map((p,i)=>(<div key={p.id} className={`flex items-center gap-3 p-3 rounded-lg ${i<3?'bg-gradient-to-r from-amber-900/40 to-transparent':'bg-slate-700/30'}`}><span className="text-xl font-bold w-8 text-center">{i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':`${i+1}`}</span><div className="flex-1"><p className="font-bold text-amber-100 truncate">{p.display_name||p.username||'Player'}</p><p className="text-xs text-gray-400">{p.total_wins}/{p.total_games}</p></div><p className="text-lg font-bold text-amber-400">{p.highest_score}</p></div>))}</div>)}</Modal>);
    };

    // ===== PREMIUM MODAL =====
    const PremiumModal=({onClose})=>{
      const{user}=useAuth();const{t}=useLang();const[loading,setLoading]=useState(false);const[promo,setPromo]=useState('');const[error,setError]=useState('');
      const handlePurchase=async()=>{if(!user){setError('Login first');return;}setLoading(true);setError('');try{const res=await fetch('/.netlify/functions/create-checkout',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:user.id,userEmail:user.email,promo:promo.trim()||undefined})});const data=await res.json();if(data.error)setError(data.error);else if(data.url)window.location.href=data.url;}catch(e){setError('Error');}setLoading(false);};
      const features=['ğŸ›ï¸ 6 political systems','ğŸ† All achievements','ğŸ“Š Extended stats','ğŸš« No ads','ğŸ’¾ Cloud saves'];
      return(<Modal onClose={onClose} title="â­ Premium"><div className="text-center mb-4"><div className="text-4xl font-bold text-amber-400 mb-1">{t('ui.premiumPrice')}</div></div><div className="bg-slate-700/30 rounded-lg p-4 mb-4 space-y-2">{features.map((f,i)=>(<div key={i} className="text-gray-300">{f}</div>))}</div><input type="text" placeholder="Promo code" value={promo} onChange={e=>setPromo(e.target.value)} className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white mb-4"/>{error&&<p className="text-red-400 text-sm mb-2">{error}</p>}<button onClick={handlePurchase} disabled={loading} className="w-full py-3 bg-gradient-to-r from-amber-500 to-yellow-500 text-slate-900 rounded-lg font-bold disabled:opacity-50">{loading?'...':'Subscribe'}</button></Modal>);
    };

    // ===== MAIN GAME =====
    function Game(){
      const{user,profile,loading:authLoading,initialized}=useAuth();
      const{lang,setLang,t}=useLang();
      const content=useGameContent();
      const{T,SYSTEMS,PLANETS,EVENTS,SECTORS,DIFFICULTIES,LANGUAGES}=content||FALLBACK_CONTENT;

      const[phase,setPhase]=useState('lang');
      const[turn,setTurn]=useState(1);
      const[maxTurns,setMaxTurns]=useState(15);
      const[difficulty,setDifficulty]=useState('normal');
      const[stats,setStats]=useState({happiness:60,wealth:50,stability:70});
      const[hydrobite,setHydrobite]=useState(100);
      const[budget,setBudget]=useState({defence:20,education:20,health:20,infra:20,welfare:20});
      const[system,setSystem]=useState('parliamentary');
      const[planetId,setPlanetId]=useState('terranova');
      const[event,setEvent]=useState(null);
      const[eventQueue,setEventQueue]=useState([]);
      const[usedEvents,setUsedEvents]=useState([]);
      const[finalScore,setFinalScore]=useState(0);
      const[victoryType,setVictoryType]=useState(null);
      const[eventsPerTurn,setEventsPerTurn]=useState(1);
      const[targetHappiness,setTargetHappiness]=useState(70);
      const[targetWealth,setTargetWealth]=useState(70);
      const[targetStability,setTargetStability]=useState(70);
      const[showAdvanced,setShowAdvanced]=useState(false);

      const[showAuth,setShowAuth]=useState(false);
      const[showProfile,setShowProfile]=useState(false);
      const[showLeaderboard,setShowLeaderboard]=useState(false);
      const[showPremium,setShowPremium]=useState(false);
      const[toast,setToast]=useState(null);
      const[introStep,setIntroStep]=useState(0);

      const sys=SYSTEMS[system];
      const planet=PLANETS[planetId];
      const diff=DIFFICULTIES[difficulty];
      const totalBudget=Object.values(budget).reduce((a,b)=>a+b,0);
      const remaining=hydrobite-totalBudget;
      const isPremium=profile?.is_premium||false;

      useEffect(()=>{
        const params=new URLSearchParams(window.location.search);
        if(params.get('success')==='true'){window.history.replaceState({},'','/');setToast({message:'âœ… Payment successful!',type:'success'});setTimeout(()=>window.location.reload(),2000);}
        else if(params.get('canceled')==='true'){window.history.replaceState({},'','/');setToast({message:'Payment canceled',type:'warning'});}
      },[]);

      useEffect(()=>{if(lang)setPhase('title');},[lang]);

      const showToast=useCallback((message,type='info')=>setToast({message,type}),[]);

      const calculateScore=useCallback((s,t,isVictory)=>{
        let score=Math.floor((s.happiness+s.wealth+s.stability)/3);
        score+=t*2;if(isVictory)score+=20;
        if(difficulty==='hard')score+=15;if(difficulty==='easy')score-=10;
        return Math.max(0,score);
      },[difficulty]);

      const endGame=useCallback(async(isVictory,vType=null)=>{
        const score=calculateScore(stats,turn,isVictory);
        setFinalScore(score);setVictoryType(vType);
        if(user){
          const gameData={planet:T.planets[planetId].name[lang],system,difficulty,maxTurns,turn,stats,hydrobite,isVictory,victoryType:vType,score,duration:0};
          await db.saveGameResult(user.id,gameData);
        }
        setPhase(isVictory?'victory':'gameover');
      },[user,planetId,system,difficulty,maxTurns,turn,stats,hydrobite,lang,calculateScore]);

      const startGame=useCallback(()=>{
        if(!isPremium&&SYSTEMS[system].premium){showToast('ğŸ”’ Premium required!','warning');return;}
        const d=DIFFICULTIES[difficulty];const p=PLANETS[planetId];const s=SYSTEMS[system];
        setStats({happiness:Math.max(10,Math.min(90,p.stats.happiness+d.bonus-(s.traits.startPenalty||0))),wealth:Math.max(10,Math.min(90,p.stats.wealth+d.bonus)),stability:Math.max(10,Math.min(90,p.stats.stability+d.bonus+s.traits.stabilityBonus))});
        setHydrobite(100+d.hydroBonus);setTurn(1);setBudget({defence:20,education:20,health:20,infra:20,welfare:20});setUsedEvents([]);setEventQueue([]);setPhase('playing');
      },[system,difficulty,planetId,isPremium,showToast]);

      const getRandomEvents=useCallback((count)=>{
        const general=[...EVENTS.general];const specific=EVENTS[system]||[];const all=[...general,...specific];
        let available=all.filter(e=>!usedEvents.includes(e.id));if(available.length<count){setUsedEvents([]);available=all;}
        const selected=[];for(let i=0;i<count&&available.length>0;i++){const idx=Math.floor(Math.random()*available.length);selected.push(available[idx]);available.splice(idx,1);}
        return selected;
      },[system,usedEvents]);

      const checkGameEnd=useCallback((newStats,newTurn)=>{
        // Immediate defeat conditions
        if(newStats.stability<=0){endGame(false,'stability');return true;}
        if(newStats.happiness<=0){endGame(false,'happiness');return true;}
        // Special system risks
        if(sys.traits.rebellionRisk&&newStats.happiness<sys.traits.rebellionRisk&&Math.random()<0.3){showToast(t('defeat.rebellion'),'error');setTimeout(()=>endGame(false,'rebellion'),1000);return true;}
        if(sys.traits.coupRisk&&newStats.stability<sys.traits.coupRisk&&Math.random()<0.3){showToast(t('defeat.coup'),'error');setTimeout(()=>endGame(false,'coup'),1000);return true;}
        // Early victory conditions
        if(newStats.happiness>=95&&newStats.wealth>=70&&newStats.stability>=70){endGame(true,'utopia');return true;}
        if(newStats.wealth>=95&&newStats.happiness>=70&&newStats.stability>=70){endGame(true,'prosperity');return true;}
        // End of game - check custom targets
        if(newTurn>maxTurns){
          const failed=[];
          if(newStats.happiness<targetHappiness)failed.push(`ğŸ˜Š${Math.round(newStats.happiness)}%<${targetHappiness}%`);
          if(newStats.wealth<targetWealth)failed.push(`ğŸ’°${Math.round(newStats.wealth)}%<${targetWealth}%`);
          if(newStats.stability<targetStability)failed.push(`âš–ï¸${Math.round(newStats.stability)}%<${targetStability}%`);
          if(failed.length===0){
            endGame(true,'survival');
          }else{
            showToast(`âŒ ${failed.join(', ')}`,'error');
            setTimeout(()=>endGame(false,'targets'),500);
          }
          return true;
        }
        return false;
      },[sys,maxTurns,targetHappiness,targetWealth,targetStability,endGame,showToast,t]);

      const processTurn=useCallback(()=>{
        if(remaining<0){showToast('âŒ Budget exceeded!','error');return;}
        if(sys.traits.needsApproval&&stats.happiness<sys.traits.threshold){if(Math.random()>0.4){showToast('ğŸ›ï¸ Parliament rejected!','warning');return;}}
        if(sys.traits.referendumChance&&Math.random()<sys.traits.referendumChance){showToast('ğŸ—³ï¸ Referendum!','info');}

        const d=DIFFICULTIES[difficulty];
        let changes={happiness:(budget.welfare*0.35)+(budget.health*0.25)+(budget.education*0.15)-12-sys.traits.happinessDecay-(planet.mods.happinessDecay||0),wealth:(budget.infra*0.4)+(budget.education*0.25)-10+sys.traits.wealthBonus,stability:(budget.defence*0.35)+(budget.infra*0.1)-5-(planet.mods.stabilityDecay||0)};
        Object.keys(changes).forEach(k=>{if(changes[k]<0)changes[k]*=d.severity;});
        const newStats={happiness:Math.max(0,Math.min(100,stats.happiness+changes.happiness)),wealth:Math.max(0,Math.min(100,stats.wealth+changes.wealth)),stability:Math.max(0,Math.min(100,stats.stability+changes.stability))};
        setStats(newStats);setHydrobite(Math.floor(80+newStats.wealth*0.3+d.hydroBonus*0.5));

        const eventCount=eventsPerTurn+(planet.mods.extraEvents||0);
        const events=getRandomEvents(eventCount);
        setUsedEvents(prev=>[...prev,...events.map(e=>e.id)]);
        setEventQueue(events);
        if(events.length>0){setEvent(events[0]);setEventQueue(events.slice(1));setPhase('event');}
        else{
          const newTurn=turn+1;
          if(!checkGameEnd(newStats,newTurn)){setTurn(newTurn);setPhase('playing');}
        }
      },[remaining,sys,stats,difficulty,budget,planet,eventsPerTurn,turn,getRandomEvents,checkGameEnd,showToast]);

      const handleChoice=useCallback((choice)=>{
        const d=DIFFICULTIES[difficulty];let newStats={...stats};
        Object.entries(choice.effects).forEach(([k,v])=>{if(newStats[k]!==undefined){const effectValue=v<0?v*d.severity:v;newStats[k]=Math.max(0,Math.min(100,newStats[k]+effectValue));}});
        let newHydro=hydrobite-choice.cost+(choice.hydro||0);setHydrobite(Math.max(0,newHydro));setStats(newStats);

        if(eventQueue.length>0){setEvent(eventQueue[0]);setEventQueue(q=>q.slice(1));}
        else{
          const newTurn=turn+1;
          if(!checkGameEnd(newStats,newTurn)){setTurn(newTurn);setEvent(null);setPhase('playing');}
        }
      },[difficulty,stats,hydrobite,turn,eventQueue,checkGameEnd]);

      const handleBudget=useCallback((sector,val)=>{setBudget(prev=>({...prev,[sector]:Math.max(0,Math.min(50,parseInt(val)||0))}));},[]);

      // ===== RENDERS =====
      if(!initialized||authLoading){return(<div className="min-h-screen bg-slate-950 flex items-center justify-center"><Spinner size="lg"/></div>);}

      // LANG SELECT
      if(phase==='lang'){
        return(<div className="min-h-screen bg-slate-950 text-white flex items-center justify-center p-4"><StarBackground/><div className="text-center relative z-10 animate-fadeIn"><h1 className="text-4xl font-display font-bold gold-gradient mb-8">INDEPENDENCE</h1><p className="text-gray-400 mb-6">Select Language</p><div className="space-y-3">{LANGUAGES.map(l=>(<button key={l.code} onClick={()=>{setLang(l.code);setPhase('intro');}} className="w-full max-w-xs mx-auto flex items-center justify-center gap-3 py-4 bg-slate-800/50 border border-amber-500/30 rounded-xl hover:bg-slate-700/50 text-lg"><span className="text-2xl">{l.flag}</span><span>{l.name}</span></button>))}</div><button onClick={()=>{localStorage.clear();sessionStorage.clear();location.reload();}} className="mt-8 text-gray-600 hover:text-gray-400 text-xs">ğŸ”„ Reset</button></div></div>);
      }

      // INTRO
      if(phase==='intro'){
        const steps=[{title:t('intro.title'),text:t('intro.p1')},{text:t('intro.p2')},{text:t('intro.p3')},{text:t('intro.mission'),isLast:true}];
        const step=steps[introStep];
        return(<div className="min-h-screen bg-slate-950 text-white p-6 flex items-center justify-center"><StarBackground/><div className="max-w-lg mx-auto text-center relative z-10 animate-fadeIn"><div className="bg-slate-800/50 border border-amber-500/30 rounded-2xl p-8">{step.title&&<h2 className="text-2xl font-display text-amber-400 mb-6">{step.title}</h2>}<p className="text-lg text-gray-300 leading-relaxed mb-8">{step.text}</p><div className="flex gap-4">{introStep>0&&<button onClick={()=>setIntroStep(s=>s-1)} className="flex-1 py-3 bg-slate-700 hover:bg-slate-600 rounded-lg">{t('ui.back')}</button>}<button onClick={()=>{if(step.isLast)setPhase('title');else setIntroStep(s=>s+1);}} className="flex-1 py-3 bg-gradient-to-r from-amber-500 to-yellow-500 text-slate-900 rounded-lg font-bold">{step.isLast?t('ui.startGame'):t('ui.next')}</button></div><div className="flex justify-center gap-2 mt-6">{steps.map((_,i)=>(<div key={i} className={`w-2 h-2 rounded-full ${i===introStep?'bg-amber-500':'bg-slate-600'}`}/>))}</div></div><button onClick={()=>setPhase('title')} className="mt-4 text-gray-500 hover:text-gray-400 text-sm">{t('ui.skip')}</button></div></div>);
      }

      // TITLE
      if(phase==='title'){
        return(<div className="min-h-screen bg-slate-950 text-white p-4 relative"><StarBackground/><div className="max-w-md mx-auto pt-4 relative z-10">
          <div className="flex justify-between items-center mb-4"><div className="flex gap-2"><button onClick={()=>setShowLeaderboard(true)} className="p-2 bg-slate-800/50 rounded-lg hover:bg-slate-700">ğŸ†</button>{!isPremium&&<button onClick={()=>setShowPremium(true)} className="px-3 py-2 bg-gradient-to-r from-amber-500 to-yellow-500 text-slate-900 rounded-lg text-sm font-bold">â­ Premium</button>}</div>{user?<button onClick={()=>setShowProfile(true)} className="flex items-center gap-2 px-3 py-2 bg-slate-800/50 rounded-full hover:bg-slate-700"><div className="w-6 h-6 bg-amber-600 rounded-full flex items-center justify-center text-xs font-bold">{profile?.display_name?.[0]?.toUpperCase()||'ğŸ‘¤'}</div><span className="text-sm text-amber-300">{profile?.display_name||'Profile'}</span>{profile?.is_premium&&<span className="text-amber-400">â­</span>}</button>:<button onClick={()=>setShowAuth(true)} className="px-4 py-2 bg-amber-600 hover:bg-amber-500 rounded-full text-sm font-bold">{t('ui.login')}</button>}</div>

          <div className="text-center mb-6"><h1 className="text-4xl sm:text-5xl font-display font-bold gold-gradient mb-2">{t('ui.title')}</h1><p className="text-amber-200/60 text-sm tracking-widest">{t('ui.subtitle')}</p><button onClick={()=>{localStorage.removeItem('lang');setLang('');setPhase('lang');}} className="mt-3 text-gray-500 hover:text-gray-400 text-sm">ğŸŒ {lang==='ru'?'Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ ÑĞ·Ñ‹Ğº':lang==='en'?'Change language':'Sprache Ã¤ndern'}</button></div>

          <div className="mb-4"><label className="text-sm text-gray-400 block mb-2">ğŸŒ {t('ui.choosePlanet')}</label><div className="grid grid-cols-5 gap-2">{Object.entries(PLANETS).map(([id,p])=>(<button key={id} onClick={()=>setPlanetId(id)} className={`p-2 rounded-lg border text-center transition ${planetId===id?'border-amber-500 bg-amber-500/20':'border-slate-600 hover:border-slate-500'}`}><span className="text-2xl block">{p.icon}</span><span className="text-xs text-gray-400">{'â˜…'.repeat(p.difficulty)}</span></button>))}</div><div className="bg-slate-800/30 rounded-lg p-3 mt-2"><p className="text-amber-300 font-bold text-sm">{T.planets[planetId].name[lang]} <span className="text-gray-500 font-normal">â€¢ {T.planets[planetId].traits[lang]}</span></p><p className="text-gray-400 text-xs mt-1">{T.planets[planetId].desc[lang]}</p>{T.planets[planetId].quote&&<p className="text-amber-200/50 text-xs mt-2 italic">{T.planets[planetId].quote[lang]}</p>}</div></div>

          <div className="mb-4"><label className="text-sm text-gray-400 block mb-1">ğŸ“Š {t('ui.difficulty')}</label><div className="grid grid-cols-3 gap-2">{Object.entries(DIFFICULTIES).map(([key,d])=>(<button key={key} onClick={()=>setDifficulty(key)} className={`py-3 rounded-lg border text-sm transition ${difficulty===key?'border-amber-500 bg-amber-500/20 text-amber-300':'border-slate-600 text-gray-400 hover:border-slate-500'}`}>{d.icon} {t(`ui.${key}`)}</button>))}</div></div>

          <div className="mb-4"><label className="text-sm text-gray-400 block mb-1">â±ï¸ {t('ui.gameLength')}: {maxTurns} {t('ui.years')}</label><input type="range" min="10" max="30" step="5" value={maxTurns} onChange={e=>setMaxTurns(parseInt(e.target.value))} className="w-full" style={{background:`linear-gradient(90deg,#d97706 ${(maxTurns-10)/20*100}%,#1e293b ${(maxTurns-10)/20*100}%)`}}/></div>

          <div className="mb-4"><label className="text-sm text-gray-400 block mb-1">ğŸ›ï¸ {t('ui.politicalSystem')}</label><div className="grid grid-cols-2 gap-2">{Object.entries(SYSTEMS).map(([id,s])=>(<button key={id} onClick={()=>setSystem(id)} className={`p-3 rounded-lg border text-left transition ${system===id?'border-amber-500 bg-amber-500/10':'border-slate-600 hover:border-slate-500'} ${s.premium&&!isPremium?'opacity-60':''}`}><div className="flex items-center gap-2"><span className="text-xl">{s.icon}</span><span className="text-sm font-bold text-amber-200">{T.systems[id].name[lang]}</span>{s.premium&&!isPremium&&<span className="text-xs bg-amber-500/20 text-amber-400 px-1 rounded">â­</span>}</div></button>))}</div><div className="bg-slate-800/30 rounded-lg p-3 mt-2"><p className="text-gray-400 text-xs">{T.systems[system].desc[lang]}</p><div className="flex gap-4 mt-2 text-xs"><span className="text-green-400">âœ“ {T.systems[system].pros[lang]}</span><span className="text-red-400">âœ— {T.systems[system].cons[lang]}</span></div></div></div>

          <button onClick={()=>setShowAdvanced(!showAdvanced)} className="w-full text-sm text-gray-400 hover:text-gray-300 mb-4">{showAdvanced?'â–²':'â–¼'} {t('ui.advancedSettings')}</button>

          {showAdvanced&&(<div className="bg-slate-800/50 rounded-lg p-4 mb-4 space-y-4">
            <div><label className="text-sm text-gray-400">{t('ui.eventsPerTurn')}: {eventsPerTurn}</label><input type="range" min="1" max="4" value={eventsPerTurn} onChange={e=>setEventsPerTurn(parseInt(e.target.value))} className="w-full"/></div>
            <div><label className="text-sm text-gray-400">{t('ui.target')} {t('ui.happiness')}: {targetHappiness}%</label><input type="range" min="50" max="90" step="5" value={targetHappiness} onChange={e=>setTargetHappiness(parseInt(e.target.value))} className="w-full"/></div>
            <div><label className="text-sm text-gray-400">{t('ui.target')} {t('ui.wealth')}: {targetWealth}%</label><input type="range" min="50" max="90" step="5" value={targetWealth} onChange={e=>setTargetWealth(parseInt(e.target.value))} className="w-full"/></div>
            <div><label className="text-sm text-gray-400">{t('ui.target')} {t('ui.stability')}: {targetStability}%</label><input type="range" min="50" max="90" step="5" value={targetStability} onChange={e=>setTargetStability(parseInt(e.target.value))} className="w-full"/></div>
          </div>)}

          <button onClick={startGame} className="w-full py-4 bg-gradient-to-r from-amber-500 via-yellow-500 to-amber-500 text-slate-900 rounded-xl font-display font-bold text-lg hover:from-amber-400 hover:to-yellow-400">{t('ui.startGame')}</button>
        </div>
        {showAuth&&<AuthModal onClose={()=>setShowAuth(false)}/>}
        {showProfile&&<ProfileModal onClose={()=>setShowProfile(false)}/>}
        {showLeaderboard&&<LeaderboardModal onClose={()=>setShowLeaderboard(false)}/>}
        {showPremium&&<PremiumModal onClose={()=>setShowPremium(false)}/>}
        {toast&&<Toast message={toast.message} type={toast.type} onClose={()=>setToast(null)}/>}
        </div>);
      }

      // PLAYING
      if(phase==='playing'){
        const getStatColor=(value,target)=>value>=target?'text-green-400':value>=target-10?'text-amber-300':'text-red-400';
        return(<div className="min-h-screen bg-slate-950 text-white p-4"><StarBackground/><div className="max-w-md mx-auto relative z-10">
          <div className="flex justify-between items-center mb-4"><div className="flex items-center gap-2"><span className="text-2xl">{sys.icon}</span><span className="text-amber-300 font-bold">{T.systems[system].leader[lang]}</span></div><div className="text-right"><span className="text-amber-400 font-display">{t('ui.year')} {turn}/{maxTurns}</span><p className="text-xs text-gray-500">{T.planets[planetId].name[lang]}</p></div></div>

          <div className="bg-slate-800/50 rounded-xl p-4 border border-amber-500/20 mb-4">
            <div className="mb-2"><div className="flex justify-between text-xs mb-1"><span className="text-amber-100/80">ğŸ˜Š {t('ui.happiness')}</span><span className={`font-bold ${getStatColor(stats.happiness,targetHappiness)}`}>{Math.round(stats.happiness)}% <span className="text-gray-500">/ {targetHappiness}%</span></span></div><div className="h-2 bg-slate-900 rounded overflow-hidden border border-amber-900/30 relative"><div className="h-full bg-gradient-to-r from-green-600 to-green-400 transition-all duration-500" style={{width:`${Math.min(100,Math.max(0,stats.happiness))}%`}}/><div className="absolute top-0 bottom-0 w-0.5 bg-white/50" style={{left:`${targetHappiness}%`}}/></div></div>
            <div className="mb-2"><div className="flex justify-between text-xs mb-1"><span className="text-amber-100/80">ğŸ’° {t('ui.wealth')}</span><span className={`font-bold ${getStatColor(stats.wealth,targetWealth)}`}>{Math.round(stats.wealth)}% <span className="text-gray-500">/ {targetWealth}%</span></span></div><div className="h-2 bg-slate-900 rounded overflow-hidden border border-amber-900/30 relative"><div className="h-full bg-gradient-to-r from-yellow-600 to-yellow-400 transition-all duration-500" style={{width:`${Math.min(100,Math.max(0,stats.wealth))}%`}}/><div className="absolute top-0 bottom-0 w-0.5 bg-white/50" style={{left:`${targetWealth}%`}}/></div></div>
            <div className="mb-2"><div className="flex justify-between text-xs mb-1"><span className="text-amber-100/80">âš–ï¸ {t('ui.stability')}</span><span className={`font-bold ${getStatColor(stats.stability,targetStability)}`}>{Math.round(stats.stability)}% <span className="text-gray-500">/ {targetStability}%</span></span></div><div className="h-2 bg-slate-900 rounded overflow-hidden border border-amber-900/30 relative"><div className="h-full bg-gradient-to-r from-blue-600 to-blue-400 transition-all duration-500" style={{width:`${Math.min(100,Math.max(0,stats.stability))}%`}}/><div className="absolute top-0 bottom-0 w-0.5 bg-white/50" style={{left:`${targetStability}%`}}/></div></div>
            <div className="flex justify-between items-center mt-3 pt-3 border-t border-slate-700"><span className="text-amber-200/80">ğŸ’ {t('ui.budget')}</span><span className={`font-bold ${remaining<0?'text-red-400':'text-amber-300'}`}>{hydrobite} ({remaining>=0?'+':''}{remaining})</span></div>
          </div>

          <div className="bg-slate-800/50 rounded-xl p-4 border border-amber-500/20 mb-4">{SECTORS.map(sec=>(<div key={sec.id} className="mb-3"><div className="flex justify-between text-sm mb-1"><span className="text-amber-100/80">{sec.icon} {T.sectors[sec.id].name[lang]}</span><span className="text-amber-300 font-bold">{budget[sec.id]}</span></div><input type="range" min="0" max="50" value={budget[sec.id]} onChange={e=>handleBudget(sec.id,e.target.value)} className="w-full" style={{background:`linear-gradient(90deg,#d97706 ${budget[sec.id]*2}%,#1e293b ${budget[sec.id]*2}%)`}}/></div>))}</div>

          <button onClick={processTurn} disabled={remaining<0} className="w-full py-4 bg-gradient-to-r from-amber-500 to-yellow-500 text-slate-900 rounded-xl font-bold text-lg disabled:opacity-50">{t('ui.submit')}</button>
        </div>{toast&&<Toast message={toast.message} type={toast.type} onClose={()=>setToast(null)}/>}</div>);
      }

      // EVENT
      if(phase==='event'&&event){
        return(<div className="min-h-screen bg-slate-950 text-white p-4 flex items-center justify-center"><StarBackground/><div className="max-w-md w-full relative z-10 animate-slideUp"><div className="bg-slate-800 rounded-2xl border border-amber-500/30 overflow-hidden"><div className="bg-gradient-to-r from-amber-900/50 to-slate-800 p-6 text-center"><span className="text-5xl block mb-2">{event.icon}</span><h2 className="text-xl font-display font-bold text-amber-400">{event.title[lang]}</h2></div><div className="p-6"><p className="text-gray-300 text-center mb-6">{event.desc[lang]}</p><div className="space-y-3">{event.choices.map((choice,i)=>(<button key={i} onClick={()=>handleChoice(choice)} className="w-full p-4 bg-slate-700/50 hover:bg-slate-600/50 border border-slate-600 hover:border-amber-500/50 rounded-xl text-left transition"><div className="flex justify-between items-start mb-1"><span className="font-bold text-amber-200">{choice.text[lang]}</span><span className="text-amber-400 text-sm">-{choice.cost}ğŸ’</span></div><div className="flex gap-2 mt-2 text-xs">{Object.entries(choice.effects).map(([k,v])=>(<span key={k} className={v>=0?'text-green-400':'text-red-400'}>{k==='happiness'?'ğŸ˜Š':k==='wealth'?'ğŸ’°':'âš–ï¸'}{v>=0?'+':''}{v}</span>))}</div></button>))}</div></div></div></div></div>);
      }

      // VICTORY
      if(phase==='victory'){
        return(<div className="min-h-screen bg-slate-950 text-white p-4 flex items-center justify-center"><StarBackground/><div className="max-w-md w-full text-center relative z-10 animate-slideUp"><div className="bg-gradient-to-b from-amber-900/50 to-slate-800 rounded-2xl border border-amber-500/50 p-8"><span className="text-6xl block mb-4">ğŸ†</span><h1 className="text-3xl font-display font-bold gold-gradient mb-4">{t('ui.victory')}</h1><p className="text-amber-200 mb-6">{T.victoryMsg[victoryType||'survival']?.[lang]}</p><div className="bg-slate-800/50 rounded-xl p-4 mb-6"><div className="text-4xl font-bold text-amber-400 mb-2">{finalScore}</div><p className="text-gray-400">{t('ui.score')}</p></div><div className="grid grid-cols-3 gap-4 mb-6"><div className="text-center"><span className="text-2xl">ğŸ˜Š</span><p className="text-lg font-bold text-green-400">{Math.round(stats.happiness)}%</p></div><div className="text-center"><span className="text-2xl">ğŸ’°</span><p className="text-lg font-bold text-yellow-400">{Math.round(stats.wealth)}%</p></div><div className="text-center"><span className="text-2xl">âš–ï¸</span><p className="text-lg font-bold text-blue-400">{Math.round(stats.stability)}%</p></div></div><button onClick={()=>{setPhase('title');setIntroStep(0);}} className="w-full py-4 bg-gradient-to-r from-amber-500 to-yellow-500 text-slate-900 rounded-xl font-bold">{t('ui.playAgain')}</button></div></div></div>);
      }

      // GAMEOVER
      if(phase==='gameover'){
        return(<div className="min-h-screen bg-slate-950 text-white p-4 flex items-center justify-center"><StarBackground/><div className="max-w-md w-full text-center relative z-10 animate-slideUp"><div className="bg-gradient-to-b from-red-900/50 to-slate-800 rounded-2xl border border-red-500/50 p-8"><span className="text-6xl block mb-4">ğŸ’€</span><h1 className="text-3xl font-display font-bold text-red-400 mb-4">{t('ui.defeat')}</h1><p className="text-red-200 mb-6">{T.defeat[victoryType||'stability']?.[lang]}</p><div className="bg-slate-800/50 rounded-xl p-4 mb-6"><p className="text-gray-400">{t('ui.year')} {turn} / {maxTurns}</p><p className="text-2xl font-bold text-red-400">{finalScore} {t('ui.score')}</p></div><button onClick={()=>{setPhase('title');setIntroStep(0);}} className="w-full py-4 bg-gradient-to-r from-red-600 to-red-500 text-white rounded-xl font-bold">{t('ui.playAgain')}</button></div></div></div>);
      }
      return null;
    }

    function App(){return(<ContentProvider><AuthProvider><LangProvider><Game/></LangProvider></AuthProvider></ContentProvider>);}
    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
  <script>
    // Cleanup on load
    if('serviceWorker' in navigator){navigator.serviceWorker.getRegistrations().then(r=>r.forEach(r=>r.unregister()));caches.keys().then(k=>k.forEach(k=>caches.delete(k)));}
    // Reset function for debugging
    window.resetGame=()=>{localStorage.clear();sessionStorage.clear();location.reload();};
    // Auto-reset if stuck (check via URL param)
    if(location.search.includes('reset')){localStorage.clear();sessionStorage.clear();history.replaceState({},'',location.pathname);location.reload();}
  </script>
</body>
</html>
