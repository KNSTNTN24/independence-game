<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#d97706">
  <meta name="description" content="Independence - –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –∏–≥—Ä–∞ –æ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∏—Å—Ç–µ–º–∞—Ö">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Independence">
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/svg+xml" href="/icon-192.svg">
  <title>Independence - Civic Education Game</title>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- React & Tools -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Raleway:wght@300;400;600;700&display=swap');
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { margin: 0; padding: 0; font-family: 'Raleway', sans-serif; background: #0f172a; overscroll-behavior: none; }
    .safe-top { padding-top: env(safe-area-inset-top); }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    .font-display { font-family: 'Cinzel', serif; }
    .gold-gradient { background: linear-gradient(180deg, #fbbf24 0%, #d97706 50%, #92400e 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .glow-amber { box-shadow: 0 0 20px rgba(251, 191, 36, 0.3); }
    input[type="range"] { -webkit-appearance: none; height: 8px; border-radius: 4px; }
    input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 28px; height: 28px; border-radius: 50%; background: linear-gradient(180deg, #fbbf24, #d97706); cursor: pointer; }
    input[type="range"]::-moz-range-thumb { width: 28px; height: 28px; border-radius: 50%; border: none; background: linear-gradient(180deg, #fbbf24, #d97706); cursor: pointer; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes confetti { 0% { transform: translateY(0) rotate(0); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
    .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
    .animate-slideUp { animation: slideUp 0.4s ease-out; }
    .animate-pulse { animation: pulse 2s infinite; }
    .animate-spin { animation: spin 1s linear infinite; }
    button { min-height: 44px; cursor: pointer; transition: all 0.15s; }
    button:active { transform: scale(0.97); }
    input:not([type="range"]), button { font-family: inherit; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100; display: flex; align-items: center; justify-content: center; padding: 1rem; }
    .toast { position: fixed; top: 1rem; left: 50%; transform: translateX(-50%); z-index: 200; max-width: 90%; }
    .star-bg { position: fixed; inset: 0; overflow: hidden; pointer-events: none; z-index: 0; }
    .star { position: absolute; width: 2px; height: 2px; background: white; border-radius: 50%; opacity: 0.5; }
  </style>
</head>
<body class="safe-top safe-bottom">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback, createContext, useContext, useMemo } = React;

    // ============================================
    // ‚ö†Ô∏è SUPABASE CONFIG - –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ò –î–ê–ù–ù–´–ï!
    // ============================================
    const SUPABASE_URL = 'https://dnkeinsedcrlhwbiycfo.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRua2VpbnNlZGNybGh3Yml5Y2ZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NDg0MjgsImV4cCI6MjA4NDMyNDQyOH0.9IkWv6dwOemaVwvWrwq7ZzuebrgWI83JWrdaZbzdhhw';
    
    // Initialize Supabase client
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ============================================
    // STRIPE CONFIG
    // ============================================
    const STRIPE_PUBLISHABLE_KEY = 'pk_live_51SrFQOH02sKb65Xcey2pn7bvJhJQ1EqpjYyAoiVKK3OmGZjlKCMRmuX4t6zUitqQ2RHI7MIceHAkHYadAi4r31D900L7ki97pX';
    const PREMIUM_PRICE = '¬£2.99/–º–µ—Å';

    // ============================================
    // AUTH CONTEXT
    // ============================================
    const AuthContext = createContext(null);
    const useAuth = () => useContext(AuthContext);

    function AuthProvider({ children }) {
      const [user, setUser] = useState(null);
      const [profile, setProfile] = useState(null);
      const [loading, setLoading] = useState(true);
      const [initialized, setInitialized] = useState(false);

      // Load profile from Supabase
      const loadProfile = useCallback(async (userId) => {
        try {
          const { data, error } = await supabase
            .from('profiles')
            .select('*')
            .eq('id', userId)
            .single();
          if (!error && data) {
            setProfile(data);
          }
        } catch (e) {
          console.error('Profile load error:', e);
        }
      }, []);

      // Initialize auth state
      useEffect(() => {
        // Get initial session
        supabase.auth.getSession().then(({ data: { session } }) => {
          const currentUser = session?.user ?? null;
          setUser(currentUser);
          if (currentUser) {
            loadProfile(currentUser.id);
          }
          setLoading(false);
          setInitialized(true);
        });

        // Listen for auth changes
        const { data: { subscription } } = supabase.auth.onAuthStateChange(
          async (event, session) => {
            const currentUser = session?.user ?? null;
            setUser(currentUser);
            
            if (currentUser) {
              await loadProfile(currentUser.id);
            } else {
              setProfile(null);
            }
            setLoading(false);
          }
        );

        return () => subscription.unsubscribe();
      }, [loadProfile]);

      // Auth methods
      const signUp = async (email, password, username) => {
        const { data, error } = await supabase.auth.signUp({
          email,
          password,
          options: {
            data: { username, full_name: username }
          }
        });
        if (error) throw error;
        return data;
      };

      const signIn = async (email, password) => {
        const { data, error } = await supabase.auth.signInWithPassword({
          email,
          password
        });
        if (error) throw error;
        return data;
      };

      const signInWithGoogle = async () => {
        const { data, error } = await supabase.auth.signInWithOAuth({
          provider: 'google',
          options: { redirectTo: window.location.origin }
        });
        if (error) throw error;
        return data;
      };

      const signOut = async () => {
        const { error } = await supabase.auth.signOut();
        if (error) throw error;
        setUser(null);
        setProfile(null);
      };

      const updateProfile = async (updates) => {
        if (!user) return { error: 'Not authenticated' };
        const { data, error } = await supabase
          .from('profiles')
          .update({ ...updates, updated_at: new Date().toISOString() })
          .eq('id', user.id)
          .select()
          .single();
        if (!error && data) setProfile(data);
        return { data, error };
      };

      const refreshProfile = () => user && loadProfile(user.id);

      const value = {
        user,
        profile,
        loading,
        initialized,
        signUp,
        signIn,
        signInWithGoogle,
        signOut,
        updateProfile,
        refreshProfile
      };

      return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;
    }

    // ============================================
    // DATABASE FUNCTIONS
    // ============================================
    const db = {
      // Save game result
      async saveGameResult(userId, gameData) {
        const { data, error } = await supabase
          .from('game_results')
          .insert({
            user_id: userId,
            planet_name: gameData.planet,
            political_system: gameData.system,
            difficulty: gameData.difficulty,
            max_turns: gameData.maxTurns,
            final_turn: gameData.turn,
            final_happiness: Math.round(gameData.stats.happiness),
            final_wealth: Math.round(gameData.stats.wealth),
            final_stability: Math.round(gameData.stats.stability),
            final_hydrobite: gameData.hydrobite,
            is_victory: gameData.isVictory,
            victory_type: gameData.victoryType,
            score: gameData.score,
            duration_seconds: gameData.duration,
          })
          .select()
          .single();
        return { data, error };
      },

      // Get user's game history
      async getGameHistory(userId, limit = 20) {
        const { data, error } = await supabase
          .from('game_results')
          .select('*')
          .eq('user_id', userId)
          .order('finished_at', { ascending: false })
          .limit(limit);
        return { data: data || [], error };
      },

      // Get leaderboard
      async getLeaderboard(limit = 50) {
        const { data, error } = await supabase
          .from('leaderboard')
          .select('*')
          .limit(limit);
        return { data: data || [], error };
      },

      // Get user achievements
      async getUserAchievements(userId) {
        const { data, error } = await supabase
          .from('user_achievements')
          .select('*, achievements(*)')
          .eq('user_id', userId);
        return { data: data || [], error };
      },

      // Unlock achievement
      async unlockAchievement(userId, achievementId, gameId = null) {
        const { data, error } = await supabase
          .from('user_achievements')
          .insert({
            user_id: userId,
            achievement_id: achievementId,
            game_id: gameId
          })
          .select()
          .single();
        // Ignore duplicate key error
        if (error?.code === '23505') return { data: null, error: null };
        return { data, error };
      },

      // Get all achievements definitions
      async getAllAchievements() {
        const { data, error } = await supabase
          .from('achievements')
          .select('*')
          .order('points', { ascending: false });
        return { data: data || [], error };
      }
    };

    // ============================================
    // GAME CONFIGURATION
    // ============================================
    const DIFFICULTIES = {
      easy: { name: '–õ–µ–≥–∫–æ', icon: 'üå±', bonus: 10, hydroBonus: 20, severity: 0.7 },
      normal: { name: '–ù–æ—Ä–º–∞–ª—å–Ω–æ', icon: '‚öñÔ∏è', bonus: 0, hydroBonus: 0, severity: 1.0 },
      hard: { name: '–°–ª–æ–∂–Ω–æ', icon: 'üî•', bonus: -10, hydroBonus: -15, severity: 1.3 },
    };

    const SYSTEMS = {
      parliamentary: {
        id: 'parliamentary', name: '–ü–∞—Ä–ª–∞–º–µ–Ω—Ç—Å–∫–∞—è –¥–µ–º–æ–∫—Ä–∞—Ç–∏—è', icon: 'üèõÔ∏è',
        leader: '–ü—Ä–µ–º—å–µ—Ä-–º–∏–Ω–∏—Å—Ç—Ä', premium: false, color: 'indigo',
        desc: '–ü–∞—Ä–ª–∞–º–µ–Ω—Ç —É—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –±—é–¥–∂–µ—Ç. –ù—É–∂–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–∞—Ä–æ–¥–∞.',
        traits: { needsApproval: true, threshold: 40, stabilityBonus: 0, happinessDecay: 0, wealthBonus: 0 }
      },
      presidential: {
        id: 'presidential', name: '–ü—Ä–µ–∑–∏–¥–µ–Ω—Ç—Å–∫–∞—è —Ä–µ—Å–ø—É–±–ª–∏–∫–∞', icon: 'ü¶Ö',
        leader: '–ü—Ä–µ–∑–∏–¥–µ–Ω—Ç', premium: false, color: 'blue',
        desc: '–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –≤–ª–∞—Å—Ç—å —Å —Å–∏—Å—Ç–µ–º–æ–π —Å–¥–µ—Ä–∂–µ–∫.',
        traits: { needsApproval: false, threshold: 0, stabilityBonus: 0, happinessDecay: 0, wealthBonus: 5 }
      },
      monarchy: {
        id: 'monarchy', name: '–ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏–æ–Ω–Ω–∞—è –º–æ–Ω–∞—Ä—Ö–∏—è', icon: 'üëë',
        leader: '–ú–æ–Ω–∞—Ä—Ö', premium: true, color: 'purple',
        desc: '–¢—Ä–∞–¥–∏—Ü–∏–∏ –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å. –†–∏—Å–∫ –≤–æ—Å—Å—Ç–∞–Ω–∏—è.',
        traits: { needsApproval: false, threshold: 0, stabilityBonus: 10, happinessDecay: 0, wealthBonus: 0, rebellionRisk: 25 }
      },
      dictatorship: {
        id: 'dictatorship', name: '–î–∏–∫—Ç–∞—Ç—É—Ä–∞', icon: '‚öîÔ∏è',
        leader: '–í–µ—Ä—Ö–æ–≤–Ω—ã–π –ª–∏–¥–µ—Ä', premium: true, color: 'red',
        desc: '–ê–±—Å–æ–ª—é—Ç–Ω–∞—è –≤–ª–∞—Å—Ç—å. –ù–∞—Ä–æ–¥ –Ω–µ–¥–æ–≤–æ–ª–µ–Ω.',
        traits: { needsApproval: false, threshold: 0, stabilityBonus: 5, happinessDecay: 5, wealthBonus: 0, coupRisk: 30 }
      },
      technocracy: {
        id: 'technocracy', name: '–¢–µ—Ö–Ω–æ–∫—Ä–∞—Ç–∏—è', icon: 'üî¨',
        leader: '–ì–ª–∞–≤–Ω—ã–π —Ç–µ—Ö–Ω–æ–ª–æ–≥', premium: true, color: 'cyan',
        desc: '–ü—Ä–∞–≤–ª–µ–Ω–∏–µ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤. –í—ã—Å–æ–∫–∏–π –¥–æ—Ö–æ–¥.',
        traits: { needsApproval: false, threshold: 0, stabilityBonus: 5, happinessDecay: 2, wealthBonus: 15, startPenalty: 10 }
      },
      direct: {
        id: 'direct', name: '–ü—Ä—è–º–∞—è –¥–µ–º–æ–∫—Ä–∞—Ç–∏—è', icon: 'üó≥Ô∏è',
        leader: '–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä', premium: true, color: 'green',
        desc: '–ì—Ä–∞–∂–¥–∞–Ω–µ –≥–æ–ª–æ—Å—É—é—Ç –∑–∞ –≤—Å—ë. –ú–µ–¥–ª–µ–Ω–Ω–æ, –Ω–æ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ.',
        traits: { needsApproval: false, threshold: 0, stabilityBonus: -5, happinessDecay: -3, wealthBonus: 0, referendumChance: 0.25 }
      },
    };

    const SECTORS = [
      { id: 'defence', name: '–û–±–æ—Ä–æ–Ω–∞', icon: 'üõ°Ô∏è' },
      { id: 'education', name: '–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ', icon: 'üìö' },
      { id: 'health', name: '–ó–¥—Ä–∞–≤–æ–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ', icon: 'üè•' },
      { id: 'infra', name: '–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞', icon: 'üèóÔ∏è' },
      { id: 'welfare', name: '–°–æ—Ü–∑–∞—â–∏—Ç–∞', icon: 'ü§ù' },
    ];

    const EVENTS = [
      { id: 'pandemic', title: '–≠–ø–∏–¥–µ–º–∏—è', desc: '–û–ø–∞—Å–Ω—ã–π –≤–∏—Ä—É—Å —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è –ø–æ –ø–ª–∞–Ω–µ—Ç–µ.', icon: 'ü¶†', category: 'crisis',
        choices: [
          { text: '–ñ—ë—Å—Ç–∫–∏–π –∫–∞—Ä–∞–Ω—Ç–∏–Ω', effects: { happiness: -20, wealth: -15, stability: 10 }, cost: 30, hint: '–°–ø–∞—Å—ë—Ç –∂–∏–∑–Ω–∏, –Ω–æ —É–¥–∞—Ä–∏—Ç –ø–æ —ç–∫–æ–Ω–æ–º–∏–∫–µ' },
          { text: '–£–º–µ—Ä–µ–Ω–Ω—ã–µ –º–µ—Ä—ã', effects: { happiness: -10, wealth: -8, stability: 5 }, cost: 15, hint: '–ë–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –∑–¥–æ—Ä–æ–≤—å–µ–º –∏ —ç–∫–æ–Ω–æ–º–∏–∫–æ–π' },
          { text: '–ù–µ –≤–º–µ—à–∏–≤–∞—Ç—å—Å—è', effects: { happiness: 5, stability: -20 }, cost: 0, hint: '–†–∏—Å–∫–æ–≤–∞–Ω–Ω–æ ‚Äî –≤–æ–∑–º–æ–∂–Ω—ã –∂–µ—Ä—Ç–≤—ã' },
        ]},
      { id: 'strike', title: '–í—Å–µ–æ–±—â–∞—è –∑–∞–±–∞—Å—Ç–æ–≤–∫–∞', desc: '–†–∞–±–æ—á–∏–µ —Ç—Ä–µ–±—É—é—Ç —É–ª—É—á—à–µ–Ω–∏—è —É—Å–ª–æ–≤–∏–π —Ç—Ä—É–¥–∞.', icon: '‚úä', category: 'social',
        choices: [
          { text: '–ü—Ä–∏–Ω—è—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è', effects: { happiness: 25, wealth: -20 }, cost: 25, hint: '–ù–∞—Ä–æ–¥ –±—É–¥–µ—Ç –¥–æ–≤–æ–ª–µ–Ω' },
          { text: '–ß–∞—Å—Ç–∏—á–Ω—ã–µ —É—Å—Ç—É–ø–∫–∏', effects: { happiness: 10, wealth: -8, stability: 5 }, cost: 12, hint: '–ö–æ–º–ø—Ä–æ–º–∏—Å—Å' },
          { text: '–ü–æ–¥–∞–≤–∏—Ç—å –∑–∞–±–∞—Å—Ç–æ–≤–∫—É', effects: { happiness: -25, stability: -15, wealth: 8 }, cost: 15, hint: '–û–ø–∞—Å–Ω–æ!' },
        ]},
      { id: 'discovery', title: '–ú–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–µ –≥–∏–¥—Ä–æ–±–∏—Ç–∞!', desc: '–ì–µ–æ–ª–æ–≥–∏ –æ–±–Ω–∞—Ä—É–∂–∏–ª–∏ –æ–≥—Ä–æ–º–Ω—ã–µ –∑–∞–ª–µ–∂–∏ —Ä–µ—Å—É—Ä—Å–∞.', icon: 'üíé', category: 'opportunity',
        choices: [
          { text: '–ù–∞—Ü–∏–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å', effects: { happiness: 12, wealth: 18, stability: 5 }, cost: 25, hydro: 50, hint: '–†–µ—Å—É—Ä—Å—ã –Ω–∞—Ä–æ–¥—É!' },
          { text: '–û—Ç–¥–∞—Ç—å –∫–æ—Ä–ø–æ—Ä–∞—Ü–∏—è–º', effects: { wealth: 30, happiness: -12 }, cost: 5, hydro: 30, hint: '–ë—ã—Å—Ç—Ä–∞—è –ø—Ä–∏–±—ã–ª—å' },
          { text: '–°–æ–∑–¥–∞—Ç—å —Ñ–æ–Ω–¥', effects: { stability: 20, wealth: 10, happiness: 8 }, cost: 15, hydro: 25, hint: '–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è' },
        ]},
      { id: 'reform', title: '–î–≤–∏–∂–µ–Ω–∏–µ –∑–∞ —Ä–µ—Ñ–æ—Ä–º—ã', desc: '–ê–∫—Ç–∏–≤–∏—Å—Ç—ã —Ç—Ä–µ–±—É—é—Ç –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π.', icon: 'üìú', category: 'political',
        choices: [
          { text: '–ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å —Ä–µ—Ñ–æ—Ä–º—ã', effects: { happiness: 18, stability: -8 }, cost: 15, hint: '–ü—Ä–æ–≥—Ä–µ—Å—Å —Ç—Ä–µ–±—É–µ—Ç –∂–µ—Ä—Ç–≤' },
          { text: '–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è', effects: { happiness: 8, stability: 5 }, cost: 8, hint: '–û—Å—Ç–æ—Ä–æ–∂–Ω—ã–π –ø—É—Ç—å' },
          { text: '–ü–æ–¥–∞–≤–∏—Ç—å –¥–≤–∏–∂–µ–Ω–∏–µ', effects: { happiness: -20, stability: 12 }, cost: 12, hint: '–ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å' },
        ]},
      { id: 'disaster', title: '–ú–µ—Ç–µ–æ—Ä–∏—Ç–Ω—ã–π —à—Ç–æ—Ä–º', desc: '–ö–æ—Å–º–∏—á–µ—Å–∫–∏–µ –æ–±–ª–æ–º–∫–∏ —É–≥—Ä–æ–∂–∞—é—Ç –ø–ª–∞–Ω–µ—Ç–µ.', icon: '‚òÑÔ∏è', category: 'crisis',
        choices: [
          { text: '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞', effects: { stability: 15, wealth: -15 }, cost: 30, hint: '–î–æ—Ä–æ–≥–æ, –Ω–æ –Ω–∞–¥—ë–∂–Ω–æ' },
          { text: '–≠–≤–∞–∫—É–∞—Ü–∏—è', effects: { happiness: -12, stability: 8 }, cost: 15, hint: '–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –≤–∞–∂–Ω–µ–µ' },
          { text: '–ü–æ–ª–æ–∂–∏—Ç—å—Å—è –Ω–∞ —É–¥–∞—á—É', effects: { stability: -20 }, cost: 0, hint: '–û—á–µ–Ω—å —Ä–∏—Å–∫–æ–≤–∞–Ω–Ω–æ!' },
        ]},
      { id: 'tech', title: '–ù–∞—É—á–Ω—ã–π –ø—Ä–æ—Ä—ã–≤!', desc: '–£—á—ë–Ω—ã–µ —Å–æ–≤–µ—Ä—à–∏–ª–∏ –≤–∞–∂–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ.', icon: 'üî¨', category: 'opportunity',
        choices: [
          { text: '–ú–∞—Å—à—Ç–∞–±–Ω–æ–µ —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ', effects: { wealth: 20, happiness: 12, stability: 5 }, cost: 30, hint: '–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏—è –≤ –±—É–¥—É—â–µ–µ' },
          { text: '–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å –º–∏—Ä–æ–º', effects: { happiness: 15, stability: 8 }, cost: 10, hint: '–î–∏–ø–ª–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±–æ–Ω—É—Å' },
          { text: '–ó–∞—Å–µ–∫—Ä–µ—Ç–∏—Ç—å', effects: { wealth: 12, stability: -8 }, cost: 8, hint: '–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ, –Ω–æ —Ä–∏—Å–∫–∏' },
        ]},
      { id: 'festival', title: '–ü—Ä–∞–∑–¥–Ω–∏–∫ –ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏', desc: '–ì–æ–¥–æ–≤—â–∏–Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏—è –≤–∞—à–µ–π —Ü–∏–≤–∏–ª–∏–∑–∞—Ü–∏–∏!', icon: 'üéâ', category: 'social',
        choices: [
          { text: '–ì—Ä–∞–Ω–¥–∏–æ–∑–Ω—ã–π –ø—Ä–∞–∑–¥–Ω–∏–∫', effects: { happiness: 25, wealth: -8 }, cost: 25, hint: '–ù–∞—Ä–æ–¥ –≤ –≤–æ—Å—Ç–æ—Ä–≥–µ!' },
          { text: '–°–∫—Ä–æ–º–Ω–æ–µ –ø—Ä–∞–∑–¥–Ω–æ–≤–∞–Ω–∏–µ', effects: { happiness: 12, wealth: -2 }, cost: 10, hint: '–†–∞–∑—É–º–Ω—ã–π –±–∞–ª–∞–Ω—Å' },
          { text: '–û—Ç–º–µ–Ω–∏—Ç—å', effects: { happiness: -8, wealth: 5 }, cost: 0, hint: '–≠–∫–æ–Ω–æ–º–∏—è, –Ω–æ —Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω–∏–µ' },
        ]},
      { id: 'corruption', title: '–ö–æ—Ä—Ä—É–ø—Ü–∏–æ–Ω–Ω—ã–π —Å–∫–∞–Ω–¥–∞–ª', desc: '–†–∞–∑–æ–±–ª–∞—á–µ–Ω–∞ —Å—Ö–µ–º–∞ —Ö–∏—â–µ–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤.', icon: 'üí∞', category: 'political',
        choices: [
          { text: '–ü—É–±–ª–∏—á–Ω–æ–µ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ', effects: { happiness: 18, stability: -12, wealth: -5 }, cost: 18, hint: '–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –≤–∞–∂–Ω–∞' },
          { text: '–¢–∏—Ö–∏–µ —Ä–µ—Ñ–æ—Ä–º—ã', effects: { stability: 8, happiness: -5 }, cost: 10, hint: '–ë–µ–∑ –ª–∏—à–Ω–µ–≥–æ —à—É–º–∞' },
          { text: '–ó–∞–º—è—Ç—å —Å–∫–∞–Ω–¥–∞–ª', effects: { happiness: -18, stability: -8 }, cost: 5, hint: '–ú–æ–∂–µ—Ç –≤—Å–ø–ª—ã—Ç—å –ø–æ–∑–∂–µ' },
        ]},
      { id: 'immigration', title: '–í–æ–ª–Ω–∞ –±–µ–∂–µ–Ω—Ü–µ–≤', desc: '–¢—ã—Å—è—á–∏ –ª—é–¥–µ–π –ø—Ä–æ—Å—è—Ç —É–±–µ–∂–∏—â–∞.', icon: 'üöÄ', category: 'social',
        choices: [
          { text: '–û—Ç–∫—Ä—ã—Ç—å –≥—Ä–∞–Ω–∏—Ü—ã', effects: { happiness: -5, wealth: 12, stability: -8 }, cost: 20, hint: '–†–∞–±–æ—á–∞—è —Å–∏–ª–∞' },
          { text: '–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –ø—Ä–∏—ë–º', effects: { happiness: 5, wealth: 5, stability: 3 }, cost: 12, hint: '–ë–∞–ª–∞–Ω—Å' },
          { text: '–ó–∞–∫—Ä—ã—Ç—å –≥—Ä–∞–Ω–∏—Ü—ã', effects: { happiness: -10, stability: 10 }, cost: 5, hint: '–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Ü–µ–Ω–æ–π —Ä–µ–ø—É—Ç–∞—Ü–∏–∏' },
        ]},
      { id: 'energy', title: '–≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –∫—Ä–∏–∑–∏—Å', desc: '–ó–∞–ø–∞—Å—ã —Ç–æ–ø–ª–∏–≤–∞ –Ω–∞ –∏—Å—Ö–æ–¥–µ.', icon: '‚ö°', category: 'crisis',
        choices: [
          { text: '–ó–µ–ª—ë–Ω–∞—è —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞', effects: { wealth: -12, happiness: 10, stability: 5 }, cost: 28, hydro: -10, hint: '–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ' },
          { text: '–ñ—ë—Å—Ç–∫–∞—è —ç–∫–æ–Ω–æ–º–∏—è', effects: { happiness: -15, wealth: 8 }, cost: 5, hint: '–ë—ã—Å—Ç—Ä–æ, –Ω–æ –±–æ–ª—å–Ω–æ' },
          { text: '–ó–∞–∫—É–ø–∫–∞ —É —Å–æ—Å–µ–¥–µ–π', effects: { wealth: -15, stability: -5 }, cost: 20, hydro: 30, hint: '–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å' },
        ]},
    ];

    // Achievement definitions (for display before DB loads)
    const ACHIEVEMENT_DEFS = {
      first_win: { name: '–ü–µ—Ä–≤–∞—è –ø–æ–±–µ–¥–∞', icon: 'üèÜ', desc: '–í—ã–∏–≥—Ä–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∏–≥—Ä—É' },
      parliamentarian: { name: '–ü–∞—Ä–ª–∞–º–µ–Ω—Ç–∞—Ä–∏–π', icon: 'üèõÔ∏è', desc: '–ü–æ–±–µ–¥–∏—Ç–µ –∑–∞ –¥–µ–º–æ–∫—Ä–∞—Ç–∏—é' },
      president: { name: '–ü—Ä–µ–∑–∏–¥–µ–Ω—Ç', icon: 'ü¶Ö', desc: '–ü–æ–±–µ–¥–∏—Ç–µ –∑–∞ —Ä–µ—Å–ø—É–±–ª–∏–∫—É' },
      monarch: { name: '–ú–æ–Ω–∞—Ä—Ö', icon: 'üëë', desc: '–ü–æ–±–µ–¥–∏—Ç–µ –∑–∞ –º–æ–Ω–∞—Ä—Ö–∏—é' },
      dictator: { name: '–î–∏–∫—Ç–∞—Ç–æ—Ä', icon: '‚öîÔ∏è', desc: '–ü–æ–±–µ–¥–∏—Ç–µ –∑–∞ –¥–∏–∫—Ç–∞—Ç—É—Ä—É' },
      utopia: { name: '–£—Ç–æ–ø–∏—è', icon: 'üòä', desc: '95% —Å—á–∞—Å—Ç—å—è' },
      prosperity: { name: '–ü—Ä–æ—Ü–≤–µ—Ç–∞–Ω–∏–µ', icon: 'üí∞', desc: '95% –±–æ–≥–∞—Ç—Å—Ç–≤–∞' },
      survivor: { name: '–í—ã–∂–∏–≤—à–∏–π', icon: 'üí™', desc: '–ü–æ–±–µ–¥–∞ –Ω–∞ —Å–ª–æ–∂–Ω–æ–º' },
      speedrun: { name: '–°–ø–∏–¥—Ä–∞–Ω–Ω–µ—Ä', icon: '‚ö°', desc: '–ü–æ–±–µ–¥–∞ –∑–∞ 10 —Ö–æ–¥–æ–≤' },
      perfectionist: { name: '–ü–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏—Å—Ç', icon: '‚≠ê', desc: '80%+ –≤–µ–∑–¥–µ' },
      high_score: { name: '–†–µ–∫–æ—Ä–¥—Å–º–µ–Ω', icon: 'üéØ', desc: '100+ –æ—á–∫–æ–≤' },
      veteran: { name: '–í–µ—Ç–µ—Ä–∞–Ω', icon: 'üéñÔ∏è', desc: '10 –∏–≥—Ä' },
    };

    // ============================================
    // UI COMPONENTS
    // ============================================
    const Spinner = ({ size = 'md' }) => {
      const sizes = { sm: 'w-5 h-5', md: 'w-8 h-8', lg: 'w-12 h-12' };
      return (
        <div className="flex justify-center py-4">
          <div className={`${sizes[size]} border-4 border-amber-500 border-t-transparent rounded-full animate-spin`}></div>
        </div>
      );
    };

    const Toast = ({ message, type = 'info', onClose }) => {
      useEffect(() => {
        const timer = setTimeout(onClose, 3000);
        return () => clearTimeout(timer);
      }, [onClose]);

      const colors = {
        success: 'bg-green-900/90 border-green-500 text-green-200',
        error: 'bg-red-900/90 border-red-500 text-red-200',
        warning: 'bg-yellow-900/90 border-yellow-500 text-yellow-200',
        info: 'bg-blue-900/90 border-blue-500 text-blue-200',
        achievement: 'bg-amber-900/90 border-amber-500 text-amber-200',
      };

      return (
        <div className={`toast ${colors[type]} border px-4 py-3 rounded-lg shadow-lg animate-slideUp`}>
          {message}
        </div>
      );
    };

    const Modal = ({ children, onClose, title }) => (
      <div className="modal-overlay animate-fadeIn" onClick={onClose}>
        <div className="bg-slate-800 rounded-xl max-w-md w-full max-h-[85vh] overflow-hidden border border-amber-500/30 animate-slideUp"
             onClick={e => e.stopPropagation()}>
          {title && (
            <div className="flex justify-between items-center p-4 border-b border-slate-700">
              <h2 className="text-lg font-display font-bold text-amber-400">{title}</h2>
              <button onClick={onClose} className="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
          )}
          <div className="p-4 overflow-y-auto max-h-[calc(85vh-60px)]">
            {children}
          </div>
        </div>
      </div>
    );

    const StatBar = ({ label, value, icon, color }) => (
      <div className="mb-2">
        <div className="flex justify-between text-xs mb-1">
          <span className="text-amber-100/80">{icon} {label}</span>
          <span className={`font-bold ${value < 30 ? 'text-red-400' : value > 70 ? 'text-green-400' : 'text-amber-300'}`}>
            {Math.round(value)}%
          </span>
        </div>
        <div className="h-2 bg-slate-900 rounded overflow-hidden border border-amber-900/30">
          <div className={`h-full ${color} transition-all duration-500`} 
               style={{ width: `${Math.min(100, Math.max(0, value))}%` }}/>
        </div>
      </div>
    );

    const StarBackground = () => {
      const stars = useMemo(() => 
        Array.from({ length: 50 }, (_, i) => ({
          id: i,
          left: Math.random() * 100,
          top: Math.random() * 100,
          size: Math.random() * 2 + 1,
          delay: Math.random() * 3
        })), []);

      return (
        <div className="star-bg">
          {stars.map(s => (
            <div key={s.id} className="star animate-pulse" style={{
              left: `${s.left}%`, top: `${s.top}%`,
              width: `${s.size}px`, height: `${s.size}px`,
              animationDelay: `${s.delay}s`
            }}/>
          ))}
        </div>
      );
    };

    // ============================================
    // AUTH MODAL
    // ============================================
    const AuthModal = ({ onClose, initialMode = 'login' }) => {
      const { signIn, signUp, signInWithGoogle } = useAuth();
      const [mode, setMode] = useState(initialMode);
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [username, setUsername] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);
      const [success, setSuccess] = useState('');

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setSuccess('');
        setLoading(true);

        try {
          if (mode === 'login') {
            await signIn(email, password);
            onClose();
          } else {
            if (!username.trim()) throw new Error('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            if (password.length < 6) throw new Error('–ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤');
            await signUp(email, password, username.trim());
            setSuccess('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è!');
          }
        } catch (err) {
          setError(err.message || '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
        } finally {
          setLoading(false);
        }
      };

      return (
        <Modal onClose={onClose} title={mode === 'login' ? 'üîë –í—Ö–æ–¥' : 'üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è'}>
          {error && <div className="bg-red-900/50 text-red-300 p-3 rounded-lg mb-4 text-sm">{error}</div>}
          {success && <div className="bg-green-900/50 text-green-300 p-3 rounded-lg mb-4 text-sm">{success}</div>}

          <form onSubmit={handleSubmit} className="space-y-3">
            {mode === 'register' && (
              <div>
                <label className="text-xs text-gray-400 block mb-1">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                <input type="text" value={username} onChange={e => setUsername(e.target.value)}
                  className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white focus:border-amber-500 outline-none"
                  placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º"/>
              </div>
            )}
            <div>
              <label className="text-xs text-gray-400 block mb-1">Email</label>
              <input type="email" value={email} onChange={e => setEmail(e.target.value)} required
                className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white focus:border-amber-500 outline-none"
                placeholder="email@example.com"/>
            </div>
            <div>
              <label className="text-xs text-gray-400 block mb-1">–ü–∞—Ä–æ–ª—å</label>
              <input type="password" value={password} onChange={e => setPassword(e.target.value)} required minLength={6}
                className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white focus:border-amber-500 outline-none"
                placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤"/>
            </div>
            
            <button type="submit" disabled={loading}
              className="w-full py-3 bg-amber-600 hover:bg-amber-500 disabled:bg-slate-600 rounded-lg font-bold transition">
              {loading ? <Spinner size="sm" /> : mode === 'login' ? '–í–æ–π—Ç–∏' : '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è'}
            </button>
          </form>

          <div className="my-4 flex items-center gap-3">
            <div className="flex-1 h-px bg-slate-600"></div>
            <span className="text-xs text-gray-500">–∏–ª–∏</span>
            <div className="flex-1 h-px bg-slate-600"></div>
          </div>

          <button onClick={signInWithGoogle}
            className="w-full py-3 bg-white hover:bg-gray-100 text-slate-900 rounded-lg font-bold transition flex items-center justify-center gap-2">
            <svg className="w-5 h-5" viewBox="0 0 24 24">
              <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
          </button>

          <p className="mt-4 text-center text-sm text-gray-400">
            {mode === 'login' ? '–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? ' : '–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? '}
            <button onClick={() => { setMode(mode === 'login' ? 'register' : 'login'); setError(''); setSuccess(''); }}
              className="text-amber-400 hover:underline">
              {mode === 'login' ? '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è' : '–í–æ–π—Ç–∏'}
            </button>
          </p>
        </Modal>
      );
    };

    // ============================================
    // PROFILE MODAL
    // ============================================
    const ProfileModal = ({ onClose }) => {
      const { user, profile, signOut, refreshProfile } = useAuth();
      const [history, setHistory] = useState([]);
      const [achievements, setAchievements] = useState([]);
      const [loading, setLoading] = useState(true);
      const [tab, setTab] = useState('stats');

      useEffect(() => {
        if (user) {
          Promise.all([
            db.getGameHistory(user.id, 10),
            db.getUserAchievements(user.id)
          ]).then(([historyRes, achievementsRes]) => {
            setHistory(historyRes.data);
            setAchievements(achievementsRes.data);
            setLoading(false);
          });
        }
      }, [user]);

      const handleSignOut = async () => {
        await signOut();
        onClose();
      };

      if (!profile) return null;

      const winRate = profile.total_games > 0 
        ? Math.round(profile.total_wins / profile.total_games * 100) 
        : 0;

      return (
        <Modal onClose={onClose} title="üë§ –ü—Ä–æ—Ñ–∏–ª—å">
          {/* User Info */}
          <div className="text-center mb-4">
            <div className="w-20 h-20 bg-gradient-to-br from-amber-500 to-amber-700 rounded-full flex items-center justify-center text-4xl mx-auto mb-2 shadow-lg">
              {profile.display_name?.[0]?.toUpperCase() || profile.username?.[0]?.toUpperCase() || 'üë§'}
            </div>
            <h3 className="text-xl font-bold text-amber-300">{profile.display_name || profile.username}</h3>
            <p className="text-sm text-gray-400">{user?.email}</p>
            {profile.is_premium && (
              <span className="inline-block mt-2 px-3 py-1 bg-gradient-to-r from-amber-500 to-yellow-500 text-slate-900 text-xs font-bold rounded-full">
                ‚≠ê PREMIUM
              </span>
            )}
          </div>

          {/* Stats Grid */}
          <div className="grid grid-cols-3 gap-2 mb-4">
            <div className="bg-slate-700/50 rounded-lg p-3 text-center">
              <p className="text-2xl font-bold text-amber-400">{profile.total_games}</p>
              <p className="text-xs text-gray-400">–ò–≥—Ä</p>
            </div>
            <div className="bg-slate-700/50 rounded-lg p-3 text-center">
              <p className="text-2xl font-bold text-green-400">{winRate}%</p>
              <p className="text-xs text-gray-400">–ü–æ–±–µ–¥</p>
            </div>
            <div className="bg-slate-700/50 rounded-lg p-3 text-center">
              <p className="text-2xl font-bold text-cyan-400">{profile.highest_score}</p>
              <p className="text-xs text-gray-400">–†–µ–∫–æ—Ä–¥</p>
            </div>
          </div>

          {/* Tabs */}
          <div className="flex gap-2 mb-3">
            <button onClick={() => setTab('stats')}
              className={`flex-1 py-2 rounded-lg text-sm font-bold transition ${tab === 'stats' ? 'bg-amber-600' : 'bg-slate-700'}`}>
              üìä –ò—Å—Ç–æ—Ä–∏—è
            </button>
            <button onClick={() => setTab('achievements')}
              className={`flex-1 py-2 rounded-lg text-sm font-bold transition ${tab === 'achievements' ? 'bg-amber-600' : 'bg-slate-700'}`}>
              üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
            </button>
          </div>

          {/* Tab Content */}
          {loading ? <Spinner /> : (
            <div className="max-h-48 overflow-y-auto">
              {tab === 'stats' && (
                <div className="space-y-1">
                  {history.length === 0 ? (
                    <p className="text-gray-400 text-sm text-center py-4">–ï—â—ë –Ω–µ—Ç –∏–≥—Ä</p>
                  ) : history.map(g => (
                    <div key={g.id} className="flex justify-between items-center bg-slate-700/30 rounded-lg p-2 text-sm">
                      <div className="flex items-center gap-2">
                        <span>{SYSTEMS[g.political_system]?.icon || 'üèõÔ∏è'}</span>
                        <span className="text-gray-300">{g.planet_name}</span>
                      </div>
                      <span className={g.is_victory ? 'text-green-400' : 'text-red-400'}>
                        {g.is_victory ? `üèÜ ${g.score}` : 'üíî'}
                      </span>
                    </div>
                  ))}
                </div>
              )}
              {tab === 'achievements' && (
                <div className="grid grid-cols-3 gap-2">
                  {achievements.length === 0 ? (
                    <p className="col-span-3 text-gray-400 text-sm text-center py-4">–ù–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π</p>
                  ) : achievements.map(ua => (
                    <div key={ua.achievement_id} className="bg-amber-900/30 rounded-lg p-2 text-center">
                      <span className="text-2xl">{ua.achievements?.icon || 'üèÜ'}</span>
                      <p className="text-xs text-amber-200 mt-1">{ua.achievements?.name}</p>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}

          {/* Actions */}
          <div className="flex gap-2 mt-4">
            <button onClick={onClose} className="flex-1 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition">
              –ó–∞–∫—Ä—ã—Ç—å
            </button>
            <button onClick={handleSignOut} className="flex-1 py-2 bg-red-900/50 hover:bg-red-800/50 text-red-300 rounded-lg transition">
              –í—ã–π—Ç–∏
            </button>
          </div>
        </Modal>
      );
    };

    // ============================================
    // LEADERBOARD MODAL
    // ============================================
    const LeaderboardModal = ({ onClose }) => {
      const [leaders, setLeaders] = useState([]);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        db.getLeaderboard(30).then(({ data }) => {
          setLeaders(data);
          setLoading(false);
        });
      }, []);

      return (
        <Modal onClose={onClose} title="üèÜ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤">
          {loading ? <Spinner /> : (
            <div className="space-y-2">
              {leaders.length === 0 ? (
                <p className="text-center text-gray-400 py-8">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.<br/>–°—Ç–∞–Ω—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>
              ) : leaders.map((p, i) => (
                <div key={p.id} className={`flex items-center gap-3 p-3 rounded-lg transition ${
                  i < 3 ? 'bg-gradient-to-r from-amber-900/40 to-transparent' : 'bg-slate-700/30'
                }`}>
                  <span className="text-2xl font-bold w-8 text-center">
                    {i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `${i + 1}`}
                  </span>
                  <div className="flex-1 min-w-0">
                    <p className="font-bold text-amber-100 truncate">
                      {p.display_name || p.username || '–ò–≥—Ä–æ–∫'}
                    </p>
                    <p className="text-xs text-gray-400">
                      {p.total_wins}/{p.total_games} –ø–æ–±–µ–¥ ‚Ä¢ {p.win_rate || 0}%
                    </p>
                  </div>
                  <div className="text-right">
                    <p className="text-lg font-bold text-amber-400">{p.highest_score}</p>
                    <p className="text-xs text-gray-500">–æ—á–∫–æ–≤</p>
                  </div>
                </div>
              ))}
            </div>
          )}
        </Modal>
      );
    };

    // ============================================
    // PREMIUM MODAL (Stripe Integration)
    // ============================================
    const PremiumModal = ({ onClose }) => {
      const { user, profile, refreshProfile } = useAuth();
      const [loading, setLoading] = useState(false);
      const [promo, setPromo] = useState('');
      const [error, setError] = useState('');

      const handlePurchase = async () => {
        if (!user) {
          setError('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç');
          return;
        }

        setLoading(true);
        setError('');

        try {
          const response = await fetch('/.netlify/functions/create-checkout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              userId: user.id,
              userEmail: user.email,
              promo: promo.trim() || undefined,
            }),
          });

          const data = await response.json();

          if (data.error) {
            setError(data.error);
          } else if (data.url) {
            window.location.href = data.url;
          }
        } catch (err) {
          setError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ø–ª–∞—Ç—ë–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ');
          console.error(err);
        } finally {
          setLoading(false);
        }
      };

      const features = [
        { icon: 'üèõÔ∏è', text: '6 –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∏—Å—Ç–µ–º (–≤–º–µ—Å—Ç–æ 2)' },
        { icon: 'üéñÔ∏è', text: '–í—Å–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏ –Ω–∞–≥—Ä–∞–¥—ã' },
        { icon: 'üìä', text: '–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞' },
        { icon: 'üö´', text: '–ë–µ–∑ —Ä–µ–∫–ª–∞–º—ã' },
        { icon: 'üíæ', text: '–û–±–ª–∞—á–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è' },
        { icon: 'üéì', text: 'Classroom Mode (—Å–∫–æ—Ä–æ)' },
      ];

      return (
        <Modal onClose={onClose} title="‚≠ê Premium">
          {/* Price */}
          <div className="text-center mb-4">
            <div className="text-4xl font-bold text-amber-400 mb-1">{PREMIUM_PRICE}</div>
            <p className="text-sm text-gray-400">–û—Ç–º–µ–Ω–∏—Ç—å –º–æ–∂–Ω–æ –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è</p>
          </div>

          {/* Features */}
          <div className="bg-slate-700/30 rounded-lg p-4 mb-4">
            <h3 className="font-bold text-amber-200 mb-3">–ß—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ:</h3>
            <div className="space-y-2">
              {features.map((f, i) => (
                <div key={i} className="flex items-center gap-3">
                  <span className="text-xl">{f.icon}</span>
                  <span className="text-gray-300">{f.text}</span>
                </div>
              ))}
            </div>
          </div>

          {/* Promo code */}
          <div className="mb-4">
            <label className="text-xs text-gray-400 block mb-1">üéÅ –ü—Ä–æ–º–æ–∫–æ–¥ (–µ—Å–ª–∏ –µ—Å—Ç—å)</label>
            <input
              type="text"
              value={promo}
              onChange={(e) => setPromo(e.target.value.toUpperCase())}
              placeholder="TEACHER50"
              className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 text-white focus:border-amber-500 outline-none uppercase"
            />
          </div>

          {/* Error */}
          {error && (
            <div className="bg-red-900/50 text-red-300 p-3 rounded-lg mb-4 text-sm">
              {error}
            </div>
          )}

          {/* Buy button */}
          <button
            onClick={handlePurchase}
            disabled={loading || !user}
            className="w-full py-3 bg-gradient-to-r from-amber-500 to-yellow-500 hover:from-amber-400 hover:to-yellow-400 disabled:from-slate-600 disabled:to-slate-600 text-slate-900 font-bold rounded-lg transition flex items-center justify-center gap-2"
          >
            {loading ? (
              <Spinner size="sm" />
            ) : (
              <>
                <span>üí≥</span>
                <span>–û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</span>
              </>
            )}
          </button>

          {!user && (
            <p className="text-center text-xs text-gray-400 mt-3">
              –í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
            </p>
          )}

          {/* Security note */}
          <p className="text-center text-xs text-gray-500 mt-4">
            üîí –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ Stripe
          </p>
        </Modal>
      );
    };

    // ============================================
    // MAIN GAME COMPONENT
    // ============================================
    function Game() {
      const { user, profile, loading: authLoading, initialized } = useAuth();
      
      // Game state
      const [phase, setPhase] = useState('title');
      const [turn, setTurn] = useState(1);
      const [maxTurns, setMaxTurns] = useState(15);
      const [difficulty, setDifficulty] = useState('normal');
      const [stats, setStats] = useState({ happiness: 60, wealth: 50, stability: 70 });
      const [hydrobite, setHydrobite] = useState(100);
      const [budget, setBudget] = useState({ defence: 20, education: 20, health: 20, infra: 20, welfare: 20 });
      const [system, setSystem] = useState('parliamentary');
      const [planet, setPlanet] = useState('–ù–æ–≤–∞—è –¢–µ—Ä—Ä–∞');
      const [event, setEvent] = useState(null);
      const [usedEvents, setUsedEvents] = useState([]);
      const [gameStartTime, setGameStartTime] = useState(null);
      const [finalScore, setFinalScore] = useState(0);
      
      // UI state
      const [showAuth, setShowAuth] = useState(false);
      const [showProfile, setShowProfile] = useState(false);
      const [showLeaderboard, setShowLeaderboard] = useState(false);
      const [showPremium, setShowPremium] = useState(false);
      const [toast, setToast] = useState(null);
      const [newAchievements, setNewAchievements] = useState([]);

      // Check URL params for payment result
      useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        if (params.get('success') === 'true') {
          // Clear URL first to prevent loops
          window.history.replaceState({}, '', '/');
          setToast({ message: '‚úÖ –û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Premium!', type: 'success' });
          // Reload page after 2 seconds to refresh profile
          setTimeout(() => window.location.reload(), 2000);
        } else if (params.get('canceled') === 'true') {
          window.history.replaceState({}, '', '/');
          setToast({ message: '–û–ø–ª–∞—Ç–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞', type: 'warning' });
        }
      }, []);

      const sys = SYSTEMS[system];
      const diff = DIFFICULTIES[difficulty];
      const totalBudget = Object.values(budget).reduce((a, b) => a + b, 0);
      const remaining = hydrobite - totalBudget;
      const isPremium = profile?.is_premium || false;

      // Show toast message
      const showToast = useCallback((message, type = 'info') => {
        setToast({ message, type });
      }, []);

      // Calculate score
      const calculateScore = useCallback((s, t, isVictory) => {
        let score = Math.floor((s.happiness + s.wealth + s.stability) / 3);
        score += t * 2;
        if (isVictory) score += 20;
        if (difficulty === 'hard') score += 15;
        if (difficulty === 'easy') score -= 10;
        return Math.max(0, score);
      }, [difficulty]);

      // Check and unlock achievements
      const checkAchievements = useCallback(async (gameData) => {
        if (!user) return [];
        
        const unlocked = [];
        const checks = [
          { id: 'first_win', condition: gameData.isVictory && profile?.total_wins === 0 },
          { id: 'parliamentarian', condition: gameData.isVictory && gameData.system === 'parliamentary' },
          { id: 'president', condition: gameData.isVictory && gameData.system === 'presidential' },
          { id: 'monarch', condition: gameData.isVictory && gameData.system === 'monarchy' },
          { id: 'dictator', condition: gameData.isVictory && gameData.system === 'dictatorship' },
          { id: 'utopia', condition: gameData.stats.happiness >= 95 },
          { id: 'prosperity', condition: gameData.stats.wealth >= 95 },
          { id: 'survivor', condition: gameData.isVictory && gameData.difficulty === 'hard' },
          { id: 'speedrun', condition: gameData.isVictory && gameData.turn <= 10 },
          { id: 'perfectionist', condition: gameData.isVictory && gameData.stats.happiness >= 80 && gameData.stats.wealth >= 80 && gameData.stats.stability >= 80 },
          { id: 'high_score', condition: gameData.score >= 100 },
          { id: 'veteran', condition: (profile?.total_games || 0) >= 9 },
        ];

        for (const check of checks) {
          if (check.condition) {
            const { error } = await db.unlockAchievement(user.id, check.id);
            if (!error) unlocked.push(ACHIEVEMENT_DEFS[check.id]);
          }
        }

        return unlocked;
      }, [user, profile]);

      // End game and save results
      const endGame = useCallback(async (isVictory, victoryType = null) => {
        const score = calculateScore(stats, turn, isVictory);
        setFinalScore(score);
        
        const duration = gameStartTime ? Math.floor((Date.now() - gameStartTime) / 1000) : 0;

        // Save to database if logged in
        if (user) {
          const gameData = {
            planet, system, difficulty, maxTurns, turn,
            stats, hydrobite, isVictory, victoryType, score, duration
          };
          
          await db.saveGameResult(user.id, gameData);
          
          // Check achievements
          const unlocked = await checkAchievements({ ...gameData, score });
          if (unlocked.length > 0) {
            setNewAchievements(unlocked);
          }
        }

        setPhase(isVictory ? 'victory' : 'gameover');
      }, [user, planet, system, difficulty, maxTurns, turn, stats, hydrobite, gameStartTime, calculateScore, checkAchievements]);

      // Start new game
      const startGame = useCallback(() => {
        if (!isPremium && SYSTEMS[system].premium) {
          showToast('üîí –≠—Ç–∞ —Å–∏—Å—Ç–µ–º–∞ —Ç—Ä–µ–±—É–µ—Ç Premium!', 'warning');
          return;
        }

        const d = DIFFICULTIES[difficulty];
        const s = SYSTEMS[system];
        
        setStats({
          happiness: Math.max(10, Math.min(90, 60 + d.bonus - (s.traits.startPenalty || 0))),
          wealth: Math.max(10, Math.min(90, 50 + d.bonus)),
          stability: Math.max(10, Math.min(90, 70 + d.bonus + s.traits.stabilityBonus))
        });
        setHydrobite(100 + d.hydroBonus);
        setTurn(1);
        setBudget({ defence: 20, education: 20, health: 20, infra: 20, welfare: 20 });
        setUsedEvents([]);
        setGameStartTime(Date.now());
        setNewAchievements([]);
        setPhase('playing');
      }, [system, difficulty, isPremium, showToast]);

      // Process turn
      const processTurn = useCallback(() => {
        if (remaining < 0) {
          showToast('‚ùå –ë—é–¥–∂–µ—Ç –ø—Ä–µ–≤—ã—à–µ–Ω!', 'error');
          return;
        }

        // Parliament check
        if (sys.traits.needsApproval && stats.happiness < sys.traits.threshold) {
          if (Math.random() > 0.4) {
            showToast('üèõÔ∏è –ü–∞—Ä–ª–∞–º–µ–Ω—Ç –æ—Ç–∫–ª–æ–Ω–∏–ª –±—é–¥–∂–µ—Ç!', 'warning');
            return;
          }
        }

        // Referendum check for direct democracy
        if (sys.traits.referendumChance && Math.random() < sys.traits.referendumChance) {
          showToast('üó≥Ô∏è –†–µ—Ñ–µ—Ä–µ–Ω–¥—É–º –∏–∑–º–µ–Ω–∏–ª –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã!', 'info');
        }

        const d = DIFFICULTIES[difficulty];
        let changes = {
          happiness: (budget.welfare * 0.35) + (budget.health * 0.25) + (budget.education * 0.15) - 12 - sys.traits.happinessDecay,
          wealth: (budget.infra * 0.4) + (budget.education * 0.25) - 10 + sys.traits.wealthBonus,
          stability: (budget.defence * 0.35) + (budget.infra * 0.1) - 5,
        };

        // Apply difficulty modifier to negative changes
        Object.keys(changes).forEach(k => {
          if (changes[k] < 0) changes[k] *= d.severity;
        });

        const newStats = {
          happiness: Math.max(0, Math.min(100, stats.happiness + changes.happiness)),
          wealth: Math.max(0, Math.min(100, stats.wealth + changes.wealth)),
          stability: Math.max(0, Math.min(100, stats.stability + changes.stability)),
        };

        setStats(newStats);
        setHydrobite(Math.floor(80 + newStats.wealth * 0.3 + d.hydroBonus * 0.5));

        // Get next event
        let available = EVENTS.filter(e => !usedEvents.includes(e.id));
        if (available.length === 0) {
          setUsedEvents([]);
          available = EVENTS;
        }
        const nextEvent = available[Math.floor(Math.random() * available.length)];
        setEvent(nextEvent);
        setUsedEvents(prev => [...prev, nextEvent.id]);
        setPhase('event');
      }, [remaining, sys, stats, difficulty, budget, usedEvents, showToast]);

      // Handle event choice
      const handleChoice = useCallback((choice) => {
        const d = DIFFICULTIES[difficulty];
        let newStats = { ...stats };

        Object.entries(choice.effects).forEach(([k, v]) => {
          if (newStats[k] !== undefined) {
            const effectValue = v < 0 ? v * d.severity : v;
            newStats[k] = Math.max(0, Math.min(100, newStats[k] + effectValue));
          }
        });

        let newHydro = hydrobite - choice.cost + (choice.hydro || 0);
        setHydrobite(Math.max(0, newHydro));
        setStats(newStats);

        // Check for rebellion/coup
        if (sys.traits.rebellionRisk && newStats.happiness < sys.traits.rebellionRisk && Math.random() < 0.3) {
          showToast('üëë –ù–∞—Ä–æ–¥–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–∏–µ!', 'error');
          setTimeout(() => endGame(false), 1000);
          return;
        }
        if (sys.traits.coupRisk && newStats.stability < sys.traits.coupRisk && Math.random() < 0.3) {
          showToast('‚öîÔ∏è –í–æ–µ–Ω–Ω—ã–π –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç!', 'error');
          setTimeout(() => endGame(false), 1000);
          return;
        }

        // Check game over conditions
        if (newStats.stability <= 0 || newStats.happiness <= 0) {
          endGame(false);
          return;
        }

        // Check victory conditions
        if (turn >= maxTurns) {
          endGame(true, 'survival');
          return;
        }
        if (newStats.happiness >= 95) {
          endGame(true, 'utopia');
          return;
        }
        if (newStats.wealth >= 95) {
          endGame(true, 'prosperity');
          return;
        }

        setTurn(t => t + 1);
        setEvent(null);
        setPhase('playing');
      }, [difficulty, stats, hydrobite, sys, turn, maxTurns, endGame, showToast]);

      // Budget handler
      const handleBudget = useCallback((sector, val) => {
        setBudget(prev => ({ ...prev, [sector]: Math.max(0, Math.min(50, parseInt(val) || 0)) }));
      }, []);

      // ========== LOADING ==========
      if (!initialized || authLoading) {
        return (
          <div className="min-h-screen bg-slate-950 flex items-center justify-center">
            <div className="text-center">
              <Spinner size="lg" />
              <p className="text-amber-400 mt-4 font-display">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
          </div>
        );
      }

      // ========== TITLE SCREEN ==========
      if (phase === 'title') {
        return (
          <div className="min-h-screen bg-slate-950 text-white p-4 relative">
            <StarBackground />
            
            <div className="max-w-md mx-auto pt-4 relative z-10">
              {/* Header with auth */}
              <div className="flex justify-between items-center mb-4">
                <div className="flex gap-2">
                  <button onClick={() => setShowLeaderboard(true)} 
                    className="p-2 bg-slate-800/50 rounded-lg hover:bg-slate-700 transition">
                    üèÜ
                  </button>
                  {!isPremium && (
                    <button onClick={() => setShowPremium(true)} 
                      className="px-3 py-2 bg-gradient-to-r from-amber-500 to-yellow-500 text-slate-900 rounded-lg hover:from-amber-400 hover:to-yellow-400 transition text-sm font-bold">
                      ‚≠ê Premium
                    </button>
                  )}
                </div>
                
                {user ? (
                  <button onClick={() => setShowProfile(true)}
                    className="flex items-center gap-2 px-3 py-2 bg-slate-800/50 rounded-full hover:bg-slate-700 transition">
                    <div className="w-6 h-6 bg-amber-600 rounded-full flex items-center justify-center text-xs font-bold">
                      {profile?.display_name?.[0]?.toUpperCase() || 'üë§'}
                    </div>
                    <span className="text-sm text-amber-300">{profile?.display_name || '–ü—Ä–æ—Ñ–∏–ª—å'}</span>
                    {profile?.is_premium && <span className="text-amber-400">‚≠ê</span>}
                  </button>
                ) : (
                  <button onClick={() => setShowAuth(true)}
                    className="px-4 py-2 bg-amber-600 hover:bg-amber-500 rounded-full text-sm font-bold transition">
                    –í–æ–π—Ç–∏
                  </button>
                )}
              </div>

              {/* Title */}
              <div className="text-center mb-6">
                <h1 className="text-4xl sm:text-5xl font-display font-bold gold-gradient mb-2">INDEPENDENCE</h1>
                <p className="text-amber-200/60 text-sm tracking-widest">–û–ë–†–ê–ó–û–í–ê–¢–ï–õ–¨–ù–ê–Ø –ò–ì–†–ê –û –ü–û–õ–ò–¢–ò–ö–ï</p>
              </div>

              {/* Game settings */}
              <div className="space-y-4 mb-6">
                <div>
                  <label className="text-sm text-gray-400 block mb-1">üåç –ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–µ—Ç—ã</label>
                  <input type="text" value={planet} onChange={e => setPlanet(e.target.value || '–ù–æ–≤–∞—è –¢–µ—Ä—Ä–∞')}
                    className="w-full bg-slate-900/80 border border-amber-500/30 rounded-lg px-4 py-3 text-center text-amber-300 focus:border-amber-500 outline-none transition"/>
                </div>

                <div>
                  <label className="text-sm text-gray-400 block mb-1">üìä –°–ª–æ–∂–Ω–æ—Å—Ç—å</label>
                  <div className="grid grid-cols-3 gap-2">
                    {Object.entries(DIFFICULTIES).map(([key, d]) => (
                      <button key={key} onClick={() => setDifficulty(key)}
                        className={`py-3 rounded-lg border text-sm transition ${
                          difficulty === key ? 'border-amber-500 bg-amber-500/20 text-amber-300' : 'border-slate-600 text-gray-400 hover:border-slate-500'
                        }`}>
                        {d.icon} {d.name}
                      </button>
                    ))}
                  </div>
                </div>

                <div>
                  <label className="text-sm text-gray-400 block mb-1">‚è±Ô∏è –î–ª–∏–Ω–∞ –∏–≥—Ä—ã: {maxTurns} –ª–µ—Ç</label>
                  <input type="range" min="10" max="30" step="5" value={maxTurns} onChange={e => setMaxTurns(parseInt(e.target.value))}
                    className="w-full" style={{ background: `linear-gradient(90deg, #d97706 ${(maxTurns-10)/20*100}%, #1e293b ${(maxTurns-10)/20*100}%)` }}/>
                </div>

                <div>
                  <label className="text-sm text-gray-400 block mb-1">üèõÔ∏è –ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞</label>
                  <div className="grid grid-cols-2 gap-2">
                    {Object.values(SYSTEMS).map(s => (
                      <button key={s.id} onClick={() => setSystem(s.id)}
                        className={`p-3 rounded-lg border text-left transition ${
                          system === s.id ? 'border-amber-500 bg-amber-500/10' : 'border-slate-600 hover:border-slate-500'
                        } ${s.premium && !isPremium ? 'opacity-60' : ''}`}>
                        <div className="flex items-center gap-2 mb-1">
                          <span className="text-xl">{s.icon}</span>
                          <span className="text-sm font-bold text-amber-100">{s.name.split(' ')[0]}</span>
                        </div>
                        <p className="text-xs text-gray-400 line-clamp-1">{s.desc}</p>
                        {s.premium && !isPremium && (
                          <span className="text-xs text-amber-400 mt-1 inline-block">‚≠ê Premium</span>
                        )}
                      </button>
                    ))}
                  </div>
                </div>
              </div>

              {/* Start button */}
              <button onClick={startGame}
                className="w-full py-4 bg-gradient-to-b from-amber-500 to-amber-700 hover:from-amber-400 hover:to-amber-600 text-slate-900 font-bold rounded-lg text-lg glow-amber transition">
                üöÄ –ù–ê–ß–ê–¢–¨ –ò–ì–†–£
              </button>

              {!user && (
                <p className="text-center text-xs text-gray-500 mt-4">
                  üí° <button onClick={() => setShowAuth(true)} className="text-amber-400 hover:underline">–í–æ–π–¥–∏—Ç–µ</button>, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞—Ç—å—Å—è –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ
                </p>
              )}
            </div>

            {/* Modals */}
            {showAuth && <AuthModal onClose={() => setShowAuth(false)} />}
            {showProfile && <ProfileModal onClose={() => setShowProfile(false)} />}
            {showLeaderboard && <LeaderboardModal onClose={() => setShowLeaderboard(false)} />}
            {showPremium && <PremiumModal onClose={() => setShowPremium(false)} />}
            {toast && <Toast {...toast} onClose={() => setToast(null)} />}
          </div>
        );
      }

      // ========== VICTORY ==========
      if (phase === 'victory') {
        return (
          <div className="min-h-screen bg-gradient-to-b from-slate-950 via-amber-950/20 to-slate-950 text-white flex flex-col items-center justify-center p-4 relative">
            <StarBackground />
            <div className="relative z-10 text-center animate-slideUp">
              <div className="text-8xl mb-4 animate-pulse">üèÜ</div>
              <h1 className="text-4xl font-display font-bold text-amber-400 mb-2">–ü–û–ë–ï–î–ê!</h1>
              <p className="text-gray-400 mb-2">{sys.icon} {sys.name}</p>
              <p className="text-gray-500 mb-4">–í—ã —É–ø—Ä–∞–≤–ª—è–ª–∏ {turn} –ª–µ—Ç</p>
              
              <div className="grid grid-cols-3 gap-3 mb-4 max-w-xs mx-auto">
                <div className="bg-slate-800/50 rounded-lg p-3">
                  <div className="text-xl">üòä</div>
                  <div className="text-lg font-bold text-green-400">{Math.round(stats.happiness)}%</div>
                </div>
                <div className="bg-slate-800/50 rounded-lg p-3">
                  <div className="text-xl">üí∞</div>
                  <div className="text-lg font-bold text-yellow-400">{Math.round(stats.wealth)}%</div>
                </div>
                <div className="bg-slate-800/50 rounded-lg p-3">
                  <div className="text-xl">‚öñÔ∏è</div>
                  <div className="text-lg font-bold text-blue-400">{Math.round(stats.stability)}%</div>
                </div>
              </div>

              <p className="text-5xl font-bold text-amber-500 mb-6">{finalScore} –æ—á–∫–æ–≤</p>

              {newAchievements.length > 0 && (
                <div className="mb-6 bg-amber-900/30 rounded-lg p-4 max-w-xs mx-auto">
                  <p className="text-sm text-amber-300 mb-2">üéâ –ù–æ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è!</p>
                  <div className="flex flex-wrap justify-center gap-2">
                    {newAchievements.map(a => (
                      <div key={a.name} className="bg-slate-800/50 rounded-lg p-2 text-center">
                        <span className="text-2xl">{a.icon}</span>
                        <p className="text-xs text-amber-200">{a.name}</p>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {!user && (
                <p className="text-sm text-gray-400 mb-4">
                  <button onClick={() => setShowAuth(true)} className="text-amber-400 hover:underline">–í–æ–π–¥–∏—Ç–µ</button>, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç!
                </p>
              )}

              <button onClick={() => { setPhase('title'); setNewAchievements([]); }}
                className="px-8 py-3 bg-amber-600 hover:bg-amber-500 rounded-lg font-bold text-lg transition">
                –ò–ì–†–ê–¢–¨ –°–ù–û–í–ê
              </button>
            </div>
            {showAuth && <AuthModal onClose={() => setShowAuth(false)} />}
          </div>
        );
      }

      // ========== GAME OVER ==========
      if (phase === 'gameover') {
        return (
          <div className="min-h-screen bg-gradient-to-b from-slate-950 via-red-950/20 to-slate-950 text-white flex flex-col items-center justify-center p-4 relative">
            <StarBackground />
            <div className="relative z-10 text-center animate-slideUp">
              <div className="text-8xl mb-4">üíî</div>
              <h1 className="text-4xl font-display font-bold text-red-400 mb-2">–ö–û–ù–ï–¶ –ü–†–ê–í–õ–ï–ù–ò–Ø</h1>
              <p className="text-gray-400 mb-4">
                {stats.stability <= 0 ? '–ù–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Ä–∞–∑—Ä—É—à–∏–ª–∞ –≤–ª–∞—Å—Ç—å' :
                 stats.happiness <= 0 ? '–ù–∞—Ä–æ–¥ –≤–æ—Å—Å—Ç–∞–ª –ø—Ä–æ—Ç–∏–≤ –≤–∞—Å' :
                 '–í–∞—à–µ –ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å'}
              </p>
              <p className="text-gray-500 mb-6">–ü—Ä–æ–¥–µ—Ä–∂–∞–ª–∏—Å—å {turn} –ª–µ—Ç –∫–∞–∫ {sys.leader}</p>
              <button onClick={() => setPhase('title')}
                className="px-8 py-3 bg-amber-600 hover:bg-amber-500 rounded-lg font-bold text-lg transition">
                –ü–û–ü–†–û–ë–û–í–ê–¢–¨ –°–ù–û–í–ê
              </button>
            </div>
          </div>
        );
      }

      // ========== EVENT SCREEN ==========
      if (phase === 'event' && event) {
        return (
          <div className="min-h-screen bg-slate-950 text-white p-4 animate-fadeIn">
            <div className="max-w-md mx-auto">
              {/* Header */}
              <div className="flex justify-between items-center mb-4 bg-slate-900/80 rounded-xl p-3 border border-amber-500/20">
                <span className="text-amber-400 font-bold">–ì–æ–¥ {turn}/{maxTurns}</span>
                <span className="bg-cyan-950/50 px-3 py-1 rounded-lg text-cyan-300 font-bold">‚óÜ {hydrobite}</span>
              </div>

              {/* Event Card */}
              <div className="bg-slate-800/90 rounded-xl p-5 border-2 border-amber-500/40 mb-4">
                <div className="flex items-center gap-3 mb-3">
                  <span className="text-5xl">{event.icon}</span>
                  <div>
                    <span className="text-xs bg-slate-700 px-2 py-1 rounded text-gray-400">{event.category}</span>
                    <h2 className="text-xl font-display font-bold text-amber-100 mt-1">{event.title}</h2>
                  </div>
                </div>
                <p className="text-gray-300 mb-5">{event.desc}</p>

                <div className="space-y-3">
                  {event.choices.map((c, i) => (
                    <button key={i} onClick={() => handleChoice(c)} disabled={c.cost > hydrobite}
                      className={`w-full text-left p-4 rounded-lg border transition ${
                        c.cost > hydrobite ? 'opacity-50 border-slate-700 cursor-not-allowed' : 'border-slate-600 hover:border-amber-500 hover:bg-slate-700/50'
                      }`}>
                      <div className="flex justify-between items-center mb-2">
                        <span className="font-semibold text-amber-100">{c.text}</span>
                        {c.cost > 0 && <span className="text-xs bg-cyan-900/50 text-cyan-400 px-2 py-1 rounded">-{c.cost}‚óÜ</span>}
                      </div>
                      {c.hint && <p className="text-xs text-gray-400 mb-2 italic">üí° {c.hint}</p>}
                      <div className="flex flex-wrap gap-1">
                        {Object.entries(c.effects).map(([k, v]) => (
                          <span key={k} className={`text-xs px-2 py-0.5 rounded ${v >= 0 ? 'bg-green-900/40 text-green-400' : 'bg-red-900/40 text-red-400'}`}>
                            {v > 0 ? '+' : ''}{v} {k === 'happiness' ? 'üòä' : k === 'wealth' ? 'üí∞' : '‚öñÔ∏è'}
                          </span>
                        ))}
                        {c.hydro && (
                          <span className={`text-xs px-2 py-0.5 rounded ${c.hydro >= 0 ? 'bg-cyan-900/40 text-cyan-400' : 'bg-orange-900/40 text-orange-400'}`}>
                            {c.hydro > 0 ? '+' : ''}{c.hydro}‚óÜ
                          </span>
                        )}
                      </div>
                    </button>
                  ))}
                </div>
              </div>

              {/* Mini stats */}
              <div className="grid grid-cols-3 gap-3">
                {[
                  { icon: 'üòä', val: stats.happiness },
                  { icon: 'üí∞', val: stats.wealth },
                  { icon: '‚öñÔ∏è', val: stats.stability }
                ].map((s, i) => (
                  <div key={i} className="bg-slate-900/80 rounded-lg p-3 text-center">
                    <div className="text-xl">{s.icon}</div>
                    <div className={`font-bold ${s.val < 30 ? 'text-red-400' : s.val > 70 ? 'text-green-400' : 'text-amber-300'}`}>
                      {Math.round(s.val)}%
                    </div>
                  </div>
                ))}
              </div>
            </div>
            {toast && <Toast {...toast} onClose={() => setToast(null)} />}
          </div>
        );
      }

      // ========== MAIN GAME SCREEN ==========
      return (
        <div className="min-h-screen bg-slate-950 text-white p-4">
          <div className="max-w-md mx-auto">
            {/* Header */}
            <div className="flex justify-between items-center mb-4 bg-slate-900/80 rounded-xl p-3 border border-amber-500/20">
              <div>
                <h1 className="text-lg font-display font-bold text-amber-400">{planet}</h1>
                <p className="text-xs text-amber-200/50">{sys.icon} {sys.leader}</p>
              </div>
              <div className="text-center">
                <div className="text-amber-400 font-black text-2xl">–ì–û–î {turn}</div>
                <div className="text-gray-500 text-xs">–∏–∑ {maxTurns}</div>
              </div>
              <div className="bg-cyan-950/50 px-3 py-2 rounded-lg border border-cyan-500/30">
                <span className="text-xl text-cyan-400">‚óÜ</span>
                <span className="font-black text-xl text-cyan-300 ml-1">{hydrobite}</span>
              </div>
            </div>

            {/* Main panels */}
            <div className="grid grid-cols-2 gap-3 mb-4">
              {/* Stats */}
              <div className="bg-slate-800/70 rounded-xl p-4 border border-amber-500/20">
                <h2 className="text-xs font-bold mb-3 text-amber-200/80">üìä –°–¢–ê–¢–£–°</h2>
                <StatBar label="–°—á–∞—Å—Ç—å–µ" value={stats.happiness} icon="üòä" color="bg-green-500"/>
                <StatBar label="–ë–æ–≥–∞—Ç—Å—Ç–≤–æ" value={stats.wealth} icon="üí∞" color="bg-yellow-500"/>
                <StatBar label="–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å" value={stats.stability} icon="‚öñÔ∏è" color="bg-blue-500"/>
                
                {sys.traits.needsApproval && (
                  <div className={`mt-2 text-xs p-2 rounded ${
                    stats.happiness >= sys.traits.threshold ? 'bg-green-900/30 text-green-400' : 'bg-red-900/30 text-red-400'
                  }`}>
                    üèõÔ∏è {stats.happiness >= sys.traits.threshold ? '–ü–∞—Ä–ª–∞–º–µ–Ω—Ç –æ–¥–æ–±—Ä–∏—Ç' : '–ù—É–∂–Ω–æ >40% —Å—á–∞—Å—Ç—å—è'}
                  </div>
                )}
              </div>

              {/* Budget */}
              <div className="bg-slate-800/70 rounded-xl p-4 border border-amber-500/20">
                <div className="flex justify-between items-center mb-3">
                  <h2 className="text-xs font-bold text-amber-200/80">üìã –ë–Æ–î–ñ–ï–¢</h2>
                  <span className={`text-xs font-bold px-2 py-1 rounded ${
                    remaining >= 0 ? 'bg-green-900/50 text-green-400' : 'bg-red-900/50 text-red-400'
                  }`}>
                    {remaining >= 0 ? '+' : ''}{remaining}‚óÜ
                  </span>
                </div>
                {SECTORS.map(s => (
                  <div key={s.id} className="mb-2">
                    <div className="flex justify-between text-xs mb-0.5">
                      <span className="text-gray-400">{s.icon}</span>
                      <span className="text-cyan-400 font-bold">{budget[s.id]}</span>
                    </div>
                    <input type="range" min="0" max="50" value={budget[s.id]}
                      onChange={e => handleBudget(s.id, e.target.value)}
                      className="w-full"
                      style={{ background: `linear-gradient(90deg, #d97706 ${budget[s.id]*2}%, #1e293b ${budget[s.id]*2}%)` }}/>
                  </div>
                ))}
              </div>
            </div>

            {/* Submit button */}
            <button onClick={processTurn} disabled={remaining < 0}
              className={`w-full py-4 rounded-xl font-bold text-lg transition ${
                remaining >= 0
                  ? 'bg-gradient-to-r from-amber-600 to-amber-500 hover:from-amber-500 hover:to-amber-400 text-slate-900 glow-amber'
                  : 'bg-slate-700 text-slate-500 cursor-not-allowed'
              }`}>
              {sys.traits.needsApproval ? 'üèõÔ∏è –ü–û–î–ê–¢–¨ –í –ü–ê–†–õ–ê–ú–ï–ù–¢' : '‚úÖ –£–¢–í–ï–†–î–ò–¢–¨ –ë–Æ–î–ñ–ï–¢'}
            </button>
          </div>
          {toast && <Toast {...toast} onClose={() => setToast(null)} />}
        </div>
      );
    }

    // ============================================
    // APP ROOT
    // ============================================
    function App() {
      return (
        <AuthProvider>
          <Game />
        </AuthProvider>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>

  <!-- –£–¥–∞–ª—è–µ–º Service Worker –∏ –∫—ç—à–∏ -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(registrations => {
        registrations.forEach(r => r.unregister());
      });
      caches.keys().then(keys => {
        keys.forEach(key => caches.delete(key));
      });
    }
  </script>
</body>
</html>
