<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#2563eb">
  <title>Independence - School Edition</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Raleway:wght@300;400;600;700&display=swap');
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;font-family:'Raleway',sans-serif;background:#0f172a}
    .font-display{font-family:'Cinzel',serif}
    .gold-gradient{background:linear-gradient(180deg,#60a5fa 0%,#2563eb 50%,#1e40af 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    input[type="range"]{-webkit-appearance:none;height:8px;border-radius:4px}
    input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:24px;height:24px;border-radius:50%;background:linear-gradient(180deg,#60a5fa,#2563eb);cursor:pointer}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
    .animate-fadeIn{animation:fadeIn .3s ease-out}.animate-slideUp{animation:slideUp .4s ease-out}.animate-pulse{animation:pulse 2s infinite}
    button{min-height:44px;cursor:pointer;transition:all .15s}button:active{transform:scale(.97)}
    .star-bg{position:fixed;inset:0;overflow:hidden;pointer-events:none;z-index:0}
    .star{position:absolute;width:2px;height:2px;background:white;border-radius:50%;opacity:.5}
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const{useState,useEffect,useCallback,createContext,useContext,useMemo}=React;

    const SUPABASE_URL='https://dnkeinsedcrlhwbiycfo.supabase.co';
    const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRua2VpbnNlZGNybGh3Yml5Y2ZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NDg0MjgsImV4cCI6MjA4NDMyNDQyOH0.9IkWv6dwOemaVwvWrwq7ZzuebrgWI83JWrdaZbzdhhw';
    const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
    const CACHE_KEY='independence_school_v3';
    const CACHE_TTL=1000*60*30;

    // Fallback
    const FALLBACK={
      T:{ui:{},school:{},systems:{},planets:{}},
      SYSTEMS:{parliamentary:{id:'parliamentary',icon:'üèõÔ∏è',name:{en:'Parliamentary Democracy',ru:'–ü–∞—Ä–ª–∞–º–µ–Ω—Ç—Å–∫–∞—è –¥–µ–º–æ–∫—Ä–∞—Ç–∏—è'},description:{en:'Citizens elect representatives.',ru:'–ì—Ä–∞–∂–¥–∞–Ω–µ –≤—ã–±–∏—Ä–∞—é—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª–µ–π.'},traits:{stabilityBonus:5}}},
      PLANETS:{terranova:{id:'terranova',icon:'üåç',name:{en:'Terra Nova',ru:'–¢–µ—Ä—Ä–∞ –ù–æ–≤–∞'},description:{en:'Earth-like planet.',ru:'–ó–µ–º–ª–µ–ø–æ–¥–æ–±–Ω–∞—è –ø–ª–∞–Ω–µ—Ç–∞.'},difficulty:1,stats:{happiness:60,wealth:50,stability:70},mods:{happiness:1,wealth:1,stability:1}}},
      EVENTS:[],LANGUAGES:[{code:'en',name:'English',flag:'üá¨üáß'},{code:'ru',name:'–†—É—Å—Å–∫–∏–π',flag:'üá∑üá∫'}]
    };

    // Content loader
    const loadContent=async()=>{
      try{
        const cached=localStorage.getItem(CACHE_KEY);
        if(cached){const{data,ts}=JSON.parse(cached);if(Date.now()-ts<CACHE_TTL)return transform(data);}
      }catch(e){}
      try{
        const[langs,texts,systems,planets,events]=await Promise.all([
          supabase.from('languages').select('*').eq('is_active',true),
          supabase.from('ui_texts').select('*'),
          supabase.from('political_systems').select('*').eq('is_active',true).order('sort_order'),
          supabase.from('planets').select('*').eq('is_active',true).order('sort_order'),
          supabase.from('events').select('*').eq('is_active',true).order('sort_order')
        ]);
        const data={languages:langs.data,ui_texts:texts.data,systems:systems.data,planets:planets.data,events:events.data};
        localStorage.setItem(CACHE_KEY,JSON.stringify({data,ts:Date.now()}));
        return transform(data);
      }catch(e){return null;}
    };

    const transform=(raw)=>{
      if(!raw)return null;
      const T={ui:{},school:{},systems:{},planets:{}};
      raw.ui_texts?.forEach(t=>{
        const parts=t.key.split('.');
        if(parts.length>=2){
          const[cat,...rest]=parts;
          const key=rest.join('.');
          if(!T[cat])T[cat]={};
          T[cat][key]=t.value;
        }
      });
      const SYSTEMS={};raw.systems?.forEach(s=>{SYSTEMS[s.id]={...s};T.systems[s.id]={name:s.name,leader:s.leader,desc:s.description};});
      const PLANETS={};raw.planets?.forEach(p=>{PLANETS[p.id]={...p};T.planets[p.id]={name:p.name,desc:p.description};});
      const EVENTS=raw.events?.map(e=>({id:e.id,icon:e.icon,system:e.system,title:e.title,desc:e.description,choices:e.choices||[]}))||[];
      const LANGUAGES=raw.languages?.map(l=>({code:l.code,name:l.native_name||l.name,flag:l.flag}))||[];
      return{T,SYSTEMS,PLANETS,EVENTS,LANGUAGES};
    };

    // Contexts
    const ContentContext=createContext(FALLBACK);
    const StudentContext=createContext(null);
    const LangContext=createContext({lang:'en',setLang:()=>{},t:()=>''});

    function ContentProvider({children}){
      const[content,setContent]=useState(FALLBACK);
      useEffect(()=>{loadContent().then(c=>{if(c&&Object.keys(c.SYSTEMS).length)setContent(c);});},[]);
      return <ContentContext.Provider value={content}>{children}</ContentContext.Provider>;
    }

    function LangProvider({children}){
      const[lang,setLang]=useState(()=>localStorage.getItem('school_lang')||'en');
      const content=useContext(ContentContext);
      
      // Translation function
      const t=useCallback((key,fallback='')=>{
        const val=content?.T?.school?.[key];
        if(val&&typeof val==='object'){
          return val[lang]||val.en||val.ru||fallback||key;
        }
        return fallback||key;
      },[lang,content]);

      const changeLang=(l)=>{setLang(l);localStorage.setItem('school_lang',l);};
      
      return <LangContext.Provider value={{lang,setLang:changeLang,t}}>{children}</LangContext.Provider>;
    }

    function StudentProvider({children}){
      const[student,setStudent]=useState(null);
      const[classroom,setClassroom]=useState(null);
      const[session,setSession]=useState(null);
      const[scenario,setScenario]=useState(null);
      const[loading,setLoading]=useState(true);

      useEffect(()=>{
        const saved=localStorage.getItem('school_student');
        if(saved){try{const d=JSON.parse(saved);setStudent(d.student);setClassroom(d.classroom);setSession(d.session);setScenario(d.scenario);}catch(e){}}
        setLoading(false);
      },[]);

      const login=async(joinCode,displayName,pin)=>{
        const{data:classrooms}=await supabase.from('classrooms').select('*').eq('join_code',joinCode.toUpperCase()).eq('is_active',true).limit(1);
        if(!classrooms?.length)throw new Error('Class not found');
        const classroom=classrooms[0];

        let{data:students}=await supabase.from('students').select('*').eq('classroom_id',classroom.id).eq('display_name',displayName).limit(1);
        let student;
        if(students?.length){
          student=students[0];
          if(student.pin_code!==pin)throw new Error('Wrong PIN');
        }else{
          const{data:newStudent,error}=await supabase.from('students').insert({classroom_id:classroom.id,display_name:displayName,pin_code:pin}).select().single();
          if(error)throw new Error('Could not join');
          student=newStudent;
        }

        const{data:sessions}=await supabase.from('classroom_sessions').select('*, scenarios(*)').eq('classroom_id',classroom.id).eq('status','active').order('started_at',{ascending:false}).limit(1);
        const session=sessions?.[0]||null;
        const scenario=session?.scenarios||null;

        setStudent(student);setClassroom(classroom);setSession(session);setScenario(scenario);
        localStorage.setItem('school_student',JSON.stringify({student,classroom,session,scenario}));
      };

      const logout=()=>{setStudent(null);setClassroom(null);setSession(null);setScenario(null);localStorage.removeItem('school_student');};
      const refreshSession=async()=>{
        if(!classroom)return;
        const{data:sessions}=await supabase.from('classroom_sessions').select('*, scenarios(*)').eq('classroom_id',classroom.id).eq('status','active').limit(1);
        const newSession=sessions?.[0]||null;
        const newScenario=newSession?.scenarios||null;
        setSession(newSession);setScenario(newScenario);
        localStorage.setItem('school_student',JSON.stringify({student,classroom,session:newSession,scenario:newScenario}));
      };

      return <StudentContext.Provider value={{student,classroom,session,scenario,loading,login,logout,refreshSession}}>{children}</StudentContext.Provider>;
    }

    // Components
    const StarBackground=()=>{const stars=useMemo(()=>Array.from({length:40},(_,i)=>({id:i,left:Math.random()*100,top:Math.random()*100,size:Math.random()*2+1,delay:Math.random()*3})),[]);return<div className="star-bg">{stars.map(s=><div key={s.id} className="star animate-pulse" style={{left:`${s.left}%`,top:`${s.top}%`,width:s.size,height:s.size,animationDelay:`${s.delay}s`}}/>)}</div>;};

    // Language Selector
    function LangSelector(){
      const{lang,setLang}=useContext(LangContext);
      const{LANGUAGES}=useContext(ContentContext);
      return<div className="flex gap-1">
        {LANGUAGES.map(l=><button key={l.code} onClick={()=>setLang(l.code)} className={`text-lg ${lang===l.code?'opacity-100':'opacity-40 hover:opacity-70'}`} title={l.name}>{l.flag}</button>)}
      </div>;
    }

    // Login Screen
    function LoginScreen(){
      const{login}=useContext(StudentContext);
      const{t}=useContext(LangContext);
      const[joinCode,setJoinCode]=useState('');
      const[displayName,setDisplayName]=useState('');
      const[pin,setPin]=useState('');
      const[error,setError]=useState('');
      const[loading,setLoading]=useState(false);

      const handleSubmit=async(e)=>{
        e.preventDefault();
        if(!joinCode||!displayName||!pin){setError(t('fillAllFields','Please fill all fields'));return;}
        if(pin.length!==4||!/^\d+$/.test(pin)){setError(t('pinMustBe4','PIN must be 4 digits'));return;}
        setLoading(true);setError('');
        try{await login(joinCode.trim(),displayName.trim(),pin);}
        catch(err){setError(err.message);}
        setLoading(false);
      };

      return<div className="min-h-screen bg-slate-950 text-white flex items-center justify-center p-4">
        <StarBackground/>
        <div className="max-w-sm w-full relative z-10 animate-fadeIn">
          <div className="flex justify-end mb-2"><LangSelector/></div>
          <div className="text-center mb-8">
            <h1 className="text-4xl font-display font-bold gold-gradient mb-2">INDEPENDENCE</h1>
            <p className="text-blue-300/80 text-sm tracking-widest">SCHOOL EDITION</p>
          </div>
          <form onSubmit={handleSubmit} className="bg-slate-800/50 border border-blue-500/30 rounded-2xl p-6 space-y-4">
            <div>
              <label className="text-sm text-gray-400 block mb-1">{t('classCode','Class Code')}</label>
              <input type="text" value={joinCode} onChange={e=>setJoinCode(e.target.value.toUpperCase())} placeholder="MARS-7X2K" maxLength={10} className="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-lg text-white text-center text-xl tracking-widest uppercase focus:border-blue-500 focus:outline-none"/>
            </div>
            <div>
              <label className="text-sm text-gray-400 block mb-1">{t('yourName','Your Name')}</label>
              <input type="text" value={displayName} onChange={e=>setDisplayName(e.target.value)} placeholder="Alex" maxLength={20} className="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-lg text-white focus:border-blue-500 focus:outline-none"/>
            </div>
            <div>
              <label className="text-sm text-gray-400 block mb-1">{t('pin','PIN')} ({t('pinDigits','4 digits')})</label>
              <input type="password" value={pin} onChange={e=>setPin(e.target.value.replace(/\D/g,'').slice(0,4))} placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxLength={4} className="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-lg text-white text-center text-2xl tracking-widest focus:border-blue-500 focus:outline-none"/>
            </div>
            {error&&<p className="text-red-400 text-sm text-center">{error}</p>}
            <button type="submit" disabled={loading} className="w-full py-4 bg-gradient-to-r from-blue-600 to-blue-500 text-white rounded-xl font-bold text-lg disabled:opacity-50">
              {loading?t('loading','Loading...'):t('join','Join')} üöÄ
            </button>
          </form>
          <p className="text-center text-gray-500 text-xs mt-6">{t('askTeacher','Ask your teacher for the class code')}</p>
        </div>
      </div>;
    }

    // Main Game
    function Game(){
      const{student,classroom,session,scenario,logout,refreshSession}=useContext(StudentContext);
      const{T,SYSTEMS,PLANETS,EVENTS}=useContext(ContentContext);
      const{lang,t}=useContext(LangContext);

      // Scenario settings
      const maxTurns=scenario?.max_turns||12;
      const targetHappiness=scenario?.target_happiness||60;
      const targetWealth=scenario?.target_wealth||60;
      const targetStability=scenario?.target_stability||60;
      const reflectionQuestions=scenario?.reflection_questions||[];

      // Filter systems
      const availableSystems=useMemo(()=>{
        if(!scenario||!scenario.allowed_systems||!scenario.allowed_systems.length)return SYSTEMS;
        const filtered={};
        scenario.allowed_systems.forEach(id=>{if(SYSTEMS[id])filtered[id]=SYSTEMS[id];});
        return Object.keys(filtered).length>0?filtered:SYSTEMS;
      },[scenario,SYSTEMS]);

      // Game state
      const[phase,setPhase]=useState('lobby');
      const[turn,setTurn]=useState(1);
      const[stats,setStats]=useState({happiness:60,wealth:50,stability:70});
      const[hydrobite,setHydrobite]=useState(100);
      const[budget,setBudget]=useState({defence:20,education:20,health:20,infra:20,welfare:20});
      const[system,setSystem]=useState('parliamentary');
      const[planetId,setPlanetId]=useState('terranova');
      const[event,setEvent]=useState(null);
      const[usedEvents,setUsedEvents]=useState([]);
      const[finalScore,setFinalScore]=useState(0);
      const[decisionsLog,setDecisionsLog]=useState([]);
      const[reflectionAnswers,setReflectionAnswers]=useState({});
      const[classLeaderboard,setClassLeaderboard]=useState([]);

      useEffect(()=>{
        const available=Object.keys(availableSystems);
        if(available.length>0&&!availableSystems[system])setSystem(available[0]);
      },[availableSystems]);

      const sys=SYSTEMS[system]||Object.values(SYSTEMS)[0];
      const planet=PLANETS[planetId]||Object.values(PLANETS)[0];

      // Budget items with icons and what they affect
      const budgetItems=[
        {id:'defence',icon:'üõ°Ô∏è',stat:'‚öñÔ∏è'},
        {id:'education',icon:'üìö',stat:'üí∞'},
        {id:'health',icon:'üè•',stat:'üòä'},
        {id:'infra',icon:'üèóÔ∏è',stat:'üí∞'},
        {id:'welfare',icon:'ü§ù',stat:'üòä'}
      ];

      // Load leaderboard
      useEffect(()=>{
        if(!session)return;
        supabase.from('student_results').select('student_id,final_score,is_victory,students(display_name)').eq('session_id',session.id).order('final_score',{ascending:false}).limit(10).then(({data})=>{if(data)setClassLeaderboard(data);});
      },[session,phase]);

      useEffect(()=>{if(phase==='lobby')refreshSession();},[phase]);

      const startGame=()=>{
        const p=PLANETS[planetId];
        setStats({happiness:p?.stats?.happiness||60,wealth:p?.stats?.wealth||50,stability:p?.stats?.stability||70});
        setHydrobite(100);setTurn(1);setUsedEvents([]);setDecisionsLog([]);setPhase('playing');
      };

      const calculateScore=(s,h,t)=>Math.round((s.happiness+s.wealth+s.stability)*10+h+t*50);

      const endGame=async(isVictory,vType,finalStats)=>{
        const score=calculateScore(finalStats,hydrobite,turn);
        setFinalScore(score);
        setPhase(isVictory?'victory':'gameover');
        if(student&&session){
          await supabase.from('student_results').insert({
            student_id:student.id,session_id:session.id,political_system:system,planet_id:planetId,
            final_turn:turn,final_score:score,is_victory:isVictory,victory_type:vType,
            final_happiness:Math.round(finalStats.happiness),final_wealth:Math.round(finalStats.wealth),final_stability:Math.round(finalStats.stability),
            decisions_log:decisionsLog,completed_at:new Date().toISOString()
          });
        }
      };

      const checkGameEnd=(newStats,currentTurn)=>{
        if(newStats.happiness<=0||newStats.wealth<=0||newStats.stability<=0){
          endGame(false,newStats.happiness<=0?'happiness':newStats.wealth<=0?'wealth':'stability',newStats);return true;
        }
        if(currentTurn>maxTurns){
          if(newStats.happiness>=targetHappiness&&newStats.wealth>=targetWealth&&newStats.stability>=targetStability)endGame(true,'utopia',newStats);
          else if(newStats.happiness>=50&&newStats.wealth>=50&&newStats.stability>=50)endGame(true,'survival',newStats);
          else endGame(true,'struggle',newStats);
          return true;
        }
        return false;
      };

      const triggerEvent=()=>{
        const available=EVENTS.filter(e=>(e.system==='general'||e.system===system)&&!usedEvents.includes(e.id));
        if(!available.length)return false;
        const ev=available[Math.floor(Math.random()*available.length)];
        setEvent(ev);setUsedEvents(prev=>[...prev,ev.id]);setPhase('event');
        return true;
      };

      const applyBudgetEffects=()=>{
        const hMod=planet?.mods?.happiness||1;
        const wMod=planet?.mods?.wealth||1;
        const sMod=planet?.mods?.stability||1;
        const stabBonus=sys?.traits?.stabilityBonus||0;
        setStats(prev=>({
          happiness:Math.min(100,Math.max(0,(prev.happiness||60)+(budget.welfare-15)*0.3*hMod+(budget.health-15)*0.2*hMod)),
          wealth:Math.min(100,Math.max(0,(prev.wealth||50)+(budget.infra-15)*0.3*wMod+(budget.education-10)*0.15*wMod)),
          stability:Math.min(100,Math.max(0,(prev.stability||70)+(budget.defence-15)*0.2*sMod+stabBonus*0.1))
        }));
      };

      const nextTurn=()=>{
        applyBudgetEffects();
        const totalBudget=Object.values(budget).reduce((a,b)=>a+(b||0),0);
        setHydrobite(h=>Math.max(0,(h||100)+20-totalBudget*0.3));
        if(!triggerEvent()){const newTurn=turn+1;if(!checkGameEnd(stats,newTurn))setTurn(newTurn);}
      };

      const handleChoice=(choice)=>{
        setDecisionsLog(prev=>[...prev,{
          turn,eventId:event?.id,eventTitle:event?.title?.[lang]||event?.title?.en||'Event',
          eventIcon:event?.icon||'‚ùì',choice:choice.text?.[lang]||choice.text?.en,effects:choice.effects||{}
        }]);
        const effects=choice.effects||{};
        const newStats={
          happiness:Math.min(100,Math.max(0,(stats.happiness||60)+(effects.happiness||0))),
          wealth:Math.min(100,Math.max(0,(stats.wealth||50)+(effects.wealth||0))),
          stability:Math.min(100,Math.max(0,(stats.stability||70)+(effects.stability||0)))
        };
        setStats(newStats);
        setHydrobite(h=>Math.max(0,(h||100)-(choice.cost||0)+(choice.hydro||0)));
        const newTurn=turn+1;
        if(!checkGameEnd(newStats,newTurn)){setTurn(newTurn);setEvent(null);setPhase('playing');}
      };

      // Generate summary
      const generateSummary=useCallback(()=>{
        const sysName=SYSTEMS[system]?.name?.[lang]||SYSTEMS[system]?.name?.en||system;
        const planetName=PLANETS[planetId]?.name?.[lang]||PLANETS[planetId]?.name?.en||planetId;
        const isVictory=phase==='victory';
        
        let summary=`${sysName} (${planetName}) `;
        
        if(isVictory){
          summary+=`${t('summaryGovSuccess','successfully governed for')} ${turn} ${t('summaryYears','years')}. `;
        }else{
          const reasons={
            happiness:t('summaryUnhappiness','citizen unhappiness'),
            wealth:t('summaryEconomic','economic collapse'),
            stability:t('summaryInstability','political instability')
          };
          const failReason=stats.happiness<=0?reasons.happiness:stats.wealth<=0?reasons.wealth:reasons.stability;
          summary+=`${t('summaryGovCollapse','collapsed after')} ${turn} ${t('summaryYears','years')} ${t('summaryDueTo','due to')} ${failReason}. `;
        }
        
        const budgetLabels={
          defence:t('budgetDefence','defence'),
          education:t('budgetEducation','education'),
          health:t('budgetHealth','health'),
          infra:t('budgetInfra','infrastructure'),
          welfare:t('budgetWelfare','welfare')
        };
        const topPriority=Object.entries(budget).sort((a,b)=>b[1]-a[1])[0];
        summary+=`${t('summaryPrioritized','Your government prioritized')} ${budgetLabels[topPriority[0]]||topPriority[0]} ${t('summarySpending','spending')}. `;
        
        if(decisionsLog.length>0){
          summary+=`\n\n${t('summaryKeyMoments','Key moments')}:\n`;
          decisionsLog.slice(0,5).forEach(d=>{
            const effectText=Object.entries(d.effects||{}).map(([k,v])=>`${k} ${v>=0?'+':''}${v}`).join(', ');
            summary+=`‚Ä¢ ${t('year','Year')} ${d.turn}: ${d.eventIcon} ${d.eventTitle} ‚Äî ${t('summaryYouChose','You chose')}: "${d.choice}"${effectText?' ('+effectText+')':''}\n`;
          });
          if(decisionsLog.length>5)summary+=`...${decisionsLog.length-5} ${t('summaryMoreDecisions','more decisions')}.\n`;
        }
        
        summary+='\n';
        if(isVictory){
          if(stats.happiness>=80&&stats.wealth>=80&&stats.stability>=80)summary+='üåü '+t('summaryOutstanding','Outstanding! Near-perfect balance.');
          else if(stats.happiness>=targetHappiness&&stats.wealth>=targetWealth&&stats.stability>=targetStability)summary+='‚úÖ '+t('summaryWellDone','Well done! All goals met.');
          else summary+='‚ö†Ô∏è '+t('summarySurvived','You survived, but room to improve.');
        }else{
          summary+='üí° '+t('summaryConsider','Consider: What might have prevented this?');
        }
        return summary;
      },[system,planetId,turn,stats,budget,decisionsLog,phase,SYSTEMS,PLANETS,targetHappiness,targetWealth,targetStability,lang,t]);

      const submitReflection=async()=>{
        if(student&&session){
          await supabase.from('student_results').update({reflection_answers:reflectionAnswers}).eq('student_id',student.id).eq('session_id',session.id);
        }
        setPhase('lobby');
      };

      // LOBBY
      if(phase==='lobby'){
        return<div className="min-h-screen bg-slate-950 text-white p-4"><StarBackground/>
          <div className="max-w-md mx-auto pt-4 relative z-10">
            <div className="flex justify-between items-center mb-4">
              <div><p className="text-blue-300 font-bold">{student?.display_name}</p><p className="text-gray-500 text-sm">{classroom?.name}</p></div>
              <div className="flex items-center gap-3">
                <LangSelector/>
                <button onClick={logout} className="text-gray-400 hover:text-white text-sm">{t('logout','Logout')}</button>
              </div>
            </div>

            {scenario&&<div className="bg-blue-900/30 border border-blue-500/50 rounded-xl p-4 mb-4">
              <h3 className="font-bold text-blue-300">{scenario.title?.[lang]||scenario.title?.en||'Scenario'}</h3>
              <p className="text-sm text-gray-400 mt-1">{scenario.description?.[lang]||scenario.description?.en}</p>
              <div className="flex gap-4 mt-2 text-xs text-gray-500">
                <span>‚è±Ô∏è {scenario.duration_minutes} min</span>
                <span>üîÑ {maxTurns} {t('summaryYears','turns')}</span>
              </div>
            </div>}

            {!session&&<div className="bg-yellow-900/30 border border-yellow-500/50 rounded-xl p-4 mb-4 text-center">
              <p className="text-yellow-400">‚è≥ {t('waiting','Waiting for teacher to start session...')}</p>
              <button onClick={refreshSession} className="mt-2 text-sm text-blue-400 underline">{t('refresh','Refresh')}</button>
            </div>}

            <div className="text-center mb-4">
              <h1 className="text-3xl font-display font-bold gold-gradient mb-2">INDEPENDENCE</h1>
              <p className="text-gray-400 text-sm">{t('subtitle','Lead a colony to prosperity through your political decisions')}</p>
            </div>

            {/* How to Play */}
            <details className="bg-slate-800/30 border border-slate-700 rounded-xl p-4 mb-4">
              <summary className="text-blue-300 font-bold cursor-pointer">{t('howToPlayTitle','üìñ How to Play')}</summary>
              <div className="mt-3 text-sm text-gray-400 space-y-2">
                <p><strong className="text-white">üéØ</strong> {t('howToPlayGoal','Keep your colony stable while maintaining Happiness, Wealth, and Stability above target levels.')}</p>
                <p><strong className="text-white">üèõÔ∏è</strong> {t('howToPlaySystem','Each political system has unique traits. Democracies are stable but slow; dictatorships are efficient but risky.')}</p>
                <p><strong className="text-white">üí∞</strong> {t('howToPlayBudget','Allocate resources each year. Welfare & Health ‚Üí Happiness. Infrastructure & Education ‚Üí Wealth. Defence ‚Üí Stability.')}</p>
                <p><strong className="text-white">‚ö°</strong> {t('howToPlayEvents','Random crises will test your leadership. Your choices have consequences!')}</p>
                <p><strong className="text-white">üíÄ</strong> {t('howToPlayDefeat','If any stat drops to 0%, your government collapses.')}</p>
              </div>
            </details>

            {/* System Selection */}
            <div className="mb-4">
              <label className="text-sm text-gray-400 block mb-2">üèõÔ∏è {t('politicalSystem','Political System')} {scenario&&<span className="text-blue-400">({Object.keys(availableSystems).length} {t('available','available')})</span>}</label>
              <div className="grid grid-cols-2 gap-2">
                {Object.entries(availableSystems).map(([id,s])=><button key={id} onClick={()=>setSystem(id)} className={`p-3 rounded-lg border text-left transition ${system===id?'border-blue-500 bg-blue-500/20':'border-slate-600 hover:border-slate-500'}`}>
                  <span className="text-2xl">{s.icon}</span>
                  <p className="text-sm text-white mt-1">{s.name?.[lang]||s.name?.en||id}</p>
                  <p className="text-xs text-gray-500">{s.traits?.stabilityBonus>0?t('systemStable','Stable'):t('systemFlexible','Flexible')} ‚Ä¢ {s.is_premium?t('systemAdvanced','Advanced'):t('systemBasic','Basic')}</p>
                </button>)}
              </div>
              {availableSystems[system]&&<div className="mt-2 p-3 bg-slate-800/50 rounded-lg border border-slate-700">
                <p className="text-sm text-gray-300">{availableSystems[system]?.description?.[lang]||availableSystems[system]?.description?.en||t('defaultSystemDesc','Choose your political system wisely. Each has unique strengths and challenges.')}</p>
              </div>}
            </div>

            {/* Planet Selection */}
            <div className="mb-4">
              <label className="text-sm text-gray-400 block mb-2">üåç {t('planet','Planet')}</label>
              <div className="grid grid-cols-5 gap-2">
                {Object.entries(PLANETS).map(([id,p])=><button key={id} onClick={()=>setPlanetId(id)} className={`p-2 rounded-lg border text-center ${planetId===id?'border-blue-500 bg-blue-500/20':'border-slate-600'}`} title={p.name?.[lang]||p.name?.en||id}>
                  <span className="text-2xl">{p.icon}</span>
                </button>)}
              </div>
              {PLANETS[planetId]&&<div className="mt-2 p-3 bg-slate-800/50 rounded-lg border border-slate-700">
                <div className="flex justify-between items-center mb-1">
                  <span className="text-white font-bold">{PLANETS[planetId]?.name?.[lang]||PLANETS[planetId]?.name?.en||planetId}</span>
                  <span className="text-xs text-gray-500">{t('difficulty','Difficulty')}: {'‚≠ê'.repeat(PLANETS[planetId]?.difficulty||1)}</span>
                </div>
                <p className="text-xs text-gray-400">{PLANETS[planetId]?.description?.[lang]||PLANETS[planetId]?.description?.en||t('defaultPlanetDesc','A new world awaits your leadership.')}</p>
                <div className="flex gap-2 mt-2 text-xs">
                  <span className="text-green-400">üòä{PLANETS[planetId]?.stats?.happiness||60}%</span>
                  <span className="text-yellow-400">üí∞{PLANETS[planetId]?.stats?.wealth||50}%</span>
                  <span className="text-blue-400">‚öñÔ∏è{PLANETS[planetId]?.stats?.stability||70}%</span>
                </div>
              </div>}
            </div>

            <button onClick={startGame} disabled={!session} className="w-full py-4 bg-gradient-to-r from-blue-600 to-blue-500 text-white rounded-xl font-bold text-lg disabled:opacity-50 disabled:cursor-not-allowed">
              üöÄ {t('play','Play')}
            </button>

            {classLeaderboard.length>0&&<div className="mt-6 bg-slate-800/50 rounded-xl p-4 border border-blue-500/20">
              <h3 className="text-blue-300 font-bold mb-3">üèÜ {t('leaderboard','Class Leaderboard')}</h3>
              <div className="space-y-2">
                {classLeaderboard.slice(0,5).map((r,i)=><div key={i} className="flex justify-between text-sm">
                  <span className="text-gray-300">{i+1}. {r.students?.display_name}</span>
                  <span className={r.is_victory?'text-green-400':'text-gray-500'}>{r.final_score}</span>
                </div>)}
              </div>
            </div>}
          </div>
        </div>;
      }

      // PLAYING
      if(phase==='playing'){
        const totalBudget=Object.values(budget).reduce((a,b)=>a+b,0);
        return<div className="min-h-screen bg-slate-950 text-white p-4"><StarBackground/>
          <div className="max-w-md mx-auto relative z-10">
            <div className="flex justify-between items-center mb-4">
              <div className="flex items-center gap-2">
                <span className="text-2xl">{sys.icon}</span>
                <span className="text-blue-300 font-bold">{sys.name?.[lang]||sys.name?.en||system}</span>
              </div>
              <div className="text-right">
                <span className="text-blue-400 font-display">{t('year','Year')} {turn}/{maxTurns}</span>
                <p className="text-xs text-gray-500">{PLANETS[planetId]?.name?.[lang]||planetId}</p>
              </div>
            </div>

            {/* Stats */}
            <div className="bg-slate-800/50 rounded-xl p-4 border border-blue-500/20 mb-4">
              <div className="mb-2">
                <div className="flex justify-between text-xs mb-1"><span>üòä {t('happiness','Happiness')}</span><span className={`font-bold ${stats.happiness>=targetHappiness?'text-green-400':'text-white'}`}>{Math.round(stats.happiness)}%</span></div>
                <div className="h-2 bg-slate-900 rounded overflow-hidden relative">
                  <div className="h-full bg-green-500" style={{width:`${stats.happiness}%`}}/>
                  <div className="absolute top-0 h-full w-0.5 bg-yellow-400" style={{left:`${targetHappiness}%`}}/>
                </div>
              </div>
              <div className="mb-2">
                <div className="flex justify-between text-xs mb-1"><span>üí∞ {t('wealth','Wealth')}</span><span className={`font-bold ${stats.wealth>=targetWealth?'text-green-400':'text-white'}`}>{Math.round(stats.wealth)}%</span></div>
                <div className="h-2 bg-slate-900 rounded overflow-hidden relative">
                  <div className="h-full bg-yellow-500" style={{width:`${stats.wealth}%`}}/>
                  <div className="absolute top-0 h-full w-0.5 bg-yellow-400" style={{left:`${targetWealth}%`}}/>
                </div>
              </div>
              <div>
                <div className="flex justify-between text-xs mb-1"><span>‚öñÔ∏è {t('stability','Stability')}</span><span className={`font-bold ${stats.stability>=targetStability?'text-green-400':'text-white'}`}>{Math.round(stats.stability)}%</span></div>
                <div className="h-2 bg-slate-900 rounded overflow-hidden relative">
                  <div className="h-full bg-blue-500" style={{width:`${stats.stability}%`}}/>
                  <div className="absolute top-0 h-full w-0.5 bg-yellow-400" style={{left:`${targetStability}%`}}/>
                </div>
              </div>
            </div>

            {/* Budget */}
            <div className="bg-slate-800/50 rounded-xl p-4 border border-blue-500/20 mb-4">
              <div className="flex justify-between mb-2">
                <span className="text-gray-400">{t('budgetTitle','Budget')} <span className={`font-bold ${totalBudget>100?'text-red-400':'text-white'}`}>({totalBudget}%/100%)</span></span>
                <span className="text-blue-400 font-bold">üíé {Math.round(hydrobite)}</span>
              </div>
              <p className="text-xs text-gray-500 mb-3">{t('budgetHint','Allocate your resources wisely. Higher spending costs more Hydrobite.')}</p>
              {budgetItems.map(({id,icon,stat})=>{
                const others=Object.entries(budget).filter(([k])=>k!==id).reduce((sum,[,v])=>sum+(v||0),0);
                const maxForThis=Math.min(50,100-others);
                const label=t('budget'+id.charAt(0).toUpperCase()+id.slice(1),id);
                return<div key={id} className="mb-2">
                  <div className="flex justify-between text-xs mb-1">
                    <span>{icon} {label} <span className="text-gray-600">‚Üí {stat}</span></span>
                    <span>{budget[id]}%</span>
                  </div>
                  <input type="range" min="0" max={maxForThis} value={Math.min(budget[id],maxForThis)} onChange={e=>setBudget(prev=>({...prev,[id]:Math.min(parseInt(e.target.value)||0,maxForThis)}))} className="w-full bg-slate-700"/>
                </div>;
              })}
            </div>

            <button onClick={nextTurn} disabled={totalBudget>100} className="w-full py-4 bg-gradient-to-r from-blue-600 to-blue-500 text-white rounded-xl font-bold disabled:opacity-50 disabled:cursor-not-allowed">
              {totalBudget>100?t('budgetExceeds','Budget exceeds 100%'):t('next','Next')+' ‚Üí'}
            </button>
          </div>
        </div>;
      }

      // EVENT
      if(phase==='event'&&event){
        return<div className="min-h-screen bg-slate-950 text-white p-4 flex items-center justify-center"><StarBackground/>
          <div className="max-w-md w-full relative z-10 animate-slideUp">
            <div className="bg-slate-800 rounded-2xl border border-blue-500/30 overflow-hidden">
              <div className="bg-gradient-to-r from-blue-900/50 to-slate-800 p-6 text-center">
                <span className="text-5xl block mb-2">{event.icon}</span>
                <h2 className="text-xl font-display font-bold text-blue-400">{event.title?.[lang]||event.title?.en}</h2>
              </div>
              <div className="p-6">
                <p className="text-gray-300 text-center mb-6">{event.desc?.[lang]||event.desc?.en}</p>
                <div className="space-y-3">
                  {event.choices?.map((choice,i)=><button key={i} onClick={()=>handleChoice(choice)} className="w-full p-4 bg-slate-700/50 hover:bg-slate-600/50 border border-slate-600 hover:border-blue-500/50 rounded-xl text-left transition">
                    <div className="font-bold text-blue-200">{choice.text?.[lang]||choice.text?.en}</div>
                    <div className="flex gap-2 mt-2 text-xs">
                      {Object.entries(choice.effects||{}).map(([k,v])=><span key={k} className={v>=0?'text-green-400':'text-red-400'}>{k==='happiness'?'üòä':k==='wealth'?'üí∞':'‚öñÔ∏è'}{v>=0?'+':''}{v}</span>)}
                      {choice.cost>0&&<span className="text-blue-400">-{choice.cost}üíé</span>}
                    </div>
                  </button>)}
                </div>
              </div>
            </div>
          </div>
        </div>;
      }

      // VICTORY / GAMEOVER
      if(phase==='victory'||phase==='gameover'){
        const isVictory=phase==='victory';
        const summary=generateSummary();
        return<div className="min-h-screen bg-slate-950 text-white p-4 flex items-center justify-center"><StarBackground/>
          <div className="max-w-md w-full relative z-10 animate-slideUp">
            <div className={`bg-gradient-to-b ${isVictory?'from-blue-900/50':'from-red-900/50'} to-slate-800 rounded-2xl border ${isVictory?'border-blue-500/50':'border-red-500/50'} p-6`}>
              <div className="text-center">
                <span className="text-5xl block mb-2">{isVictory?'üèÜ':'üíÄ'}</span>
                <h1 className={`text-2xl font-display font-bold ${isVictory?'gold-gradient':'text-red-400'} mb-2`}>{isVictory?t('victory','Victory!'):t('defeat','Defeat')}</h1>
                <div className="inline-block bg-slate-800/50 rounded-xl px-6 py-3 mb-4">
                  <div className="text-3xl font-bold text-blue-400">{finalScore}</div>
                  <p className="text-gray-400 text-sm">{t('score','Score')}</p>
                </div>
              </div>
              <div className="grid grid-cols-3 gap-3 mb-4">
                <div className="text-center bg-slate-800/30 rounded-lg p-2"><span className="text-xl">üòä</span><p className={`font-bold text-sm ${stats.happiness>=targetHappiness?'text-green-400':'text-red-400'}`}>{Math.round(stats.happiness)}%</p></div>
                <div className="text-center bg-slate-800/30 rounded-lg p-2"><span className="text-xl">üí∞</span><p className={`font-bold text-sm ${stats.wealth>=targetWealth?'text-green-400':'text-red-400'}`}>{Math.round(stats.wealth)}%</p></div>
                <div className="text-center bg-slate-800/30 rounded-lg p-2"><span className="text-xl">‚öñÔ∏è</span><p className={`font-bold text-sm ${stats.stability>=targetStability?'text-green-400':'text-red-400'}`}>{Math.round(stats.stability)}%</p></div>
              </div>
              <div className="bg-slate-900/50 rounded-xl p-4 mb-4 max-h-48 overflow-y-auto">
                <h3 className="text-blue-300 font-bold text-sm mb-2">üìú {t('yourStory','Your Story')}</h3>
                <p className="text-gray-300 text-sm whitespace-pre-line">{summary}</p>
              </div>
              <button onClick={()=>setPhase('reflection')} className={`w-full py-3 bg-gradient-to-r ${isVictory?'from-blue-600 to-blue-500':'from-red-600 to-red-500'} text-white rounded-xl font-bold`}>
                üìù {t('reflection','Reflection')} ‚Üí
              </button>
            </div>
          </div>
        </div>;
      }

      // REFLECTION
      if(phase==='reflection'){
        const defaultQs=[
          {en:t('reflectionQ1','Why did you choose this political system?'),ru:t('reflectionQ1')},
          {en:t('reflectionQ2','What would you do differently next time?'),ru:t('reflectionQ2')},
          {en:t('reflectionQ3','What did you learn about governing?'),ru:t('reflectionQ3')}
        ];
        const questions=reflectionQuestions.length?reflectionQuestions:defaultQs;
        return<div className="min-h-screen bg-slate-950 text-white p-4"><StarBackground/>
          <div className="max-w-md mx-auto pt-8 relative z-10">
            <h2 className="text-2xl font-display font-bold text-blue-400 mb-6 text-center">üìù {t('reflection','Reflection')}</h2>
            <div className="space-y-4">
              {questions.map((q,i)=><div key={i} className="bg-slate-800/50 rounded-xl p-4 border border-blue-500/20">
                <p className="text-gray-300 mb-2">{q[lang]||q.en||q}</p>
                <textarea value={reflectionAnswers[`q${i+1}`]||''} onChange={e=>setReflectionAnswers(prev=>({...prev,[`q${i+1}`]:e.target.value}))} rows={3} className="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:border-blue-500 focus:outline-none" placeholder={t('reflectionPlaceholder','Your answer...')}/>
              </div>)}
            </div>
            <div className="flex gap-3 mt-6">
              <button onClick={()=>setPhase('lobby')} className="flex-1 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl">{t('skip','Skip')}</button>
              <button onClick={submitReflection} className="flex-1 py-3 bg-gradient-to-r from-blue-600 to-blue-500 rounded-xl font-bold">{t('submit','Submit')}</button>
            </div>
          </div>
        </div>;
      }

      return null;
    }

    function App(){
      const{student,loading}=useContext(StudentContext);
      if(loading)return<div className="min-h-screen bg-slate-950 flex items-center justify-center"><div className="w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"/></div>;
      return student?<Game/>:<LoginScreen/>;
    }

    function Root(){
      return<ContentProvider><LangProvider><StudentProvider><App/></StudentProvider></LangProvider></ContentProvider>;
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<Root/>);
  </script>
</body>
</html>
