<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Independence - Teacher Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; }
    .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 100; }
  </style>
</head>
<body class="bg-slate-900 text-white min-h-screen">
  <div id="app"></div>
  <div id="modal"></div>

  <script type="module">
    const SUPABASE_URL = 'https://dnkeinsedcrlhwbiycfo.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRua2VpbnNlZGNybGh3Yml5Y2ZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NDg0MjgsImV4cCI6MjA4NDMyNDQyOH0.9IkWv6dwOemaVwvWrwq7ZzuebrgWI83JWrdaZbzdhhw';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let state = {
      user: null, teacher: null, school: null, loading: true, activeTab: 'classrooms',
      classrooms: [], selectedClassroom: null, students: [], results: [], sessions: [],
      scenarios: [], showScenarioModal: false
    };

    async function checkAuth() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) { state.loading = false; render(); return; }
      state.user = session.user;
      const { data: teacher } = await supabase.from('teachers').select('*, schools(*)').eq('id', session.user.id).single();
      if (!teacher) { state.loading = false; state.error = 'You are not registered as a teacher.'; render(); return; }
      state.teacher = teacher;
      state.school = teacher.schools;
      state.loading = false;
      await loadClassrooms();
      await loadScenarios();
      render();
    }

    async function signIn(email, password) {
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) throw error;
      await checkAuth();
    }

    async function signOut() { await supabase.auth.signOut(); state.user = null; state.teacher = null; render(); }

    async function loadClassrooms() {
      const { data } = await supabase.from('classrooms').select('*').eq('teacher_id', state.user.id).eq('is_active', true).order('created_at', { ascending: false });
      state.classrooms = data || [];
    }

    async function loadScenarios() {
      const { data } = await supabase.from('scenarios').select('*').eq('is_active', true).order('sort_order');
      state.scenarios = data || [];
    }

    async function createClassroom(name) {
      const words = ['MARS', 'LUNA', 'NOVA', 'STAR', 'TERRA', 'ORION', 'VEGA', 'ATLAS'];
      const code = words[Math.floor(Math.random() * words.length)] + '-' + Math.random().toString(36).substring(2, 6).toUpperCase();
      const { error } = await supabase.from('classrooms').insert({ school_id: state.school.id, teacher_id: state.user.id, name, join_code: code });
      if (error) { alert('Error: ' + error.message); return; }
      await loadClassrooms(); render();
    }

    async function deleteClassroom(id) {
      if (!confirm('Delete this classroom?')) return;
      await supabase.from('classrooms').update({ is_active: false }).eq('id', id);
      await loadClassrooms();
      if (state.selectedClassroom?.id === id) state.selectedClassroom = null;
      render();
    }

    async function selectClassroom(classroom) {
      state.selectedClassroom = classroom;
      state.activeTab = 'students';
      await loadStudents(classroom.id);
      await loadSessions(classroom.id);
      render();
    }

    async function loadStudents(classroomId) {
      const { data } = await supabase.from('students').select('*').eq('classroom_id', classroomId).eq('is_active', true).order('display_name');
      state.students = data || [];
    }

    async function loadSessions(classroomId) {
      const { data } = await supabase.from('classroom_sessions').select('*, scenarios(*)').eq('classroom_id', classroomId).order('started_at', { ascending: false });
      state.sessions = data || [];
    }

    async function loadResults(sessionId) {
      const { data } = await supabase.from('student_results').select('*, students(display_name)').eq('session_id', sessionId).order('final_score', { ascending: false });
      state.results = data || [];
      render();
    }

    async function startSession(classroomId, scenarioId) {
      await supabase.from('classroom_sessions').update({ status: 'completed', ended_at: new Date().toISOString() }).eq('classroom_id', classroomId).eq('status', 'active');
      const { error } = await supabase.from('classroom_sessions').insert({ classroom_id: classroomId, scenario_id: scenarioId || null, status: 'active' });
      if (error) { alert('Error: ' + error.message); return; }
      state.showScenarioModal = false;
      await loadSessions(classroomId);
      render();
    }

    async function endSession(sessionId) {
      await supabase.from('classroom_sessions').update({ status: 'completed', ended_at: new Date().toISOString() }).eq('id', sessionId);
      await loadSessions(state.selectedClassroom.id);
      render();
    }

    function render() {
      const app = document.getElementById('app');
      const modal = document.getElementById('modal');
      
      if (state.loading) { app.innerHTML = `<div class="flex items-center justify-center min-h-screen"><div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div></div>`; return; }
      if (state.error) { app.innerHTML = `<div class="flex items-center justify-center min-h-screen"><div class="text-center"><p class="text-red-400 text-xl mb-4">âš ï¸ ${state.error}</p><button onclick="location.reload()" class="px-4 py-2 bg-slate-700 rounded">Refresh</button></div></div>`; return; }
      if (!state.user) { app.innerHTML = renderLogin(); attachLoginHandler(); modal.innerHTML = ''; return; }

      app.innerHTML = `<div class="flex h-screen">${renderSidebar()}<div class="flex-1 overflow-auto">${renderHeader()}${renderContent()}</div></div>`;
      modal.innerHTML = state.showScenarioModal ? renderScenarioModal() : '';
    }

    function renderLogin() {
      return `<div class="flex items-center justify-center min-h-screen p-4"><div class="bg-slate-800 p-8 rounded-xl max-w-md w-full"><div class="text-center mb-6"><h1 class="text-2xl font-bold text-blue-400 mb-2">ğŸ“ Teacher Dashboard</h1><p class="text-gray-400">Independence - School Edition</p></div><form id="loginForm" class="space-y-4"><div><label class="block text-sm text-gray-400 mb-1">Email</label><input type="email" id="email" required class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-lg focus:border-blue-500 focus:outline-none"></div><div><label class="block text-sm text-gray-400 mb-1">Password</label><input type="password" id="password" required class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-lg focus:border-blue-500 focus:outline-none"></div><button type="submit" class="w-full py-3 bg-blue-600 hover:bg-blue-500 rounded-lg font-bold">Sign In</button></form></div></div>`;
    }

    function renderScenarioModal() {
      const ks3 = state.scenarios.filter(s => s.curriculum_topic?.includes('KS3'));
      const ks4 = state.scenarios.filter(s => s.curriculum_topic?.includes('KS4'));
      
      return `<div class="modal-bg" onclick="closeScenarioModal(event)"><div class="bg-slate-800 rounded-xl max-w-2xl w-full max-h-[90vh] overflow-auto m-4" onclick="event.stopPropagation()"><div class="p-6 border-b border-slate-700 flex justify-between items-center"><h2 class="text-xl font-bold">ğŸ® Start Game Session</h2><button onclick="closeScenarioModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button></div><div class="p-6"><p class="text-gray-400 mb-4">Choose a scenario aligned with UK Citizenship Curriculum:</p>
      <div class="mb-6"><button onclick="handleStartWithScenario(null)" class="w-full p-4 bg-slate-700 hover:bg-slate-600 border border-slate-600 hover:border-blue-500 rounded-xl text-left transition"><div class="flex justify-between items-center"><div><h3 class="font-bold text-blue-300">ğŸ² Free Play</h3><p class="text-sm text-gray-400">Students choose any system and settings</p></div><span class="text-gray-500">No restrictions</span></div></button></div>
      ${ks3.length > 0 ? `<h3 class="text-sm font-bold text-green-400 mb-2">ğŸ“— KEY STAGE 3 (Ages 11-14)</h3><div class="space-y-2 mb-6">${ks3.map(s => renderScenarioCard(s)).join('')}</div>` : ''}
      ${ks4.length > 0 ? `<h3 class="text-sm font-bold text-blue-400 mb-2">ğŸ“˜ KEY STAGE 4 (Ages 14-16)</h3><div class="space-y-2">${ks4.map(s => renderScenarioCard(s)).join('')}</div>` : ''}
      </div></div></div>`;
    }

    function renderScenarioCard(s) {
      const diffColors = { easy: 'text-green-400', normal: 'text-yellow-400', hard: 'text-red-400' };
      return `<button onclick="handleStartWithScenario('${s.id}')" class="w-full p-4 bg-slate-700/50 hover:bg-slate-600/50 border border-slate-600 hover:border-blue-500 rounded-xl text-left transition"><div class="flex justify-between items-start"><div class="flex-1"><h3 class="font-bold text-white">${s.title?.en || s.id}</h3><p class="text-sm text-gray-400 mt-1">${s.description?.en || ''}</p><div class="flex gap-4 mt-2 text-xs"><span class="text-gray-500">â±ï¸ ${s.duration_minutes} min</span><span class="text-gray-500">ğŸ”„ ${s.max_turns} turns</span><span class="${diffColors[s.difficulty] || 'text-gray-400'}">${s.difficulty}</span></div></div></div></button>`;
    }

    function renderSidebar() {
      return `<div class="w-64 bg-slate-800 border-r border-slate-700 flex flex-col"><div class="p-4 border-b border-slate-700"><h1 class="text-xl font-bold text-blue-400">ğŸ“ Teacher</h1><p class="text-sm text-gray-400">${state.school?.name || 'School'}</p></div><nav class="flex-1 p-2"><button onclick="switchTab('classrooms')" class="w-full text-left px-4 py-3 rounded-lg mb-1 flex items-center gap-3 ${state.activeTab === 'classrooms' ? 'bg-blue-600/20 text-blue-400' : 'hover:bg-slate-700 text-gray-300'}"><span>ğŸ“š</span> My Classrooms</button>${state.selectedClassroom ? `<div class="mt-4 pt-4 border-t border-slate-700"><p class="text-xs text-gray-500 px-4 mb-2">SELECTED CLASS</p><p class="text-blue-300 px-4 font-bold">${state.selectedClassroom.name}</p><p class="text-xs text-gray-500 px-4 mb-3">Code: ${state.selectedClassroom.join_code}</p><button onclick="switchTab('students')" class="w-full text-left px-4 py-2 rounded-lg mb-1 flex items-center gap-3 ${state.activeTab === 'students' ? 'bg-blue-600/20 text-blue-400' : 'hover:bg-slate-700 text-gray-300'}"><span>ğŸ‘¥</span> Students (${state.students.length})</button><button onclick="switchTab('sessions')" class="w-full text-left px-4 py-2 rounded-lg mb-1 flex items-center gap-3 ${state.activeTab === 'sessions' ? 'bg-blue-600/20 text-blue-400' : 'hover:bg-slate-700 text-gray-300'}"><span>ğŸ®</span> Sessions</button><button onclick="switchTab('results')" class="w-full text-left px-4 py-2 rounded-lg mb-1 flex items-center gap-3 ${state.activeTab === 'results' ? 'bg-blue-600/20 text-blue-400' : 'hover:bg-slate-700 text-gray-300'}"><span>ğŸ“Š</span> Results</button></div>` : ''}</nav><div class="p-4 border-t border-slate-700"><p class="text-sm text-gray-400 mb-2">${state.user?.email}</p><button onclick="handleSignOut()" class="text-sm text-red-400 hover:text-red-300">Sign Out</button></div></div>`;
    }

    function renderHeader() {
      const titles = { classrooms: 'ğŸ“š My Classrooms', students: 'ğŸ‘¥ Students', sessions: 'ğŸ® Game Sessions', results: 'ğŸ“Š Results' };
      return `<div class="p-6 border-b border-slate-700 flex justify-between items-center"><h2 class="text-2xl font-bold">${titles[state.activeTab]}</h2>${state.activeTab === 'classrooms' ? `<button onclick="showCreateClassroom()" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg font-bold">+ New Classroom</button>` : ''}${state.activeTab === 'sessions' && state.selectedClassroom ? `<button onclick="showScenarioModal()" class="px-4 py-2 bg-green-600 hover:bg-green-500 rounded-lg font-bold">â–¶ï¸ Start Session</button>` : ''}</div>`;
    }

    function renderContent() {
      switch(state.activeTab) {
        case 'classrooms': return renderClassrooms();
        case 'students': return renderStudents();
        case 'sessions': return renderSessions();
        case 'results': return renderResults();
        default: return '';
      }
    }

    function renderClassrooms() {
      if (!state.classrooms.length) return `<div class="p-8 text-center text-gray-400"><p class="text-4xl mb-4">ğŸ“š</p><p class="mb-4">No classrooms yet</p><button onclick="showCreateClassroom()" class="px-4 py-2 bg-blue-600 rounded-lg">Create your first classroom</button></div>`;
      return `<div class="p-6 grid gap-4 md:grid-cols-2 lg:grid-cols-3">${state.classrooms.map(c => `<div class="bg-slate-800 rounded-xl p-5 border border-slate-700 hover:border-blue-500/50 cursor-pointer transition" onclick="handleSelectClassroom('${c.id}')"><div class="flex justify-between items-start mb-3"><h3 class="text-lg font-bold text-blue-300">${c.name}</h3><button onclick="event.stopPropagation(); handleDeleteClassroom('${c.id}')" class="text-gray-500 hover:text-red-400">ğŸ—‘ï¸</button></div><div class="bg-slate-900 rounded-lg p-3 mb-3"><p class="text-xs text-gray-500 mb-1">JOIN CODE</p><p class="text-2xl font-mono text-blue-400 tracking-wider">${c.join_code}</p></div><p class="text-xs text-gray-500">Created ${new Date(c.created_at).toLocaleDateString()}</p></div>`).join('')}</div>`;
    }

    function renderStudents() {
      if (!state.selectedClassroom) return '<div class="p-8 text-center text-gray-400">Select a classroom first</div>';
      if (!state.students.length) return `<div class="p-8 text-center text-gray-400"><p class="text-4xl mb-4">ğŸ‘¥</p><p class="mb-2">No students have joined yet</p><p class="text-sm">Share this code:</p><p class="text-3xl font-mono text-blue-400 mt-2">${state.selectedClassroom.join_code}</p></div>`;
      return `<div class="p-6"><div class="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden"><table class="w-full"><thead class="bg-slate-700"><tr><th class="text-left p-4">Student</th><th class="text-left p-4">Joined</th><th class="text-left p-4">Actions</th></tr></thead><tbody>${state.students.map(s => `<tr class="border-t border-slate-700"><td class="p-4"><span class="text-xl mr-2">${s.avatar || 'ğŸ‘¤'}</span>${s.display_name}</td><td class="p-4 text-gray-400">${new Date(s.created_at).toLocaleDateString()}</td><td class="p-4"><button onclick="resetStudentPin('${s.id}')" class="text-sm text-blue-400 hover:text-blue-300">Reset PIN</button></td></tr>`).join('')}</tbody></table></div></div>`;
    }

    function renderSessions() {
      if (!state.selectedClassroom) return '<div class="p-8 text-center text-gray-400">Select a classroom first</div>';
      const active = state.sessions.filter(s => s.status === 'active');
      const past = state.sessions.filter(s => s.status !== 'active');
      return `<div class="p-6 space-y-6">${active.length ? `<div><h3 class="text-lg font-bold text-green-400 mb-3">ğŸŸ¢ Active Session</h3>${active.map(s => `<div class="bg-green-900/30 border border-green-500/50 rounded-xl p-4"><div class="flex justify-between items-start mb-3"><div><p class="font-bold text-lg">${s.scenarios?.title?.en || 'ğŸ² Free Play'}</p><p class="text-sm text-gray-400">Started ${new Date(s.started_at).toLocaleString()}</p>${s.scenarios ? `<p class="text-xs text-blue-400 mt-1">${s.scenarios.curriculum_topic || ''}</p>` : ''}</div><span class="px-3 py-1 bg-green-600/30 text-green-400 rounded-full text-sm">Active</span></div><div class="flex gap-2"><button onclick="handleLoadResults('${s.id}')" class="px-3 py-2 bg-blue-600 rounded-lg text-sm">View Results</button><button onclick="handleEndSession('${s.id}')" class="px-3 py-2 bg-red-600 rounded-lg text-sm">End Session</button></div><p class="text-xs text-gray-500 mt-3">Students join with: <span class="text-blue-400 font-mono">${state.selectedClassroom.join_code}</span></p></div>`).join('')}</div>` : `<div class="bg-slate-800 rounded-xl p-6 text-center border border-slate-700"><p class="text-gray-400 mb-4">No active session</p><button onclick="showScenarioModal()" class="px-6 py-3 bg-green-600 hover:bg-green-500 rounded-lg font-bold">â–¶ï¸ Start Game Session</button></div>`}${past.length ? `<div><h3 class="text-lg font-bold text-gray-400 mb-3">ğŸ“ Past Sessions</h3><div class="space-y-2">${past.map(s => `<div class="bg-slate-800 border border-slate-700 rounded-lg p-4 flex justify-between items-center"><div><p class="font-bold">${s.scenarios?.title?.en || 'ğŸ² Free Play'}</p><p class="text-sm text-gray-500">${new Date(s.started_at).toLocaleDateString()}</p></div><button onclick="handleLoadResults('${s.id}')" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">View Results</button></div>`).join('')}</div></div>` : ''}</div>`;
    }

    function renderResults() {
      if (!state.results.length) return `<div class="p-8 text-center text-gray-400"><p class="text-4xl mb-4">ğŸ“Š</p><p>Select a session to view results</p></div>`;
      return `<div class="p-6"><div class="bg-slate-800 rounded-xl border border-slate-700 overflow-x-auto"><table class="w-full"><thead class="bg-slate-700"><tr><th class="text-left p-4">#</th><th class="text-left p-4">Student</th><th class="text-left p-4">System</th><th class="text-left p-4">Score</th><th class="text-left p-4">Result</th><th class="text-left p-4">Stats</th><th class="text-left p-4">Reflection</th></tr></thead><tbody>${state.results.map((r, i) => `<tr class="border-t border-slate-700"><td class="p-4 text-gray-500">${i + 1}</td><td class="p-4 font-bold">${r.students?.display_name || '?'}</td><td class="p-4">${r.political_system || '-'}</td><td class="p-4 text-blue-400 font-bold">${r.final_score || 0}</td><td class="p-4">${r.is_victory ? '<span class="text-green-400">ğŸ†</span>' : '<span class="text-red-400">ğŸ’€</span>'}</td><td class="p-4 text-sm whitespace-nowrap"><span class="text-green-400">ğŸ˜Š${r.final_happiness || 0}%</span> <span class="text-yellow-400">ğŸ’°${r.final_wealth || 0}%</span> <span class="text-blue-400">âš–ï¸${r.final_stability || 0}%</span></td><td class="p-4">${r.reflection_answers ? `<button onclick="showReflection('${r.id}')" class="text-blue-400 hover:text-blue-300 text-sm">View ğŸ“</button>` : '-'}</td></tr>`).join('')}</tbody></table></div></div>`;
    }

    function attachLoginHandler() {
      document.getElementById('loginForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        try { await signIn(document.getElementById('email').value, document.getElementById('password').value); }
        catch (err) { alert('Login error: ' + err.message); }
      });
    }

    window.switchTab = (tab) => { state.activeTab = tab; if (tab === 'results' && state.sessions.length) loadResults(state.sessions.find(s => s.status === 'active')?.id || state.sessions[0].id); render(); };
    window.showCreateClassroom = () => { const name = prompt('Enter classroom name:'); if (name) createClassroom(name); };
    window.handleSelectClassroom = (id) => { const c = state.classrooms.find(x => x.id === id); if (c) selectClassroom(c); };
    window.handleDeleteClassroom = (id) => deleteClassroom(id);
    window.showScenarioModal = () => { state.showScenarioModal = true; render(); };
    window.closeScenarioModal = (e) => { if (!e || e.target === e.currentTarget) { state.showScenarioModal = false; render(); } };
    window.handleStartWithScenario = (id) => { if (state.selectedClassroom) startSession(state.selectedClassroom.id, id); };
    window.handleEndSession = (id) => { if (confirm('End this session?')) endSession(id); };
    window.handleLoadResults = (id) => { state.activeTab = 'results'; loadResults(id); };
    window.handleSignOut = () => signOut();
    window.showReflection = (id) => { const r = state.results.find(x => x.id === id); if (r?.reflection_answers) alert(`Reflection by ${r.students?.display_name}:\n\n${Object.entries(r.reflection_answers).map(([k,v]) => `${k}: ${v}`).join('\n\n')}`); };
    window.resetStudentPin = async (id) => { const pin = prompt('Enter new 4-digit PIN:'); if (pin?.length === 4 && /^\d+$/.test(pin)) { await supabase.from('students').update({ pin_code: pin }).eq('id', id); alert('PIN updated'); } else alert('PIN must be 4 digits'); };

    checkAuth();
  </script>
</body>
</html>
